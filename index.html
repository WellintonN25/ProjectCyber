<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>WDev Legends - Pro Plus</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f0c29;
            --bg-gradient: linear-gradient(135deg, #0b0b15, #1c1c2e, #0b0b15);
            --primary: #fbbf24;
            --primary-dark: #b45309;
            --accent: #60a5fa;
            --danger: #ef4444;
            --success: #34d399;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            --font-main: 'Fredoka', sans-serif;
            --safe-area-bottom: env(safe-area-inset-bottom, 20px);
        }

        /* RESET & BASE */
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { 
            font-family: var(--font-main); 
            background: var(--bg-dark); 
            color: #f3f4f6; 
            height: 100vh; width: 100vw; 
            overflow: hidden; 
            display: flex; flex-direction: column;
        }

        /* BACKGROUND FX */
        .bg-fx {
            position: fixed; top:0; left:0; width:100%; height:100%; z-index: -1;
            background: var(--bg-gradient); background-size: 200% 200%;
            animation: gradientBG 15s ease infinite;
        }
        @keyframes gradientBG { 0% {background-position: 0% 50%;} 50% {background-position: 100% 50%;} 100% {background-position: 0% 50%;} }

        /* CONTAINERS & SCREENS */
        #app { flex: 1; position: relative; width: 100%; height: 100%; overflow: hidden; }
        
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            padding: 20px; padding-bottom: calc(100px + var(--safe-area-bottom));
            overflow-y: auto; overflow-x: hidden;
            opacity: 0; pointer-events: none; transform: scale(0.98);
            transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; flex-direction: column; align-items: center;
        }
        .screen.active { opacity: 1; pointer-events: all; transform: scale(1); }

        /* UI COMPONENTS */
        .panel {
            background: var(--glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 24px;
            padding: 25px; width: 100%; max-width: 480px; box-shadow: var(--shadow);
            margin-bottom: 20px; text-align: center; position: relative;
        }

        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 14px;
            font-family: var(--font-main); font-weight: 700; font-size: 1rem;
            color: #3f2e12; cursor: pointer; position: relative;
            background: linear-gradient(to bottom, #fcd34d, #f59e0b);
            box-shadow: 0 4px 0 var(--primary-dark), 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.1s; display: flex; align-items: center; justify-content: center; gap: 8px;
            text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px;
        }
        .btn:active { transform: translateY(4px); box-shadow: 0 0 0 var(--primary-dark); }
        .btn:disabled { filter: grayscale(1) opacity(0.5); pointer-events: none; }
        .btn-red { background: linear-gradient(to bottom, #fca5a5, #ef4444); color: white; box-shadow: 0 4px 0 #991b1b; }
        .btn-red:active { box-shadow: 0 0 0 #991b1b; }
        .btn-blue { background: linear-gradient(to bottom, #93c5fd, #3b82f6); color: white; box-shadow: 0 4px 0 #1e40af; }
        .btn-blue:active { box-shadow: 0 0 0 #1e40af; }
        .btn-ghost { background: transparent; box-shadow: none; color: #aaa; border: 1px solid rgba(255,255,255,0.2); }
        .btn-ghost:active { background: rgba(255,255,255,0.05); box-shadow: none; transform: scale(0.98); }

        input {
            width: 100%; padding: 15px; background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.2); border-radius: 12px;
            color: white; font-family: inherit; margin-bottom: 15px;
            font-size: 1.1rem; text-align: center; transition: 0.3s;
        }
        input:focus { border-color: var(--primary); background: rgba(0,0,0,0.6); }

        /* MINECRAFT STYLE INVENTORY */
        .inv-grid {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;
            width: 100%; max-width: 480px; padding: 10px;
            background: rgba(0,0,0,0.3); border-radius: 12px;
            border: 1px solid var(--glass-border);
        }
        .inv-slot {
            aspect-ratio: 1; background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1); border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem; cursor: pointer; position: relative; transition: 0.1s;
        }
        .inv-slot:active { transform: scale(0.95); background: rgba(255,255,255,0.1); }
        .inv-slot.equipped { border-color: var(--primary); background: rgba(251, 191, 36, 0.15); box-shadow: 0 0 10px rgba(251, 191, 36, 0.3); }
        .inv-slot.empty { opacity: 0.3; cursor: default; }
        .inv-qty { position: absolute; bottom: 2px; right: 4px; font-size: 0.7rem; font-weight: bold; color: #fff; text-shadow: 1px 1px 0 #000; }

        /* SHOP GRID */
        .shop-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; max-width: 480px; }
        .shop-card {
            background: linear-gradient(160deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01));
            border: 1px solid var(--glass-border); border-radius: 16px;
            padding: 15px; display: flex; flex-direction: column; align-items: center; text-align: center;
            position: relative; overflow: hidden;
        }
        .shop-card-icon { font-size: 2.5rem; margin-bottom: 5px; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3)); }
        .shop-card-title { font-weight: bold; font-size: 0.9rem; margin-bottom: 2px; }
        .shop-card-desc { font-size: 0.7rem; color: #9ca3af; margin-bottom: 10px; height: 20px; overflow: hidden;}
        .shop-card .btn { width: 100%; padding: 8px; font-size: 0.8rem; margin: 0; box-shadow: none; }

        /* CHAR DASHBOARD */
        .char-dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 480px; }
        .char-stat-box {
            background: rgba(255,255,255,0.03); border-radius: 16px; padding: 15px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .stat-val { font-size: 1.5rem; font-weight: bold; color: #fff; }
        .stat-label { font-size: 0.8rem; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }
        .char-avatar-section {
            grid-column: span 2; display: flex; align-items: center; justify-content: center; gap: 20px;
            padding: 20px; background: rgba(255,255,255,0.03); border-radius: 20px; margin-bottom: 10px;
        }
        .add-btn {
            width: 30px; height: 30px; border-radius: 50%; border: none;
            background: var(--accent); color: white; font-weight: bold;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }

        /* ADVENTURE CARDS */
        .adventure-card {
            width: 100%; max-width: 480px;
            background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
            border: 1px solid var(--glass-border);
            border-radius: 20px; padding: 25px;
            margin-bottom: 15px; cursor: pointer;
            position: relative; overflow: hidden;
            transition: transform 0.2s, border-color 0.2s;
            display: flex; align-items: center; justify-content: space-between;
        }
        .adventure-card:active { transform: scale(0.98); background: rgba(255,255,255,0.08); }
        .adventure-card-content { z-index: 2; text-align: left; }
        .adventure-card h3 { font-size: 1.4rem; margin-bottom: 5px; color: #fff; }
        .adventure-card p { font-size: 0.9rem; color: #9ca3af; margin: 0; }
        .adventure-card-icon { font-size: 2.5rem; z-index: 2; margin-right: 10px; }
        .adventure-card-bg {
            position: absolute; right: -20px; bottom: -20px; font-size: 8rem;
            opacity: 0.05; transform: rotate(-15deg); z-index: 1; pointer-events: none;
        }
        .card-forest { border-left: 5px solid var(--success); }
        .card-dungeon { border-left: 5px solid var(--accent); }

        /* HUD & STATUS */
        .top-hud {
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; max-width: 480px; margin-bottom: 20px;
            background: rgba(0,0,0,0.3); padding: 8px 20px; border-radius: 50px;
            border: 1px solid var(--glass-border); backdrop-filter: blur(10px);
        }

        /* BATTLE SCENE */
        .arena {
            width: 100%; height: 260px; position: relative;
            display: flex; justify-content: space-between; align-items: flex-end;
            padding: 20px; margin-bottom: 10px;
        }
        .fighter { display: flex; flex-direction: column; align-items: center; width: 100px; position: relative; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 5; }
        .fighter-lvl {
            background: rgba(0,0,0,0.6); padding: 2px 8px; border-radius: 10px;
            font-size: 0.7rem; color: var(--primary); font-weight: bold; margin-bottom: -5px; z-index: 10;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .fighter-emoji { 
            font-size: 5.5rem; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.6));
            animation: breathe 3s infinite ease-in-out; z-index: 2; position: relative;
        }
        .fighter-shadow {
            width: 70px; height: 12px; background: rgba(0,0,0,0.4);
            border-radius: 50%; filter: blur(4px); margin-top: -10px; z-index: 1;
        }
        
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03) translateY(-5px); } }
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-6px, 0, 0); } 40%, 60% { transform: translate3d(6px, 0, 0); } }
        
        /* PARTICLES */
        .particle { position: fixed; pointer-events: none; z-index: 999; border-radius: 50%; will-change: transform, opacity; }
        @keyframes particleGravity { 0% { transform: translate(0,0) scale(1); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) scale(0.5); opacity: 0; } }
        @keyframes particleBang { 0% { transform: translate(0,0) scale(1); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; } }

        /* BATTLE LOG - NEW STYLE */
        .battle-log {
            position: absolute; 
            top: 20px; left: 50%; transform: translateX(-50%); /* Centered Top */
            width: 200px;
            display: flex; flex-direction: column; gap: 5px;
            pointer-events: none; z-index: 20;
            align-items: center;
        }
        .log-entry {
            background: rgba(0,0,0,0.6); 
            backdrop-filter: blur(4px);
            border-radius: 20px; padding: 4px 12px;
            text-align: center; font-size: 0.75rem; color: #eee;
            animation: fadeInLog 0.3s ease-out;
            white-space: nowrap;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .log-entry.crit { 
            color: #fff; background: linear-gradient(90deg, #b91c1c, #ef4444);
            border: 1px solid #ffaa00; font-weight: bold; transform: scale(1.1);
        }
        .log-entry.turn-hero { border-left: 4px solid var(--success); }
        .log-entry.turn-enemy { border-left: 4px solid var(--danger); }
        
        @keyframes fadeInLog { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }

        /* BARS */
        .bar-wrap { width: 100%; height: 8px; background: rgba(0,0,0,0.6); border-radius: 10px; overflow: hidden; margin-top: 8px; }
        .bar-fill { height: 100%; transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 10px; }
        .hp-fill { background: linear-gradient(90deg, #ef4444, #b91c1c); box-shadow: 0 0 10px #ef4444; }
        .mp-fill { background: linear-gradient(90deg, #60a5fa, #2563eb); box-shadow: 0 0 10px #60a5fa; }
        .xp-fill { background: linear-gradient(90deg, #34d399, #059669); }

        /* SKILLS */
        .grid-skills { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; }
        .skill-btn {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px; padding: 12px 5px; text-align: center; cursor: pointer;
            transition: 0.2s; position: relative; overflow: hidden;
        }
        .skill-btn:active:not(.disabled) { transform: scale(0.95); background: rgba(255,255,255,0.15); }
        .skill-btn.disabled { opacity: 0.4; filter: grayscale(1); }
        .skill-icon { font-size: 1.8rem; display: block; margin-bottom: 4px; }
        .skill-info { font-size: 0.75rem; color: #9ca3af; font-weight: 600; display: block;}

        /* DUNGEON SPECIFIC */
        .dungeon-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 15px; margin-bottom: 8px; border-radius: 15px;
            background: linear-gradient(90deg, rgba(255,255,255,0.03), transparent);
            border-left: 4px solid #555; transition: 0.2s;
        }
        .dungeon-item.unlocked { border-color: var(--accent); background: linear-gradient(90deg, rgba(96, 165, 250, 0.1), transparent); }
        .dungeon-item.locked { opacity: 0.5; filter: grayscale(1); }
        .dungeon-item:active:not(.locked) { transform: scale(0.98); }

        /* AVATAR SELECTION */
        .avatar-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 100%; margin: 15px 0; max-height: 250px; overflow-y: auto; padding: 5px; }
        .avatar-opt { font-size: 2.5rem; background: rgba(255,255,255,0.1); border-radius: 12px; cursor: pointer; padding: 10px; transition: 0.2s; border: 2px solid transparent; }
        .avatar-opt.selected { border-color: var(--primary); background: rgba(251, 191, 36, 0.2); transform: scale(1.1); }

        /* CONTROLS (SPEED/AUDIO) */
        .audio-btn {
            position: fixed; top: 15px; right: 15px; z-index: 101;
            background: rgba(0,0,0,0.6); color: #fff; font-size: 0.9rem;
            width: 30px; height: 30px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; cursor: pointer;
            border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(5px);
        }
        .speed-badge {
            position: absolute; top: 10px; left: 10px; z-index: 50;
            background: var(--primary); color: #000; font-weight: 900; 
            font-size: 0.7rem; width: 30px; height: 30px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: transform 0.2s; border: 2px solid #fff;
        }
        .speed-badge:active { transform: scale(0.9); }

        /* AUTO FARM INDICATOR */
        .auto-indicator {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            background: rgba(255,0,0,0.7); color: white; padding: 5px 15px;
            border-radius: 20px; font-size: 0.8rem; font-weight: bold;
            pointer-events: none; border: 1px solid rgba(255,255,255,0.3);
            animation: pulse 1s infinite; display: none; z-index: 60;
        }
        @keyframes pulse { 0% { opacity:0.8; } 50% { opacity:1; } 100% { opacity:0.8; } }

        /* DOCK NAVIGATION */
        .dock {
            position: fixed; bottom: var(--safe-area-bottom); left: 50%; transform: translateX(-50%);
            background: rgba(15, 12, 41, 0.9); backdrop-filter: blur(20px);
            padding: 12px 25px; border-radius: 35px;
            display: flex; gap: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.1); z-index: 100;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .dock.hide { transform: translate(-50%, 150%); }
        .dock-icon {
            background: none; border: none; color: #6b7280;
            font-size: 1.6rem; cursor: pointer; position: relative;
            transition: 0.2s; padding: 4px;
        }
        .dock-icon.active { color: var(--primary); transform: translateY(-6px); }
        .dock-icon.active::after {
            content:''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            width: 5px; height: 5px; background: var(--primary); border-radius: 50%;
        }

        /* MODALS */
        .modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            z-index: 200; display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: #1e1b4b; border: 2px solid var(--primary);
            border-radius: 24px; padding: 30px; text-align: center;
            width: 85%; max-width: 350px;
            box-shadow: 0 0 50px rgba(251, 191, 36, 0.15);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column;
        }
        #modalBtns, .modal-actions {
            display: flex; gap: 10px; justify-content: center; width: 100%; margin-top: 15px;
        }
        .modal-actions button { flex: 1; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* UTILS */
        .text-gold { color: var(--primary); }
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }
        .d-none { display: none !important; }
        .opacity-50 { opacity: 0.5; }
    </style>
</head>
<body>

    <div class="bg-fx"></div>
    
    <div id="app">
        <!-- GLOBAL MUTE -->
        <div class="audio-btn" id="muteBtn" onclick="game.audio.toggle()">üîä</div>

        <!-- LOGIN -->
        <div id="loginScreen" class="screen active" style="justify-content: center;">
            <div class="panel">
                <div style="font-size: 4rem; margin-bottom: 10px; filter: drop-shadow(0 0 10px rgba(251, 191, 36, 0.4));">‚öîÔ∏è</div>
                <h1 style="font-size: 2.2rem; color: var(--primary); line-height: 1.1; margin-bottom: 5px;">WDev<br>Legends</h1>
                <p style="color:#9ca3af; margin-bottom: 30px; font-size: 0.9rem; letter-spacing: 2px;">PRO PLUS</p>
                <input type="text" id="loginUser" placeholder="Nome do Her√≥i" autocomplete="off">
                <input type="password" id="loginPass" placeholder="Senha Secreta">
                <button class="btn" onclick="game.login()">Jogar Agora</button>
            </div>
        </div>

        <!-- MENU (HOME) -->
        <div id="menuScreen" class="screen">
            <div class="top-hud">
                <div style="display:flex; gap:10px; align-items:center;">
                    <span id="homeAv" style="font-size:1.5rem">ü¶∏</span>
                    <b id="homeName">Heroi</b>
                </div>
                <div class="text-gold"><b id="homeGold">0</b> ü™ô</div>
            </div>

            <div class="panel">
                <div style="font-size: 5rem; margin-bottom: 10px;" id="homeBigAv">ü¶∏</div>
                <h2 style="margin-bottom: 5px;">N√≠vel <span id="homeLvl" class="text-gold">1</span></h2>
                <div class="bar-wrap" style="background:#333; height:12px;">
                    <div id="homeXp" class="bar-fill xp-fill" style="width:0%;"></div>
                </div>
                <p style="font-size: 0.8rem; color: #aaa; margin-top:5px;">Experi√™ncia</p>
            </div>

            <div style="width:100%; max-width:480px; display:flex; flex-direction:column; gap:15px;">
                <div class="adventure-card card-forest" onclick="game.battle.start('normal')">
                    <div class="adventure-card-icon">üå≤</div>
                    <div class="adventure-card-content">
                        <h3>Explorar Floresta</h3>
                        <p>Enfrente monstros para ganhar Ouro e XP.</p>
                    </div>
                    <div class="adventure-card-bg">‚öîÔ∏è</div>
                </div>
                <div class="adventure-card card-dungeon" onclick="game.nav('dungeon')">
                    <div class="adventure-card-icon">üè∞</div>
                    <div class="adventure-card-content">
                        <h3>Masmorras</h3>
                        <p>Desafie chefes para obter Itens Raros.</p>
                    </div>
                    <div class="adventure-card-bg">üíÄ</div>
                </div>
                <button class="btn btn-ghost" onclick="game.logout()">Sair do Jogo</button>
            </div>
        </div>

        <!-- BATTLE -->
        <div id="battleScreen" class="screen">
            <div class="arena">
                <div class="speed-badge" id="speedToggle" onclick="game.toggleSpeed()">1x</div>
                <div class="auto-indicator" id="autoInd">AUTO: 5</div>
                
                <!-- BATTLE LOG RIBBON (Top Center) -->
                <div id="battleLog" class="battle-log"></div>

                <div class="fighter" id="heroFighter">
                    <div class="fighter-lvl" id="bHeroLvl">Lvl 1</div>
                    <div id="floatHero" class="float-area"></div>
                    <div class="fighter-emoji" id="bHeroAv">ü¶∏</div>
                    <div class="fighter-shadow"></div>
                    <div class="bar-wrap" style="width:120%"><div id="bHeroHp" class="bar-fill hp-fill" style="width:100%"></div></div>
                    <div class="bar-wrap" style="width:120%; height:6px; margin-top:4px;"><div id="bHeroMp" class="bar-fill mp-fill" style="width:100%"></div></div>
                </div>
                <div class="fighter" id="enemyFighter">
                    <div class="fighter-lvl" id="bEnemyLvl">Lvl 1</div>
                    <div id="floatEnemy" class="float-area"></div>
                    <div class="fighter-emoji" id="bEnemyAv">üê∫</div>
                    <div class="fighter-shadow"></div>
                    <div class="bar-wrap" style="width:120%"><div id="bEnemyHp" class="bar-fill hp-fill" style="width:100%"></div></div>
                    <small id="bEnemyName" style="margin-top:5px; font-weight:bold; color:#fca5a5;">Lobo</small>
                </div>
            </div>
            <div class="panel" style="margin-bottom: 100px; padding: 20px;">
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <button class="btn btn-red" style="flex:1; margin:0;" onclick="game.battle.useItem('hp')">üç∑ <span id="bPotHp">0</span></button>
                    <button class="btn btn-blue" style="flex:1; margin:0;" onclick="game.battle.useItem('mp')">üß™ <span id="bPotMp">0</span></button>
                    <button class="btn btn-ghost" style="width:auto; margin:0;" onclick="game.battle.flee()">üè≥Ô∏è</button>
                </div>
                <div class="grid-skills" id="battleSkills"></div>
            </div>
        </div>

        <!-- CHARACTER -->
        <div id="charScreen" class="screen">
            <h2 style="margin-bottom:20px;">Perfil do Her√≥i</h2>
            <div class="panel">
                <div class="char-avatar-section">
                    <div style="font-size: 4rem;">ü¶∏</div>
                    <div style="text-align:left;">
                        <div style="font-weight:bold; font-size:1.2rem; color:var(--primary);">Atributos</div>
                        <div style="font-size:0.8rem; color:#aaa;">Pontos: <span id="ptsDisplay" class="text-gold">0</span></div>
                    </div>
                </div>
                <div class="char-dashboard">
                    <div class="char-stat-box">
                        <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;">
                            <span class="stat-label">For√ßa</span>
                            <button class="add-btn" onclick="game.char.addStat('str')">+</button>
                        </div>
                        <span class="stat-val" id="valStr">0</span>
                    </div>
                    <div class="char-stat-box">
                        <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;">
                            <span class="stat-label">Mente</span>
                            <button class="add-btn" onclick="game.char.addStat('int')">+</button>
                        </div>
                        <span class="stat-val" id="valInt">0</span>
                    </div>
                    <div class="char-stat-box">
                        <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;">
                            <span class="stat-label">Vida</span>
                            <button class="add-btn" onclick="game.char.addStat('vit')">+</button>
                        </div>
                        <span class="stat-val" id="valVit">0</span>
                    </div>
                    <div class="char-stat-box" style="justify-content:space-around;">
                        <div class="stat-label">Totais</div>
                        <div id="totalStats" style="font-size:0.7rem; color:#ccc;"></div>
                    </div>
                </div>
            </div>
            
            <h3 style="margin-bottom:10px;">Pergaminhos (Slots)</h3>
            <div style="display:flex; gap:15px; justify-content:center; margin-bottom:15px;">
                <div class="inv-slot" id="slot0" onclick="game.char.openSlot(0)" style="width:70px;"></div>
                <div class="inv-slot" id="slot1" onclick="game.char.openSlot(1)" style="width:70px;"></div>
                <div class="inv-slot" id="slot2" onclick="game.char.openSlot(2)" style="width:70px;"></div>
            </div>
            <div id="setBonus" style="text-align:center; height:20px; font-weight:bold; color:var(--primary);"></div>
        </div>

        <!-- SHOP -->
        <div id="shopScreen" class="screen">
            <div class="top-hud">
                <h3>Mercador</h3>
                <div class="text-gold"><b id="shopGoldDisplay">0</b> ü™ô</div>
            </div>
            <div id="shopList" class="shop-grid"></div>
        </div>

        <!-- INVENTORY -->
        <div id="invScreen" class="screen">
            <div class="top-hud"><h3>Mochila</h3></div>
            <div id="invList" class="inv-grid"></div>
        </div>

        <!-- DUNGEON -->
        <div id="dungeonScreen" class="screen">
            <h2 style="margin-bottom:15px;">Mapa de Portais</h2>
            <div id="dungeonList" class="list-container"></div>
        </div>
    </div>

    <!-- DOCK NAV -->
    <div id="navDock" class="dock hide">
        <button class="dock-icon active" onclick="game.nav('menu')" id="nav_menu">üè†</button>
        <button class="dock-icon" onclick="game.nav('char')" id="nav_char">üë§</button>
        <button class="dock-icon" onclick="game.nav('inv')" id="nav_inv">üéí</button>
        <button class="dock-icon" onclick="game.nav('shop')" id="nav_shop">üõí</button>
    </div>

    <!-- MODALS -->
    <div id="modal" class="modal-overlay">
        <div class="modal-box">
            <h2 id="modalTitle" style="color:var(--primary); margin-bottom:15px;">Aviso</h2>
            <div id="modalBody" style="margin-bottom:25px; line-height:1.5;">Texto</div>
            <div id="modalBtns" class="modal-actions"></div>
        </div>
    </div>

    <div id="confirmModal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="confirmTitle" style="margin-bottom:15px; color:var(--primary);">Confirma√ß√£o</h3>
            <p id="confirmBody" style="margin-bottom:25px; color:#ccc;">Texto</p>
            <div class="modal-actions">
                <button class="btn btn-ghost" onclick="document.getElementById('confirmModal').style.display='none'">Cancelar</button>
                <button class="btn" id="confirmBtnYes">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="createModal" class="modal-overlay">
        <div class="modal-box" style="max-width:400px;">
            <h3 style="margin-bottom:10px; color:var(--primary);">Escolha seu Her√≥i</h3>
            <div class="avatar-grid" id="avatarList"></div>
            <button class="btn" onclick="game.createChar()">Iniciar Jornada</button>
        </div>
    </div>

    <div id="scrollModal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-bottom:15px;">Equipar Pergaminho</h3>
            <div id="scrollList" style="max-height:200px; overflow-y:auto; text-align:left; width:100%;"></div>
            <div class="modal-actions">
                <button class="btn btn-ghost" onclick="document.getElementById('scrollModal').style.display='none'">Cancelar</button>
                <button class="btn btn-red" onclick="game.char.unequipScroll()">Remover</button>
            </div>
        </div>
    </div>

<script>
    const DB_KEY = 'wdev_rpg_proplus';
    const wait = ms => new Promise(r => setTimeout(r, ms / (game.state.speed || 1)));
    const MAX_LEVEL = 80;

    const DATA = {
        avatars: ['ü¶∏', 'ü•∑', 'üßô', 'üßù', 'üëÆ', 'üßü', 'üßö', 'üßû'],
        items: [
            {id:'hp', n:'Po√ß√£o Vida', p:50, type:'pot', i:'üç∑', desc:'Cura 100 HP'},
            {id:'mp', n:'Po√ß√£o Mana', p:50, type:'pot', i:'üß™', desc:'Recupera 50 MP'},
            {id:'sw1', n:'Espada Curta', atk:10, p:150, type:'eq', i:'üó°Ô∏è', desc:'Atk +10'},
            {id:'sh1', n:'Escudo Ferro', def:8, p:150, type:'eq', i:'üõ°Ô∏è', desc:'Def +8'},
            {id:'st1', n:'Cajado Arcano', atk:15, int:5, p:400, type:'eq', i:'ü™Ñ', desc:'Atk +15, Int +5'},
            {id:'ar1', n:'Armadura Leve', def:15, hp:100, p:400, type:'eq', i:'ü¶∫', desc:'Def +15, HP +100'},
            {id:'kng', n:'Excalibur', atk:60, p:5000, type:'eq', i:'üëë', desc:'Lend√°ria'},
            {id:'tri', n:'Tridente', atk:70, p:8000, type:'eq', i:'üî±', desc:'Divino'}
        ],
        scrolls: [
            {id:'s_f1', n:'Chama Menor', t:'fire', atk:5, i:'üìú'},
            {id:'s_w1', n:'Mar√© Alta', t:'water', hp:50, i:'üìú'},
            {id:'s_v1', n:'Brisa Leve', t:'wind', def:5, i:'üìú'},
            {id:'s_f2', n:'Supernova', t:'fire', atk:25, i:'üìú'},
        ],
        // FIXED CHARACTER ICONS
        enemies: [
            {n:'Rato Gigante', i:'üêÄ'},
            {n:'Morcego', i:'ü¶á'},
            {n:'Lobo Feroz', i:'üê∫'},
            {n:'Bandido', i:'ü•∑'}, // Ninja for Bandit
            {n:'Soldado', i:'üíÇ‚Äç‚ôÇÔ∏è'}   // Guardsman for Soldier
        ],
        bosses: [
            {n:'Golem Pedra', i:'üóø'},
            {n:'General Caos', i:'üëπ'}, // Oni for General
            {n:'Drag√£o Anci√£o', i:'üêâ'},
            {n:'Tit√£ Blindado', i:'ü§ñ'}
        ],
        skills: {
            normal: {n:'Ataque', c:0, m:1, i:'‚öîÔ∏è', type:'phys'},
            fire: {n:'Bola de Fogo', c:20, m:1.5, i:'üî•', type:'magic', color:'orange'},
            ice: {n:'Estaca Gelo', c:30, m:1.8, i:'‚ùÑÔ∏è', type:'magic', color:'cyan'},
            thunder: {n:'Rel√¢mpago', c:40, m:2.2, i:'‚ö°', type:'magic', color:'yellow'},
            special: {n:'Golpe Sagrado', c:50, m:2.5, i:'‚ú®', type:'magic', color:'gold'},
            ultimate: {n:'Meteoro', c:80, m:3.5, i:'‚òÑÔ∏è', type:'magic', color:'red'}
        }
    };

    const game = {
        db: { users:{}, cur:null },
        state: { inBattle:false, busy:false, mode:'normal', lvl:1, p:{}, e:{}, tempSlot:0, newCharData:null, speed:1, muted:false, autoRuns:0 },

        init() {
            const s = localStorage.getItem(DB_KEY);
            if(s) this.db = JSON.parse(s);
            if(this.db.cur && this.db.users[this.db.cur]) this.nav('menu');
            document.body.addEventListener('click', () => {
                if(game.audio.ctx && game.audio.ctx.state === 'suspended') game.audio.ctx.resume();
            }, {once:false}); 
        },

        save() { localStorage.setItem(DB_KEY, JSON.stringify(this.db)); },
        getU() { return this.db.users[this.db.cur]; },

        toggleSpeed() {
            this.state.speed = (this.state.speed >= 3) ? 1 : this.state.speed + 1;
            document.getElementById('speedToggle').textContent = this.state.speed + 'x';
            game.ui.floatText('hero', `Speed ${this.state.speed}x`, '#fff');
        },

        startAutoFarm() {
            this.state.autoRuns = 5;
            this.state.speed = 3;
            document.getElementById('speedToggle').textContent = '3x';
            game.ui.closeModal();
            game.battle.start('dungeon', this.state.lvl);
        },

        // --- AUDIO SYSTEM (SFX ONLY) ---
        audio: {
            ctx: null,
            init() {
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContext();
                } catch(e) { console.log('Audio init fail'); }
            },
            toggle() {
                game.state.muted = !game.state.muted;
                document.getElementById('muteBtn').textContent = game.state.muted ? 'üîá' : 'üîä';
            },
            playSFX(type) {
                if(!this.ctx || game.state.muted) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                const now = this.ctx.currentTime;
                if(type === 'hit') {
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(120, now); osc.frequency.exponentialRampToValueAtTime(0.01, now + 0.15);
                    gain.gain.setValueAtTime(0.4, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                    osc.start(now); osc.stop(now + 0.15);
                } else if(type === 'magic') {
                    osc.type = 'sine'; osc.frequency.setValueAtTime(300, now); osc.frequency.linearRampToValueAtTime(900, now + 0.3);
                    gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0.01, now + 0.3);
                    osc.start(now); osc.stop(now + 0.3);
                } else if(type === 'win') {
                    [523.25, 659.25, 783.99].forEach((freq, i) => {
                        const o = this.ctx.createOscillator(); const g = this.ctx.createGain(); o.connect(g); g.connect(this.ctx.destination);
                        o.type = 'triangle'; o.frequency.value = freq; g.gain.setValueAtTime(0.1, now + i*0.1); g.gain.linearRampToValueAtTime(0, now + i*0.1 + 0.4);
                        o.start(now + i*0.1); o.stop(now + i*0.1 + 0.4);
                    });
                }
            }
        },

        async login() {
            const u = document.getElementById('loginUser').value.trim();
            const p = document.getElementById('loginPass').value.trim();
            if(!u || !p) { game.ui.showModal("Erro", "Digite nome e senha."); return; }
            if(!game.audio.ctx) game.audio.init();

            if(!this.db.users[u]) {
                this.state.newCharData = { u, p };
                game.ui.openAvatarSelect();
            } else {
                if(this.db.users[u].pass === p) {
                    this.db.cur = u;
                    if(!this.db.users[u].scrollSlots) this.db.users[u].scrollSlots = [null,null,null];
                    this.save();
                    this.nav('menu');
                } else game.ui.showModal("Acesso Negado", "Senha incorreta!");
            }
        },

        createChar() {
            const data = this.state.newCharData;
            if(!data) return;
            const selectedAv = document.querySelector('.avatar-opt.selected');
            const avatar = selectedAv ? selectedAv.textContent : 'ü¶∏';
            this.db.users[data.u] = {
                pass: data.p, name: data.u, av: avatar, lvl: 1, xp: 0, gold: 100,
                inv: {hp:2, mp:1}, bag: [], equip: [], scrolls: [], scrollSlots: [null, null, null],
                stats: {str:1, int:1, vit:1, pts:0}, dungeonMax: 1
            };
            this.db.cur = data.u;
            this.save();
            document.getElementById('createModal').style.display = 'none';
            this.nav('menu');
        },

        logout() { this.db.cur = null; location.reload(); },

        nav(screenId) {
            if(this.state.inBattle && screenId !== 'battle') return; 
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(screenId+'Screen').classList.add('active');
            
            const dock = document.getElementById('navDock');
            const isLoggedIn = !!this.db.cur && screenId !== 'login';
            if(isLoggedIn && screenId !== 'battle') {
                dock.classList.remove('hide');
                document.querySelectorAll('.dock-icon').forEach(b => b.classList.remove('active'));
                const btn = document.getElementById('nav_'+screenId);
                if(btn) btn.classList.add('active');
            } else dock.classList.add('hide');

            if(screenId === 'menu') game.ui.renderHome();
            if(screenId === 'shop') game.ui.renderShop();
            if(screenId === 'inv') game.ui.renderInv();
            if(screenId === 'char') game.char.render();
            if(screenId === 'dungeon') game.ui.renderDungeon();
        },

        battle: {
            async start(mode, lvl=1) {
                const u = game.getU();
                game.state.mode = mode;
                game.state.lvl = lvl;
                game.state.inBattle = true;
                game.state.busy = false;

                // Clear log
                document.getElementById('battleLog').innerHTML = '';

                if(game.state.autoRuns > 0) {
                    document.getElementById('autoInd').style.display = 'block';
                    document.getElementById('autoInd').textContent = `AUTO: ${game.state.autoRuns}`;
                    setTimeout(() => game.battle.autoLoop(), 1000/game.state.speed);
                } else document.getElementById('autoInd').style.display = 'none';

                const stats = game.calcStats();
                game.state.p = { ...stats.s, curHp: stats.s.hp, curMp: stats.s.mp, maxHp: stats.s.hp, maxMp: stats.s.mp };

                let enemyData, mult = 1, enemyLvl = 1;
                if(mode === 'dungeon') {
                    let idx = (lvl - 1) % DATA.bosses.length;
                    enemyData = DATA.bosses[idx];
                    enemyLvl = lvl * 2;
                    mult = 1.5 + (lvl * 0.6);
                } else {
                    enemyData = DATA.enemies[Math.floor(Math.random() * DATA.enemies.length)];
                    enemyLvl = Math.max(1, u.lvl + Math.floor(Math.random() * 2));
                    mult = 1 + (u.lvl * 0.15);
                }

                game.state.e = {
                    name: enemyData.n, av: enemyData.i, lvl: enemyLvl,
                    maxHp: Math.floor((120 + lvl * 20) * mult),
                    curHp: Math.floor((120 + lvl * 20) * mult),
                    atk: Math.floor((12 + lvl * 2) * mult),
                    def: Math.floor((2 + lvl) * mult)
                };

                document.getElementById('bHeroAv').textContent = u.av;
                document.getElementById('bHeroLvl').textContent = 'Lvl ' + u.lvl;
                document.getElementById('bEnemyAv').textContent = game.state.e.av;
                document.getElementById('bEnemyName').textContent = game.state.e.name;
                document.getElementById('bEnemyLvl').textContent = 'Lvl ' + game.state.e.lvl;

                game.ui.renderBattleSkills();
                game.ui.updateBattleBars();
                game.nav('battle');
                game.ui.log('In√≠cio', 'turn-hero');
            },

            autoLoop() {
                if(!game.state.inBattle) return;
                const mp = game.state.p.curMp;
                let skill = 'normal';
                if(mp >= DATA.skills.ultimate.c) skill = 'ultimate';
                else if(mp >= DATA.skills.special.c) skill = 'special';
                else if(mp >= DATA.skills.thunder.c) skill = 'thunder';
                else if(mp >= DATA.skills.fire.c) skill = 'fire';
                
                game.battle.turn(skill).then(() => {
                    if(game.state.inBattle && game.state.autoRuns > 0) setTimeout(() => game.battle.autoLoop(), 1500/game.state.speed);
                });
            },

            async turn(type) {
                if(game.state.busy) return;
                game.state.busy = true;
                const p = game.state.p;
                const e = game.state.e;
                const skill = DATA.skills[type];

                if(p.curMp < skill.c) { 
                    if(game.state.autoRuns > 0) type = 'normal'; 
                    else { game.ui.floatText('hero', 'Sem Mana!', '#60a5fa'); game.state.busy = false; return; }
                }
                
                if(type !== 'normal') p.curMp -= skill.c;
                game.ui.updateBattleBars();
                game.ui.log('Her√≥i', 'turn-hero');
                game.audio.playSFX(skill.type === 'phys' ? 'hit' : 'magic');

                const hEl = document.getElementById('heroFighter');
                const eEl = document.getElementById('enemyFighter');
                hEl.style.transition = 'transform ' + (0.1/game.state.speed) + 's';
                hEl.style.transform = 'scale(1.1) translateX(60px)';
                await wait(150);
                hEl.style.transform = 'scale(1) translateX(0)';
                hEl.style.transition = 'transform ' + (0.3/game.state.speed) + 's';

                const eRect = eEl.getBoundingClientRect();
                const cx = eRect.left + eRect.width/2; const cy = eRect.top + eRect.height/2;
                if(skill.type === 'phys') game.ui.spawnParticles(cx, cy, '#ef4444', 'blood');
                else game.ui.spawnParticles(cx, cy, skill.color || '#fff', 'magic');

                let isCrit = Math.random() < (game.getU().stats.str * 0.02);
                let dmgRaw = (p.atk + (skill.c > 0 ? p.int * 2 : 0)) * skill.m;
                if(isCrit) { dmgRaw *= 1.5; game.ui.log('CR√çTICO!', 'crit'); }
                let dmg = Math.floor(dmgRaw - e.def);
                if(dmg < 1) dmg = 1;

                eEl.classList.add('shake');
                game.ui.floatText('enemy', dmg + (isCrit ? ' üí•' : ''), isCrit ? '#fbbf24' : '#fff');
                e.curHp -= dmg;
                game.ui.updateBattleBars();
                await wait(400);
                eEl.classList.remove('shake');

                if(e.curHp <= 0) { await wait(500); this.end(true); return; }

                // ENEMY TURN
                await wait(500);
                game.ui.log('Inimigo', 'turn-enemy');
                eEl.style.transition = 'transform ' + (0.1/game.state.speed) + 's';
                eEl.style.transform = 'scale(1.2) translateX(-60px)';
                await wait(150);
                eEl.style.transform = 'scale(1) translateX(0)';
                eEl.style.transition = 'transform ' + (0.3/game.state.speed) + 's';

                game.audio.playSFX('hit'); 
                const hRect = hEl.getBoundingClientRect();
                game.ui.spawnParticles(hRect.left + hRect.width/2, hRect.top + hRect.height/2, '#ef4444', 'blood');

                let eDmg = Math.max(1, Math.floor(e.atk - p.def));
                hEl.classList.add('shake');
                game.ui.floatText('hero', `-${eDmg}`, '#ef4444');
                p.curHp -= eDmg;
                game.ui.updateBattleBars();
                await wait(400);
                hEl.classList.remove('shake');

                if(p.curHp <= 0) { await wait(500); this.end(false); } 
                else { game.state.busy = false; game.ui.renderBattleSkills(); }
            },

            async useItem(type) {
                if(game.state.busy) return;
                const u = game.getU();
                if(u.inv[type] > 0) {
                    u.inv[type]--;
                    game.audio.playSFX('magic');
                    if(type === 'hp') {
                        game.state.p.curHp = Math.min(game.state.p.maxHp, game.state.p.curHp + 100);
                        game.ui.floatText('hero', '+100', '#34d399');
                    } else {
                        game.state.p.curMp = Math.min(game.state.p.maxMp, game.state.p.curMp + 50);
                        game.ui.floatText('hero', '+50 MP', '#60a5fa');
                    }
                    game.save();
                    game.ui.updateBattleBars();
                    game.state.busy = true;
                    await wait(800);
                    
                    // Enemy turn (free hit)
                    const eDmg = Math.max(1, Math.floor(game.state.e.atk - game.state.p.def));
                    document.getElementById('heroFighter').classList.add('shake');
                    game.audio.playSFX('hit');
                    game.ui.floatText('hero', `-${eDmg}`, '#ef4444');
                    game.state.p.curHp -= eDmg;
                    game.ui.updateBattleBars();
                    await wait(500);
                    document.getElementById('heroFighter').classList.remove('shake');
                    
                    if(game.state.p.curHp <= 0) this.end(false); else game.state.busy = false;
                } else game.ui.floatText('hero', 'Vazio!', '#aaa');
            },

            flee() {
                if(game.state.busy) return;
                if(game.state.autoRuns > 0) { game.state.autoRuns = 0; game.state.inBattle = false; game.nav('menu'); } 
                else game.ui.showConfirm("Fugir", "Abandonar batalha?", () => { game.state.inBattle = false; game.nav('menu'); });
            },

            end(win) {
                game.state.inBattle = false;
                if(win) {
                    game.audio.playSFX('win');
                    const u = game.getU();
                    const xp = game.state.mode === 'dungeon' ? 150 * game.state.lvl : 30 + (u.lvl*2);
                    const gold = game.state.mode === 'dungeon' ? 100 * game.state.lvl : 20 + (u.lvl);
                    u.xp += xp; u.gold += gold;
                    let msg = `Voc√™ venceu!<br><span class="text-gold">+${gold} Ouro</span> | <span class="text-green">+${xp} XP</span>`;
                    
                    if(game.state.mode === 'dungeon' && game.state.lvl === u.dungeonMax) { u.dungeonMax++; msg += "<br><b class='text-green'>Nova Masmorra!</b>"; }
                    if(u.xp >= u.lvl * 100 && u.lvl < MAX_LEVEL) { u.lvl++; u.xp = 0; u.stats.pts += 3; u.inv.hp += 1; msg += `<br><br><b class='text-gold' style='font-size:1.4rem'>LEVEL UP ${u.lvl}!</b>`; }
                    
                    if(game.state.mode === 'dungeon' && Math.random() < 0.4 && DATA.scrolls.length > 0) { 
                        const sc = DATA.scrolls[Math.floor(Math.random() * DATA.scrolls.length)]; 
                        u.scrolls.push(sc.id); 
                        msg += `<br>Drop: ${sc.n}`; 
                    }
                    
                    game.save(); 

                    if(game.state.autoRuns > 0) {
                        game.state.autoRuns--;
                        if(game.state.autoRuns > 0) {
                            game.ui.floatText('hero', `Auto: ${game.state.autoRuns} left`, '#00ff00');
                            setTimeout(() => { game.battle.start(game.state.mode, game.state.lvl); }, 1500);
                            return; 
                        }
                    }
                    game.ui.showModal("VIT√ìRIA", msg, true);
                } else { 
                    game.state.autoRuns = 0;
                    game.ui.showModal("DERROTA", "Voc√™ caiu em combate.", false); 
                    game.nav('menu'); 
                }
            }
        },

        // --- CHARACTER & CALCS ---
        char: {
            render() {
                const u = game.getU();
                const calc = game.calcStats();
                document.getElementById('ptsDisplay').textContent = u.stats.pts;
                ['str','int','vit'].forEach(s => document.getElementById('val'+(s.charAt(0).toUpperCase()+s.slice(1))).textContent = u.stats[s]);
                document.getElementById('totalStats').innerHTML = `
                    <div style="font-weight:bold;">‚öîÔ∏è ${calc.s.atk} | üõ°Ô∏è ${calc.s.def}</div>
                    <div style="margin-top:5px;"><span class="text-red">‚ù§Ô∏è ${calc.s.hp}</span> | <span class="text-green">‚ö° ${calc.s.mp}</span></div>
                `;
                u.scrollSlots.forEach((sid, idx) => {
                    const el = document.getElementById('slot'+idx);
                    el.className = 'inv-slot' + (sid ? ' equipped' : ' empty');
                    if(sid) { const sc = DATA.scrolls.find(x=>x.id===sid); el.innerHTML = sc ? sc.i : '?'; } 
                    else { el.innerHTML = '+'; }
                });
                const sb = document.getElementById('setBonus'); sb.textContent = '';
                if(calc.sets.fire === 3) sb.textContent = "üî• B√¥nus de Fogo Ativo!";
                if(calc.sets.water === 3) sb.textContent = "üíß B√¥nus de √Ågua Ativo!";
            },
            addStat(s) { const u = game.getU(); if(u.stats.pts > 0) { u.stats.pts--; u.stats[s]++; game.save(); this.render(); } },
            openSlot(idx) {
                game.state.tempSlot = idx; const u = game.getU(); const list = document.getElementById('scrollList'); list.innerHTML = '';
                const counts = {}; u.scrolls.forEach(id => counts[id] = (counts[id]||0)+1); u.scrollSlots.forEach(id => { if(id && counts[id]) counts[id]--; });
                let has = false; Object.keys(counts).forEach(sid => { if(counts[sid] > 0) { has = true; const sc = DATA.scrolls.find(x=>x.id === sid); 
                    const btn = document.createElement('div'); btn.className = 'list-item'; btn.innerHTML = `<div><b>${sc.i} ${sc.n}</b> <small>x${counts[sid]}</small></div>`; btn.onclick = () => { u.scrollSlots[game.state.tempSlot] = sid; game.save(); document.getElementById('scrollModal').style.display = 'none'; game.char.render(); }; list.appendChild(btn); } });
                if(!has) list.innerHTML = '<p style="text-align:center; padding:10px; color:#aaa">Nenhum pergaminho dispon√≠vel.</p>'; document.getElementById('scrollModal').style.display = 'flex';
            },
            unequipScroll() { const u = game.getU(); u.scrollSlots[game.state.tempSlot] = null; game.save(); document.getElementById('scrollModal').style.display = 'none'; game.char.render(); }
        },
        calcStats() {
            const u = game.getU();
            let s = { atk:10, def:5, hp:200, mp:50, int:0 };
            s.atk += (u.stats.str * 4) + (u.lvl * 2); s.hp += (u.stats.vit * 25) + (u.lvl * 20); s.mp += (u.stats.int * 15) + (u.lvl * 5); s.def += Math.floor(u.stats.str / 2) + u.lvl; s.int = u.stats.int;
            u.equip.forEach(eid => { let it = DATA.items.find(x => x.id === eid); if(it) { if(it.atk) s.atk += it.atk; if(it.def) s.def += it.def; if(it.hp) s.hp += it.hp; if(it.int) s.mp += (it.int*5); } });
            let sets = {fire:0, water:0, wind:0}; u.scrollSlots.forEach(sid => { if(sid) { let sc = DATA.scrolls.find(x => x.id === sid); if(sc) { if(sc.atk) s.atk += sc.atk; if(sc.hp) s.hp += sc.hp; if(sc.def) s.def += sc.def; if(sets[sc.t] !== undefined) sets[sc.t]++; } } });
            if(sets.fire === 3) s.atk = Math.floor(s.atk * 1.3); if(sets.water === 3) s.hp = Math.floor(s.hp * 1.3);
            return {s, sets};
        },

        // --- UI RENDERERS ---
        ui: {
            renderHome() {
                const u = game.getU();
                document.getElementById('homeName').textContent = u.name; document.getElementById('homeLvl').textContent = u.lvl; document.getElementById('homeGold').textContent = u.gold; document.getElementById('homeAv').textContent = u.av; document.getElementById('homeBigAv').textContent = u.av;
                const pct = Math.min(100, (u.xp / (u.lvl * 100)) * 100); document.getElementById('homeXp').style.width = pct + '%';
            },
            openAvatarSelect() {
                const box = document.getElementById('avatarList'); box.innerHTML = '';
                DATA.avatars.forEach((av, idx) => { const el = document.createElement('div'); el.className = 'avatar-opt ' + (idx===0?'selected':''); el.textContent = av; el.onclick = () => { document.querySelectorAll('.avatar-opt').forEach(x=>x.classList.remove('selected')); el.classList.add('selected'); }; box.appendChild(el); });
                document.getElementById('createModal').style.display = 'flex';
            },
            spawnParticles(x, y, color, type) {
                const isMagic = type === 'energy' || type === 'magic';
                const count = isMagic ? 40 : 15;
                for(let i=0; i<count; i++) {
                    const p = document.createElement('div');
                    p.className = 'particle';
                    p.style.backgroundColor = color;
                    p.style.left = x + 'px';
                    p.style.top = y + 'px';
                    if(isMagic) {
                        p.style.boxShadow = `0 0 10px ${color}`; p.style.width = (Math.random()*10 + 4) + 'px'; p.style.height = p.style.width;
                        const angle = Math.random() * Math.PI * 2; const vel = Math.random() * 100 + 40;
                        p.style.setProperty('--tx', Math.cos(angle) * vel + 'px'); p.style.setProperty('--ty', Math.sin(angle) * vel + 'px');
                        p.style.animation = `particleBang ${0.5/game.state.speed}s ease-out forwards`;
                    } else {
                        p.style.width = (Math.random()*6 + 2) + 'px'; p.style.height = p.style.width;
                        const angle = (Math.random() * Math.PI) + Math.PI; const vel = Math.random() * 80 + 20;
                        p.style.setProperty('--tx', Math.cos(angle) * 30 + 'px'); p.style.setProperty('--ty', vel + 'px');
                        p.style.animation = `particleGravity ${0.6/game.state.speed}s ease-in forwards`;
                    }
                    document.body.appendChild(p); setTimeout(() => p.remove(), 1000/game.state.speed);
                }
            },
            log(txt, type) {
                const box = document.getElementById('battleLog');
                const el = document.createElement('div');
                el.className = `log-entry ${type}`;
                el.textContent = txt;
                box.appendChild(el);
                // Keep max 2
                if(box.children.length > 2) box.removeChild(box.firstChild);
                // Auto fade
                setTimeout(() => el.remove(), 1500);
            },
            renderShop() {
                const u = game.getU(); document.getElementById('shopGoldDisplay').textContent = u.gold; const list = document.getElementById('shopList'); list.innerHTML = '';
                DATA.items.forEach(it => { 
                    const owned = (it.type==='eq' && u.bag.includes(it.id)); 
                    const card = document.createElement('div'); card.className = 'shop-card';
                    card.innerHTML = `<div class="shop-card-icon">${it.i}</div><div class="shop-card-title">${it.n}</div><div class="shop-card-desc">${it.desc}</div><button class="btn ${owned?'btn-ghost':'btn-green'}" onclick="game.ui.buy('${it.id}')" ${owned?'disabled':''}>${owned ? 'OK' : it.p + ' üí∞'}</button>`;
                    list.appendChild(card); 
                });
            },
            buy(id) {
                const u = game.getU(); const it = DATA.items.find(x => x.id === id);
                if(u.gold >= it.p) { u.gold -= it.p; if(it.type === 'pot') u.inv[id] = (u.inv[id]||0) + 1; else u.bag.push(id); game.save(); this.renderShop(); } 
                else this.showModal("Loja", "Voc√™ n√£o tem ouro suficiente!");
            },
            renderInv() {
                const u = game.getU(); const list = document.getElementById('invList'); list.innerHTML = '';
                const allItems = [];
                if(u.inv.hp > 0) allItems.push({id:'hp', n:'Po√ß√£o Vida', i:'üç∑', qty:u.inv.hp});
                if(u.inv.mp > 0) allItems.push({id:'mp', n:'Po√ß√£o Mana', i:'üß™', qty:u.inv.mp});
                u.bag.forEach(bid => { const it = DATA.items.find(x=>x.id===bid); if(it) allItems.push({...it, qty:1}); });
                for(let i=0; i<20; i++) {
                    const it = allItems[i];
                    const slot = document.createElement('div');
                    slot.className = 'inv-slot' + (it ? (u.equip.includes(it.id) ? ' equipped' : '') : ' empty');
                    if(it) {
                        slot.innerHTML = `<div>${it.i}</div>${it.qty > 1 ? `<div class="inv-qty">${it.qty}</div>` : ''}`;
                        slot.onclick = () => { if(it.id === 'hp' || it.id === 'mp') return; game.ui.toggleEquip(it.id); };
                    }
                    list.appendChild(slot);
                }
            },
            toggleEquip(id) { const u = game.getU(); const idx = u.equip.indexOf(id); if(idx > -1) u.equip.splice(idx, 1); else u.equip.push(id); game.save(); this.renderInv(); },
            renderDungeon() {
                const u = game.getU(); const list = document.getElementById('dungeonList'); list.innerHTML = '';
                for(let i=1; i<=20; i++) { const locked = i > u.dungeonMax; const boss = DATA.bosses[(i-1)%DATA.bosses.length]; const el = document.createElement('div'); el.className = `dungeon-item ${locked?'locked':'unlocked'}`; el.innerHTML = `<div><b>${i}</b> - ${boss.n}</div>${!locked?'<button class="btn btn-blue" style="width:auto;margin:0;padding:5px 15px;">Ir</button>':''}`; if(!locked) el.onclick = () => game.battle.start('dungeon', i); list.appendChild(el); }
            },
            renderBattleSkills() {
                const box = document.getElementById('battleSkills'); box.innerHTML = ''; const u = game.getU(); const mp = game.state.p.curMp;
                Object.keys(DATA.skills).forEach(k => { const s = DATA.skills[k]; if(u.lvl < 2 && k !== 'normal') return; if(u.lvl < 3 && (k === 'ice' || k === 'thunder')) return; if(u.lvl < 5 && (k === 'special' || k === 'ultimate')) return; const btn = document.createElement('div'); const cant = mp < s.c; btn.className = `skill-btn ${cant ? 'disabled' : ''}`; btn.innerHTML = `<span class="skill-icon">${s.i}</span><span class="skill-info">${s.n}<br>${s.c} MP</span>`; btn.onclick = () => { if(!cant) game.battle.turn(k); }; box.appendChild(btn); });
            },
            updateBattleBars() {
                const p = game.state.p; const e = game.state.e;
                document.getElementById('bHeroHp').style.width = Math.max(0, (p.curHp/p.maxHp)*100) + '%'; document.getElementById('bHeroMp').style.width = Math.max(0, (p.curMp/p.maxMp)*100) + '%'; document.getElementById('bEnemyHp').style.width = Math.max(0, (e.curHp/e.maxHp)*100) + '%';
                document.getElementById('bPotHp').textContent = game.getU().inv.hp || 0; document.getElementById('bPotMp').textContent = game.getU().inv.mp || 0;
            },
            floatText(target, txt, color) { const box = document.getElementById(target === 'hero' ? 'floatHero' : 'floatEnemy'); const el = document.createElement('div'); el.className = 'float-txt'; el.textContent = txt; el.style.color = color; box.appendChild(el); setTimeout(() => el.remove(), 800/game.state.speed); },
            showModal(title, text, isWin) { 
                document.getElementById('modalTitle').textContent = title; 
                document.getElementById('modalBody').innerHTML = text; 
                const btnArea = document.getElementById('modalBtns'); btnArea.innerHTML = '';
                if(isWin && game.state.mode === 'dungeon') {
                    const farmBtn = document.createElement('button'); farmBtn.className = 'btn btn-blue'; farmBtn.textContent = '‚ö° Farmar x5'; farmBtn.onclick = () => game.startAutoFarm(); btnArea.appendChild(farmBtn);
                }
                const closeBtn = document.createElement('button'); closeBtn.className = 'btn'; closeBtn.textContent = 'Continuar'; closeBtn.onclick = () => game.ui.closeModal(); btnArea.appendChild(closeBtn);
                document.getElementById('modal').style.display = 'flex'; 
            },
            showConfirm(title, text, onYes) { 
                document.getElementById('confirmTitle').textContent = title; 
                document.getElementById('confirmBody').innerHTML = text; 
                const yesBtn = document.getElementById('confirmBtnYes'); 
                const newBtn = yesBtn.cloneNode(true);
                yesBtn.parentNode.replaceChild(newBtn, yesBtn);
                newBtn.onclick = () => { document.getElementById('confirmModal').style.display = 'none'; onYes(); }; 
                document.getElementById('confirmModal').style.display = 'flex'; 
            },
            closeModal() { document.getElementById('modal').style.display = 'none'; if(!game.state.inBattle) game.nav('menu'); }
        }
    };

    window.onload = () => game.init();
</script>
</body>
</html>

