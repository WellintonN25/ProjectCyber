<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WDev Stories - Inventory Edition</title>
    <style>
        :root {
            --bg-color: #1a0f0a;
            --box-bg: #f4e4c1;
            --box-border: #5c3317;
            --text-color: #2c1810;
            --accent: #8b5a2b;
            --success: #27ae60;
            --danger: #c0392b;
        }

        /* TEMA DIA */
        body.day {
            --bg-color: #4a90e2;
            background-image: radial-gradient(circle, #87CEEB 10%, transparent 10%);
        }
        
        /* TEMA NOITE */
        body.night {
            --bg-color: #050510;
            background-image: radial-gradient(circle, #1a1a2e 10%, transparent 10%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Verdana', sans-serif;
            background-color: var(--bg-color);
            background-size: 20px 20px;
            color: var(--box-bg);
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
            transition: background 1s ease;
        }
        .container { max-width: 600px; margin: 0 auto; padding: 10px; position: relative; }

        .box-style {
            background: var(--box-bg);
            border: 4px solid var(--box-border);
            border-radius: 8px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            padding: 20px; margin-bottom: 20px; color: var(--text-color); position: relative;
        }
        .btn {
            width: 100%; padding: 15px;
            background: linear-gradient(180deg, var(--accent) 0%, var(--box-border) 100%);
            border: 2px solid #3d2212; border-radius: 6px;
            color: #fff; font-weight: bold; font-size: 1rem;
            text-transform: uppercase; cursor: pointer;
            box-shadow: 0 4px 0 #3d2212; margin-top: 10px;
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn-small { width: auto; padding: 5px 10px; font-size: 0.8em; margin: 0 5px; }
        
        .btn-equip { background: var(--success); border-color: #1e8449; }
        .btn-unequip { background: var(--danger); border-color: #922b21; }

        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-weight: bold; color: var(--box-border); margin-bottom: 5px; }
        .input-group input { width: 100%; padding: 10px; border: 2px solid var(--accent); border-radius: 4px; }

        /* AVATAR */
        .character { display: flex; flex-direction: column; align-items: center; position: relative; width: 45%; }
        .character-avatar {
            width: 110px; height: 110px;
            border-radius: 20px; border: 5px solid var(--box-border);
            background: linear-gradient(135deg, #fff5e6, #ffdbb3);
            display: flex; align-items: center; justify-content: center;
            font-size: 4em; position: relative; z-index: 1;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); overflow: hidden;
        }
        .char-level { 
            background: var(--box-border); color: #fff; padding: 2px 8px; 
            border-radius: 10px; font-size: 0.7em; margin-top: -10px; 
            z-index: 2; position: relative; border: 1px solid var(--box-bg);
        }

        /* STATS */
        .stat-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #ccc; }
        .stat-val { font-weight: bold; font-size: 1.2em; }
        .points-avail { text-align: center; background: #27ae60; color: #fff; padding: 5px; border-radius: 4px; margin-bottom: 10px; }

        /* BARRAS */
        .bars-container { position: absolute; top: -35px; left: 50%; transform: translateX(-50%); width: 100%; max-width: 120px; z-index: 10; }
        .bar-wrap { width: 100%; background: #222; border: 2px solid var(--box-border); border-radius: 4px; height: 18px; position: relative; margin-bottom: 2px; }
        .mp-bar-wrap { height: 8px; }
        .bar-fill { height: 100%; transition: width 0.2s; }
        .hp-fill { background: #e74c3c; } .mp-fill { background: #3498db; }
        .hp-text { position: absolute; width: 100%; text-align: center; top: 0; font-size: 0.7em; color: #fff; line-height: 16px; text-shadow: 1px 1px 0 #000; }

        /* BATALHA */
        .battle-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .speed-btn { background: #fff; border: 2px solid var(--box-border); padding: 5px 10px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.8em; }

        .battle-arena { display: flex; justify-content: space-between; align-items: flex-end; margin: 30px 0; min-height: 160px; }
        
        .attack-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 15px; }
        .attack-btn {
            background: #fff; border: 2px solid var(--box-border); border-radius: 8px;
            padding: 10px 0; font-size: 1.5em; cursor: pointer;
            display: flex; flex-direction: column; align-items: center;
            transition: all 0.2s;
        }
        .attack-btn:active { transform: translateY(2px); }
        .attack-btn:disabled { opacity: 0.6; filter: grayscale(1); background: #ddd; cursor: not-allowed; }
        .attack-cost { font-size: 0.3em; background: #3498db; color: #fff; padding: 2px; border-radius: 4px; margin-top: 2px; }
        .lock-text { font-size: 0.4em; color: #555; font-weight: bold; margin-top: 5px; }

        .potion-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .potion-btn { flex: 1; padding: 8px; border: 2px solid var(--accent); background: #fff; border-radius: 6px; font-weight: bold; cursor: pointer; }

        /* PARTICULAS E ANIMACOES */
        .particle { position: absolute; pointer-events: none; z-index: 100; }
        .p-fire { background: radial-gradient(circle, #ffaa00, #ff4500); border-radius: 50%; animation: fireRise 0.8s forwards; }
        @keyframes fireRise { 0% { opacity: 1; transform: scale(1) translate(0, 0); } 100% { opacity: 0; transform: scale(3) translate(var(--rx), -60px); } }
        .p-ice { background: rgba(200, 255, 255, 0.8); border: 1px solid #fff; clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%); animation: iceFall 0.8s forwards; }
        @keyframes iceFall { 0% { opacity: 1; transform: translate(0, 0) rotate(0deg); } 100% { opacity: 0; transform: translate(var(--rx), 80px) rotate(360deg); } }
        .p-blood { background: #8a0b0b; border-radius: 50%; animation: bloodSplat 0.4s forwards; }
        @keyframes bloodSplat { 0% { transform: scale(0.5) translate(0, 0); } 100% { opacity: 0; transform: scale(var(--s)) translate(var(--rx), var(--ry)); } }
        .p-thunder { background: #ffff00; width: 2px !important; height: 10px !important; animation: spark 0.3s forwards; }
        @keyframes spark { 0% { opacity:1; transform: translate(0,0) rotate(var(--rot)); } 100% { opacity:0; transform: translate(var(--rx), var(--ry)) rotate(var(--rot)); } }

        .flash-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: #fff; opacity:0; pointer-events: none; z-index: 999; animation: flash 0.1s; }
        @keyframes flash { 0% { opacity: 0.6; } 100% { opacity: 0; } }

        .shake { animation: shake 0.4s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        .float-text { position: fixed; font-size: 2em; font-weight: 900; color: #e74c3c; text-shadow: 2px 2px 0 #fff; animation: float 0.8s forwards; pointer-events: none; z-index: 200; }
        @keyframes float { to { transform: translateY(-60px); opacity: 0; } }

        /* TELA */
        .screen { display: none; }
        .screen.active { display: block; animation: fade 0.3s; }
        @keyframes fade { from { opacity:0; } to { opacity:1; } }
        
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; z-index:2000; }
        .modal-box { background: var(--box-bg); color: var(--text-color); padding: 20px; border: 4px solid var(--box-border); border-radius: 10px; text-align: center; width: 90%; max-width: 350px; }
        
        .emoji-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; }
        .emoji-opt { font-size: 2em; padding: 5px; border: 1px solid #999; border-radius: 5px; text-align: center; cursor: pointer; background: #fff; }
        .emoji-opt.selected { background: #ffdbb3; border-color: var(--box-border); }
        
        .xp-container { background: #ccc; height: 10px; border: 1px solid var(--box-border); margin-top: 5px; border-radius: 4px; }
        .xp-bar { height: 100%; background: orange; width: 0%; transition: width 0.3s; }
        
        .rare-item { border-color: gold !important; background: #fff8dc; }

        /* AUDIO PLAYER */
        .music-control {
            position: fixed; bottom: 10px; right: 10px;
            background: rgba(0,0,0,0.7); padding: 5px; border-radius: 50%;
            cursor: pointer; font-size: 1.5em; z-index: 5000; color: #fff;
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
        }
        
        /* CARD ITEM */
        .item-card { display: flex; flex-direction: column; align-items: center; border: 2px solid #ccc; border-radius: 8px; padding: 10px; background: #fff; position:relative; }
        .item-card.equipped { border-color: #27ae60; background: #e8f8f5; box-shadow: 0 0 10px #27ae60; }
        .item-stats { font-size: 0.75em; color: #666; margin: 5px 0; min-height: 2.5em; }
    </style>
</head>
<body class="day">
    <audio id="bgm" loop>
        <source src="https://cdn.pixabay.com/download/audio/2022/11/22/audio_febc508520.mp3?filename=technology-126236.mp3" type="audio/mpeg">
    </audio>
    <div class="music-control" onclick="game.toggleMusic()" id="musicIcon">üîá</div>
    <div id="flashOverlay" class=""></div>

    <div class="container">
        <div id="loginScreen" class="screen active">
            <div class="box-style">
                <h1 style="text-align: center;">‚öîÔ∏è WDev Stories</h1>
                <p style="text-align:center; font-size:0.8em; margin-bottom:10px;">Inventory Edition</p>
                <div class="input-group"><label>Nick</label><input type="text" id="loginUser"></div>
                <div class="input-group"><label>Senha</label><input type="password" id="loginPass"></div>
                <button class="btn" onclick="game.login()">Jogar</button>
                <div style="text-align:center; margin-top:10px;"><small onclick="game.resetAll()" style="color:red; cursor:pointer;">[Resetar Tudo]</small></div>
            </div>
        </div>

        <div id="createScreen" class="screen">
            <div class="box-style">
                <h2 style="text-align:center;">Criar Her√≥i</h2>
                <div class="character-avatar" style="margin:10px auto;"><span id="prevAv">ü¶∏</span></div>
                <input type="text" id="newame" placeholder="Nome" style="width:100%; padding:10px; margin-bottom:10px;">
                <div class="emoji-grid" id="gridAv"></div>
                <button class="btn" onclick="game.create()">Salvar</button>
            </div>
        </div>

        <div id="menuScreen" class="screen">
            <div class="box-style">
                <div style="display:flex; justify-content:space-between; font-weight:bold; border-bottom:2px solid var(--box-border); padding-bottom:10px;">
                    <span id="mName">Nome</span><span>üí∞ <span id="mGold">0</span></span>
                </div>
                <div style="margin-top:10px;">Lvl <span id="mLvl">1</span><div class="xp-container"><div class="xp-bar" id="mXp"></div></div></div>
                <button class="btn" onclick="game.battleStart()">‚öîÔ∏è Batalhar</button>
                <button class="btn" onclick="game.openChar()">üë§ Meu Personagem</button>
                <button class="btn" onclick="game.shop()">üõí Loja</button>
                <button class="btn" onclick="game.inv()">üéí Mochila / Equipar</button>
                <button class="btn" style="background:#c0392b" onclick="game.logout()">Sair</button>
            </div>
        </div>

        <div id="charScreen" class="screen">
            <div class="box-style">
                <h3>Atributos</h3>
                <div class="points-avail" id="ptsDisplay">Pontos: 0</div>
                <div class="stat-row"><span>üí™ For√ßa</span><div><span id="stStr" class="stat-val">1</span><button class="btn btn-small" onclick="game.addStat('str')">+</button></div></div>
                <div class="stat-row"><span>üß† Intelig√™ncia</span><div><span id="stInt" class="stat-val">1</span><button class="btn btn-small" onclick="game.addStat('int')">+</button></div></div>
                <div class="stat-row"><span>‚ù§Ô∏è Vitalidade</span><div><span id="stVit" class="stat-val">1</span><button class="btn btn-small" onclick="game.addStat('vit')">+</button></div></div>
                
                <h3 style="margin-top:20px;">Resumo Total</h3>
                <div id="totalStats" style="font-size:0.9em; margin-top:5px; color:#444;"></div>

                <button class="btn" onclick="game.menu()">Voltar</button>
            </div>
        </div>

        <div id="battleScreen" class="screen">
            <div class="box-style">
                <div class="battle-header">
                    <b>Luta: <span id="bCount">1</span></b>
                    <div>
                        <button id="speedBtn" class="speed-btn" onclick="game.toggleSpeed()">1x</button>
                        <button class="speed-btn" onclick="game.menu()">Fugir</button>
                    </div>
                </div>
                
                <div class="battle-arena">
                    <div class="character">
                        <div class="bars-container">
                            <div class="bar-wrap"><div class="bar-fill hp-fill" id="pHpBar"></div><div class="hp-text" id="pHpTx"></div></div>
                            <div class="bar-wrap mp-bar-wrap"><div class="bar-fill mp-fill" id="pMpBar"></div></div>
                        </div>
                        <div class="character-avatar" id="pAv"><span>ü¶∏</span></div>
                        <div class="char-level" id="pLvlDisplay">Lvl 1</div>
                        <b>Voc√™</b>
                    </div>
                    <div style="font-size:2em; font-weight:bold; color:#c0392b;">VS</div>
                    <div class="character">
                        <div class="bars-container">
                            <div class="bar-wrap"><div class="bar-fill hp-fill" id="eHpBar"></div><div class="hp-text" id="eHpTx"></div></div>
                        </div>
                        <div class="character-avatar" id="eAv"><span>üëπ</span></div>
                        <div class="char-level" id="eLvlDisplay">Lvl 1</div>
                        <b id="eName">Monstro</b>
                    </div>
                </div>

                <div class="potion-row">
                    <button class="potion-btn" id="btnPotHp" onclick="game.usePot('hp')">üç∑ HP: <span id="qtyHp">0</span></button>
                    <button class="potion-btn" id="btnPotMp" onclick="game.usePot('mp')">üß™ MP: <span id="qtyMp">0</span></button>
                </div>

                <div id="bLog" style="background:rgba(0,0,0,0.1); padding:5px; text-align:center; margin-bottom:5px; font-size:0.8em; border-radius:4px;">Iniciando...</div>

                <div class="attack-grid">
                    <button class="attack-btn" id="btn_normal" onclick="game.atk('normal')">‚öîÔ∏è</button>
                    <button class="attack-btn" id="btn_fire" onclick="game.atk('fire')">üî•</button>
                    <button class="attack-btn" id="btn_ice" onclick="game.atk('ice')">‚ùÑÔ∏è</button>
                    <button class="attack-btn" id="btn_thunder" onclick="game.atk('thunder')">‚ö°</button>
                    <button class="attack-btn" id="btn_special" onclick="game.atk('special')">‚ú®</button>
                    <button class="attack-btn" id="btn_ultimate" onclick="game.atk('ultimate')">üí•</button>
                </div>
            </div>
        </div>

        <div id="shopScreen" class="screen">
            <div class="box-style">
                <h3>Loja (üí∞ <span id="sGold">0</span>)</h3>
                <div id="sGrid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;"></div>
                <button class="btn" onclick="game.menu()">Voltar</button>
            </div>
        </div>

        <div id="invScreen" class="screen">
            <div class="box-style">
                <h3>Mochila e Equipamentos</h3>
                <p style="font-size:0.8em; margin-bottom:10px;">Equipe seus itens para ganhar os b√¥nus.</p>
                <div id="iGrid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;"></div>
                <button class="btn" onclick="game.menu()">Voltar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="modal-box">
            <h2 id="modTitle">TITULO</h2>
            <div id="modBody" style="margin:15px 0; font-size:1.2em;">Texto</div>
            <button class="btn" onclick="game.closeMod()">Continuar</button>
        </div>
    </div>

    <script>
        const KEY = 'wdev_action_v3';
        
        // --- AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const soundSys = {
            playTone(freq, type, duration, vol=0.1) {
                if(audioCtx.state === 'suspended') audioCtx.resume();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                gain.gain.setValueAtTime(vol, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + duration);
            },
            playNoise(duration) {
                if(audioCtx.state === 'suspended') audioCtx.resume();
                const bufferSize = audioCtx.sampleRate * duration;
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                const noise = audioCtx.createBufferSource();
                noise.buffer = buffer;
                const gain = audioCtx.createGain();
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                noise.connect(gain); gain.connect(audioCtx.destination); noise.start();
            },
            sfx(type) {
                if(type === 'hit') this.playNoise(0.1); 
                if(type === 'fire') { this.playTone(300, 'sawtooth', 0.5); this.playNoise(0.5); }
                if(type === 'ice') this.playTone(800, 'sine', 0.6); 
                if(type === 'thunder') { this.playTone(100, 'sawtooth', 0.2); this.playNoise(0.3); } 
                if(type === 'coin') this.playTone(1200, 'sine', 0.1); 
                if(type === 'lvl') { this.playTone(400, 'square', 0.2); setTimeout(()=>this.playTone(600, 'square', 0.4), 200); }
                if(type === 'equip') this.playTone(800, 'triangle', 0.1);
            }
        };

        const game = {
            db: { users: {}, cur: null },
            st: { p: {}, e: {}, turn: true, busy: false, bNum: 0, boss: 5, isBoss: false },
            speed: 1, 
            musicPlaying: false,
            
            data: {
                skills: {
                    normal: { n:'Corte', m:1, c:0, r:15, type:'blood', sfx:'hit', req:1, icon:'‚öîÔ∏è' },
                    fire:   { n:'Fogo', m:1.5, c:20, r:0, type:'fire', sfx:'fire', req:1, icon:'üî•' },
                    ice:    { n:'Gelo', m:1.7, c:30, r:0, type:'ice', sfx:'ice', req:3, icon:'‚ùÑÔ∏è' },
                    thunder:{ n:'Raio', m:2.0, c:40, r:0, type:'thunder', sfx:'thunder', req:5, icon:'‚ö°' },
                    special:{ n:'Luz', m:2.5, c:50, r:0, type:'fire', sfx:'fire', req:8, icon:'‚ú®' },
                    ultimate:{ n:'Meteoro', m:3.5, c:80, r:0, type:'fire', sfx:'fire', req:12, icon:'üí•' }
                },
                items: [
                    {id:'hp', n:'Po√ß√£o Vida', i:'üç∑', p:50, t:'pot'},
                    {id:'mp', n:'Po√ß√£o Mana', i:'üß™', p:50, t:'pot'},
                    {id:1, n:'Espada', i:'üó°Ô∏è', atk:5, p:100, t:'eq'},
                    {id:2, n:'Escudo', i:'üõ°Ô∏è', def:5, p:100, t:'eq'},
                    {id:3, n:'Cajado', i:'ü™Ñ', atk:10, int:5, p:400, t:'eq'},
                    {id:4, n:'Armadura', i:'ü¶∫', def:10, hp:50, p:400, t:'eq'}
                ],
                bossDrops: [
                    {id:100, n:'Coroa Real', i:'üëë', atk:10, def:10, int:10, t:'eq'},
                    {id:101, n:'Tridente', i:'üî±', atk:25, t:'eq'},
                    {id:102, n:'Manto Sombrio', i:'üåö', def:20, hp:100, t:'eq'},
                    {id:103, n:'Anel Drag√£o', i:'üíç', atk:15, int:15, t:'eq'}
                ],
                avs: ['ü¶∏','ü•∑','üßô','üßõ','üßü','üßö','üßú','üßû','ü¶π','ü§ñ'],
                enemies: [ {n:'Goblin', i:'üëπ'}, {n:'Orc', i:'üë∫'}, {n:'Fantasma', i:'üëª'}, {n:'Esqueleto', i:'üíÄ'}, {n:'Lobo', i:'üê∫'}, {n:'Aranha', i:'üï∑Ô∏è'} ],
                bosses: [ {n:'Drag√£o Anci√£o', i:'üê≤'}, {n:'Rei Dem√¥nio', i:'üëë'}, {n:'Kraken', i:'ü¶ë'} ]
            },
            tmpAv: 'ü¶∏',

            init() {
                try { const s = localStorage.getItem(KEY); if(s) this.db = JSON.parse(s); } catch(e) {}
                this.rendAv();
                this.checkTheme();
                setInterval(() => this.checkTheme(), 60000);
                document.getElementById('bgm').volume = 0.1;
            },

            checkTheme() {
                const hour = new Date().getHours();
                const body = document.body;
                if(hour >= 18 || hour < 6) { if(!body.classList.contains('night')) { body.classList.remove('day'); body.classList.add('night'); } }
                else { if(!body.classList.contains('day')) { body.classList.remove('night'); body.classList.add('day'); } }
            },

            startMusic() {
                const bgm = document.getElementById('bgm');
                if(bgm.paused) { bgm.play().then(() => document.getElementById('musicIcon').textContent = 'üîä').catch(e => {}); }
            },
            toggleMusic() {
                const bgm = document.getElementById('bgm');
                if(bgm.paused) { bgm.play(); document.getElementById('musicIcon').textContent = 'üîä'; }
                else { bgm.pause(); document.getElementById('musicIcon').textContent = 'üîá'; }
            },

            save() { localStorage.setItem(KEY, JSON.stringify(this.db)); },
            resetAll() { if(confirm('Resetar tudo?')) { localStorage.removeItem(KEY); location.reload(); } },
            wait(ms) { return new Promise(r => setTimeout(r, ms * this.speed)); },
            toggleSpeed() { this.speed = this.speed === 1 ? 0.5 : 1; document.getElementById('speedBtn').textContent = this.speed === 1 ? '1x' : '2x'; },

            login() {
                const u = document.getElementById('loginUser').value.trim();
                const p = document.getElementById('loginPass').value.trim();
                if(!u || !p) return alert('Preencha tudo!');
                if(!this.db.users[u]) {
                    if(confirm('Criar conta?')) { this.db.users[u] = { pass: p, ok: false }; this.db.cur = u; this.nav('create'); }
                } else {
                    if(this.db.users[u].pass === p) {
                        this.db.cur = u; this.fixData(this.db.users[u]);
                        if(this.db.users[u].ok) { this.menu(); this.startMusic(); } else this.nav('create');
                    } else alert('Senha errada!');
                }
            },
            
            // CORRE√á√ÉO DO LOGOUT
            logout() {
                this.db.cur = null;
                document.getElementById('loginUser').value = '';
                document.getElementById('loginPass').value = '';
                const bgm = document.getElementById('bgm');
                bgm.pause(); bgm.currentTime = 0;
                document.getElementById('musicIcon').textContent = 'üîá';
                this.nav('login');
            },

            fixData(user) {
                if(!user.inv) user.inv = { hp:1, mp:1 };
                if(!user.stats) user.stats = { str:1, int:1, vit:1, pts:0 };
                // MIGRA√á√ÉO DE SISTEMA DE ITENS
                if(!user.bag) user.bag = []; // Inventario (posse)
                if(!user.equip) user.equip = []; // Ativos
                
                // Se o usu√°rio tinha itens no sistema antigo (equipados direto), move para a bag
                if(user.equip.length > 0 && user.bag.length === 0) {
                    user.bag = [...user.equip];
                    // Mant√©m equipados para n√£o quebrar status, ou reseta. Vamos manter.
                }
            },
            
            create() {
                const n = document.getElementById('newame').value.trim() || 'Heroi';
                const u = this.db.users[this.db.cur];
                u.name = n; u.av = this.tmpAv; u.lvl = 1; u.xp = 0; u.gold = 100; u.inv = { hp:2, mp:2 }; u.bag = []; u.equip = []; u.ok = true;
                u.stats = { str:1, int:1, vit:1, pts:3 };
                this.save(); this.menu(); this.startMusic();
            },
            
            rendAv() {
                const g = document.getElementById('gridAv'); g.innerHTML = '';
                this.data.avs.forEach(a => {
                    const d = document.createElement('div'); d.className = 'emoji-opt'; d.textContent = a;
                    d.onclick = () => { this.tmpAv = a; document.getElementById('prevAv').textContent = a; }
                    g.appendChild(d);
                });
            },

            nav(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id+'Screen').classList.add('active'); },
            
            menu() {
                const u = this.db.users[this.db.cur];
                document.getElementById('mName').textContent = u.name;
                document.getElementById('mGold').textContent = u.gold;
                document.getElementById('mLvl').textContent = u.lvl;
                const pct = Math.min(100, (u.xp / (u.lvl*100))*100);
                document.getElementById('mXp').style.width = pct + '%';
                this.nav('menu');
            },

            openChar() {
                const u = this.db.users[this.db.cur];
                document.getElementById('stStr').textContent = u.stats.str;
                document.getElementById('stInt').textContent = u.stats.int;
                document.getElementById('stVit').textContent = u.stats.vit;
                document.getElementById('ptsDisplay').textContent = `Pontos Dispon√≠veis: ${u.stats.pts}`;
                
                const s = this.calcStats();
                document.getElementById('totalStats').innerHTML = `
                Dano: ${s.atk} | Defesa: ${s.def} | Vida: ${s.hp} | Mana: ${s.mp}
                `;
                this.nav('char');
            },

            addStat(s) {
                const u = this.db.users[this.db.cur];
                if(u.stats.pts > 0) {
                    u.stats.pts--; u.stats[s]++;
                    soundSys.playTone(600, 'sine', 0.1); this.save(); this.openChar();
                } else alert('Sem pontos!');
            },

            calcStats() {
                const u = this.db.users[this.db.cur];
                let s = { atk:10, def:5, hp:100, mp:50, int:0 };
                s.atk += (u.stats.str * 2) + (u.lvl * 2);
                s.hp  += (u.stats.vit * 10) + (u.lvl * 20);
                s.mp  += (u.stats.int * 10) + (u.lvl * 10);
                s.int += u.stats.int;
                s.def += Math.floor(u.stats.str / 2) + u.lvl;
                
                u.equip.forEach(id => {
                    let it = this.data.items.find(i=>i.id==id) || this.data.bossDrops.find(i=>i.id==id);
                    if(it) {
                        if(it.atk) s.atk += it.atk; if(it.def) s.def += it.def;
                        if(it.hp) s.hp += it.hp; if(it.int) s.mp += (it.int * 5);
                    }
                });
                return s;
            },

            battleStart() {
                const u = this.db.users[this.db.cur];
                this.st.bNum++; this.st.boss--;
                if(this.st.boss <= 0) this.st.boss = 5;
                const finalStats = this.calcStats();
                this.st.p = { maxHp: finalStats.hp, curHp: finalStats.hp, maxMp: finalStats.mp, curMp: finalStats.mp, atk: finalStats.atk, def: finalStats.def, int: finalStats.int };
                this.st.isBoss = (this.st.boss === 5);
                const elvl = Math.max(1, u.lvl + Math.floor(Math.random()*2));
                const mul = this.st.isBoss ? 2.5 : 1;
                let enemyData = this.st.isBoss ? this.data.bosses[Math.floor(Math.random() * this.data.bosses.length)] : this.data.enemies[Math.floor(Math.random() * this.data.enemies.length)];
                this.st.e = { name: enemyData.n, lvl: elvl, av: enemyData.i, maxHp: Math.floor((80+elvl*20)*mul), curHp: Math.floor((80+elvl*20)*mul), atk: Math.floor((8+elvl*1.5)*mul), def: Math.floor((2+elvl)*mul) };
                this.st.turn = true; this.st.busy = false;
                document.getElementById('pAv').innerHTML = `<span>${u.av}</span>`;
                document.getElementById('eAv').innerHTML = `<span>${this.st.e.av}</span>`;
                document.getElementById('eName').textContent = this.st.e.name;
                document.getElementById('bCount').textContent = this.st.bNum;
                document.getElementById('pLvlDisplay').textContent = 'Lvl ' + u.lvl;
                document.getElementById('eLvlDisplay').textContent = 'Lvl ' + elvl;
                this.upd(); this.nav('battle');
            },

            upd() {
                const p = this.st.p; const e = this.st.e; const u = this.db.users[this.db.cur];
                const set = (id, c, m) => { 
                    const pct = Math.max(0, (c/m)*100);
                    document.getElementById(id+'Bar').style.width = pct+'%'; 
                    if(document.getElementById(id+'Tx')) document.getElementById(id+'Tx').textContent = Math.max(0, Math.floor(c))+'/'+m; 
                };
                set('pHp', p.curHp, p.maxHp); set('pMp', p.curMp, p.maxMp); set('eHp', e.curHp, e.maxHp);
                document.getElementById('qtyHp').textContent = u.inv.hp||0; document.getElementById('qtyMp').textContent = u.inv.mp||0;
                
                const skillKeys = ['normal','fire','ice','thunder','special','ultimate'];
                skillKeys.forEach(k => {
                    const skill = this.data.skills[k];
                    const btn = document.getElementById('btn_'+k);
                    if(u.lvl < skill.req) {
                        btn.disabled = true; btn.innerHTML = `${skill.icon}<br><span class="lock-text">Lvl ${skill.req}</span>`; btn.style.opacity = "0.5"; btn.style.background = "#ccc";
                    } else {
                        btn.innerHTML = `${skill.icon}<small class="attack-cost">${skill.c}</small>`; btn.style.background = "#fff"; btn.style.opacity = "1";
                        if(p.curMp < skill.c) btn.disabled = true; else btn.disabled = false;
                    }
                });
            },

            async atk(k) {
                if(!this.st.turn || this.st.busy) return;
                const s = this.data.skills[k]; const p = this.st.p;
                if(p.curMp < s.c) return;
                this.st.busy = true;
                p.curMp = Math.min(p.maxMp, p.curMp - s.c + s.r);
                soundSys.sfx(s.sfx);
                const e = this.st.e;
                let bonus = (s.c > 0) ? (p.int * 2) : 0; 
                let dmg = Math.max(1, Math.floor(((p.atk + bonus) * s.m) - e.def));
                const crit = Math.random() < 0.2; if(crit) dmg = Math.floor(dmg * 1.5);
                e.curHp -= dmg;
                this.spawnParticles(s.type, 'eAv'); 
                if(s.type === 'thunder') document.getElementById('flashOverlay').classList.add('flash-screen');
                setTimeout(()=>document.getElementById('flashOverlay').classList.remove('flash-screen'), 300);
                this.floatTxt(crit ? 'CRIT -'+dmg : '-'+dmg, 'eAv');
                document.getElementById('bLog').textContent = `Voc√™ usou ${s.n}!`;
                this.upd();
                if(e.curHp <= 0) { await this.wait(1000); this.win(); } else { await this.wait(1000); this.enemyTurn(); }
            },

            async enemyTurn() {
                const p = this.st.p; const e = this.st.e;
                soundSys.sfx('hit');
                let dmg = Math.max(1, Math.floor(e.atk - p.def));
                p.curHp -= dmg;
                this.spawnParticles('blood', 'pAv');
                this.floatTxt('-'+dmg, 'pAv');
                document.getElementById('pAv').classList.add('shake');
                setTimeout(()=>document.getElementById('pAv').classList.remove('shake'), 400);
                this.upd();
                if(p.curHp <= 0) { await this.wait(1000); this.lose(); } else { this.st.turn = true; this.st.busy = false; }
            },

            async usePot(t) {
                if(!this.st.turn || this.st.busy) return;
                const u = this.db.users[this.db.cur]; if(!u.inv[t] || u.inv[t]<=0) return;
                this.st.busy = true; u.inv[t]--; this.save();
                soundSys.playTone(500, 'sine', 0.3);
                const p = this.st.p; const v = 50;
                if(t=='hp') { p.curHp = Math.min(p.maxHp, p.curHp+v); this.floatTxt('+'+v, 'pAv', '#2ecc71'); }
                else { p.curMp = Math.min(p.maxMp, p.curMp+v); this.floatTxt('+'+v, 'pAv', '#3498db'); }
                this.upd(); await this.wait(800); this.enemyTurn();
            },

            win() {
                soundSys.sfx('lvl');
                const u = this.db.users[this.db.cur];
                const xp = 30 + (u.lvl*5); const g = 20 + (u.lvl*2);
                u.xp += xp; u.gold += g;
                let msg = `+${xp} XP | +${g} Ouro`;
                if(this.st.isBoss && Math.random() < 0.6) { 
                    const drop = this.data.bossDrops[Math.floor(Math.random()*this.data.bossDrops.length)];
                    // Agora Drop vai para a BAG, n√£o equipa direto
                    if(!u.bag.includes(drop.id)) {
                        u.bag.push(drop.id);
                        msg += `<br><b style="color:purple">DROP RARO: ${drop.i} ${drop.n}!</b><br><small>Est√° na mochila</small>`;
                    }
                }
                if(u.xp >= u.lvl*100) { u.lvl++; u.xp=0; u.stats.pts += 3; msg += `<br><b style="color:green">LEVEL UP!</b><br>+3 Pontos`; }
                this.save(); this.showMod('VIT√ìRIA!', msg);
            },
            lose() { this.showMod('DERROTA', 'Voc√™ caiu...'); },

            shop() {
                const d = document.getElementById('sGrid'); d.innerHTML = '';
                const u = this.db.users[this.db.cur];
                const frag = document.createDocumentFragment();
                document.getElementById('sGold').textContent = u.gold;
                this.data.items.forEach(it => {
                    const owned = (it.t=='eq' && u.bag.includes(it.id));
                    const el = document.createElement('div'); el.className = 'box-style'; el.style.textAlign='center';
                    
                    let stText = '';
                    if(it.atk) stText += `Atk+${it.atk} `; if(it.def) stText += `Def+${it.def} `; if(it.hp) stText += `HP+${it.hp} `;
                    if(it.t=='pot') stText = 'Recupera 50';

                    el.innerHTML = `<div style="font-size:2em">${it.i}</div><b>${it.n}</b><br><small>${stText}</small><br>
                    <button class="btn" style="padding:5px; margin-top:5px;" onclick="game.buy('${it.id}')" ${owned?'disabled':''}>${owned ? 'J√° possui' : 'üí∞ '+it.p}</button>`;
                    frag.appendChild(el);
                });
                d.appendChild(frag); this.nav('shop');
            },
            
            buy(id) {
                const u = this.db.users[this.db.cur]; const it = this.data.items.find(i=>i.id==id);
                if(u.gold >= it.p) { 
                    u.gold -= it.p; 
                    if(it.t == 'pot') u.inv[id]=(u.inv[id]||0)+1; 
                    else u.bag.push(id); // Adiciona na mochila
                    soundSys.sfx('coin'); this.save(); this.shop(); 
                } else alert('Sem ouro!');
            },
            
            // --- NOVO SISTEMA DE MOCHILA E EQUIPAR ---
            inv() {
                const d = document.getElementById('iGrid'); d.innerHTML = '';
                const u = this.db.users[this.db.cur];
                const frag = document.createDocumentFragment();
                
                // PO√áOES
                ['hp','mp'].forEach(k => { if(u.inv[k]>0) {
                    const el = document.createElement('div'); el.className='item-card';
                    el.innerHTML = `<div style="font-size:2em">${k=='hp'?'üç∑':'üß™'}</div><b>Po√ß√£o</b><small>x${u.inv[k]}</small><div class="item-stats">Recupera 50</div><button class="btn btn-small" disabled>Usar em batalha</button>`;
                    frag.appendChild(el);
                }});

                // EQUIPAMENTOS NA BAG
                u.bag.forEach(id => { 
                    let it=this.data.items.find(i=>i.id==id) || this.data.bossDrops.find(i=>i.id==id);
                    if(it) {
                        const isEquipped = u.equip.includes(id);
                        const el = document.createElement('div'); 
                        el.className = `item-card ${isEquipped ? 'equipped' : ''}`;
                        if(it.id >= 100) el.style.borderColor = 'gold';

                        let stats = '';
                        if(it.atk) stats += `‚öîÔ∏è+${it.atk} `;
                        if(it.def) stats += `üõ°Ô∏è+${it.def} `;
                        if(it.int) stats += `üß†+${it.int} `;
                        if(it.hp) stats += `‚ù§Ô∏è+${it.hp} `;

                        el.innerHTML = `
                            <div style="font-size:2em">${it.i}</div>
                            <b>${it.n}</b>
                            <div class="item-stats">${stats}</div>
                            <button class="btn btn-small ${isEquipped ? 'btn-unequip' : 'btn-equip'}" onclick="game.toggleEquip('${id}')">
                                ${isEquipped ? 'Desequipar' : 'Equipar'}
                            </button>
                        `;
                        frag.appendChild(el);
                    }
                });
                d.appendChild(frag); this.nav('inv');
            },

            toggleEquip(id) {
                const u = this.db.users[this.db.cur];
                // ID vem como string do HTML, converter se necessario (itens data sao int ou string, cuidado)
                // Meus ids de itens normais sao 1,2.. (int), drops 100.. (int)
                // Vou for√ßar compara√ß√£o solta (==)
                
                const equippedIdx = u.equip.findIndex(e => e == id);
                
                if(equippedIdx > -1) {
                    // Desequipar
                    u.equip.splice(equippedIdx, 1);
                } else {
                    // Equipar
                    soundSys.sfx('equip');
                    u.equip.push(parseInt(id));
                }
                this.save();
                this.inv(); // Atualiza tela
            },

            spawnParticles(type, targetId) {
                const target = document.getElementById(targetId);
                const rect = target.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                for(let i=0; i<10; i++) {
                    const p = document.createElement('div'); p.className = `particle p-${type}`;
                    const x = (Math.random() - 0.5) * 80; const y = (Math.random() - 0.5) * 80;
                    p.style.left = (centerX + x) + 'px'; p.style.top = (centerY + y) + 'px';
                    const s = Math.random() * 15 + 5; p.style.width = s + 'px'; p.style.height = s + 'px';
                    p.style.setProperty('--rx', (Math.random()-0.5)*100 + 'px'); p.style.setProperty('--ry', (Math.random()-0.5)*100 + 'px');
                    p.style.setProperty('--rot', Math.random()*360 + 'deg'); p.style.setProperty('--s', Math.random()*2);
                    document.body.appendChild(p); setTimeout(() => p.remove(), 800);
                }
            },
            floatTxt(t, id, c='#e74c3c') {
                const p = document.getElementById(id); const r = p.getBoundingClientRect();
                const d = document.createElement('div'); d.className = 'float-text'; d.textContent = t; d.style.color = c;
                d.style.left = (r.left+20)+'px'; d.style.top = r.top+'px';
                document.body.appendChild(d); setTimeout(()=>d.remove(), 1000);
            },
            showMod(t, b) { document.getElementById('modTitle').innerHTML=t; document.getElementById('modBody').innerHTML=b; document.getElementById('modal').style.display='flex'; },
            closeMod() { document.getElementById('modal').style.display='none'; if(this.st.p.curHp>0) this.battleStart(); else this.menu(); }
        };
        window.onload = ()=>game.init();
    </script>
</body>
</html>
