<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>WDev Legends - UI v9</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f0c29;
            --bg-gradient: linear-gradient(135deg, #0b0b15, #1c1c2e, #0b0b15);
            --primary: #fbbf24;
            --primary-dark: #b45309;
            --accent: #60a5fa;
            --danger: #ef4444;
            --success: #34d399;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            --font-main: 'Fredoka', sans-serif;
            --safe-area-bottom: env(safe-area-inset-bottom, 20px);
            
            --rarity-c: #a1a1aa; 
            --rarity-r: #3b82f6; 
            --rarity-e: #a855f7; 
            --rarity-l: #eab308;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body { 
            font-family: var(--font-main); 
            background: #050505; 
            color: #f3f4f6; 
            height: 100vh; width: 100vw; 
            overflow: hidden; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }

        .bg-fx {
            position: fixed; top:0; left:0; width:100%; height:100%; z-index: -1;
            background: var(--bg-gradient); background-size: 200% 200%;
            animation: gradientBG 15s ease infinite;
        }
        @keyframes gradientBG { 0% {background-position: 0% 50%;} 50% {background-position: 100% 50%;} 100% {background-position: 0% 50%;} }

        #app {
            position: relative; 
            width: 100%; 
            height: 100%; 
            max-width: 450px; 
            max-height: 900px;
            overflow: hidden;
            background: rgba(0,0,0,0.2);
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
        }
        
        @media (min-width: 500px) {
            #app { border-radius: 20px; border: 2px solid rgba(255,255,255,0.1); height: 95vh; }
        }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            padding: 20px; padding-bottom: 90px;
            overflow-y: auto; overflow-x: hidden;
            opacity: 0; pointer-events: none; transform: scale(0.98);
            transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; flex-direction: column; align-items: center;
        }
        .screen.active { opacity: 1; pointer-events: all; transform: scale(1); }

        .panel {
            background: var(--glass); backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border); border-radius: 24px;
            padding: 20px; width: 100%; box-shadow: var(--shadow);
            margin-bottom: 20px; text-align: center; position: relative;
        }

        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 14px;
            font-family: var(--font-main); font-weight: 700; font-size: 1rem;
            color: #3f2e12; cursor: pointer; position: relative;
            background: linear-gradient(to bottom, #fcd34d, #f59e0b);
            box-shadow: 0 4px 0 var(--primary-dark), 0 5px 15px rgba(0,0,0,0.3);
            transition: 0.1s; display: flex; align-items: center; justify-content: center; gap: 8px;
            text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px;
        }
        .btn:active { transform: translateY(4px); box-shadow: 0 0 0 var(--primary-dark); }
        .btn:disabled { filter: grayscale(1) opacity(0.5); pointer-events: none; }
        .btn-red { background: linear-gradient(to bottom, #fca5a5, #ef4444); color: white; box-shadow: 0 4px 0 #991b1b; }
        .btn-red:active { box-shadow: 0 0 0 #991b1b; }
        .btn-blue { background: linear-gradient(to bottom, #93c5fd, #3b82f6); color: white; box-shadow: 0 4px 0 #1e40af; }
        .btn-blue:active { box-shadow: 0 0 0 #1e40af; }
        .btn-green { background: linear-gradient(to bottom, #86efac, #22c55e); color: #064e3b; box-shadow: 0 4px 0 #14532d; }
        .btn-ghost { background: transparent; box-shadow: none; color: #aaa; border: 1px solid rgba(255,255,255,0.2); }
        .btn-link { background: none; border: none; color: #aaa; text-decoration: underline; cursor: pointer; font-size: 0.8rem; margin-top: 10px; box-shadow: none; width: auto; display: inline-block; padding: 5px; }

        input {
            width: 100%; padding: 15px; background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.2); border-radius: 12px;
            color: white; font-family: inherit; margin-bottom: 15px;
            font-size: 1.1rem; text-align: center;
        }

        .wallet-display {
            background: linear-gradient(90deg, #b45309, #fbbf24);
            padding: 5px 15px; border-radius: 20px;
            font-weight: bold; color: #3f2e12;
            display: flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; }
        .shop-card { 
            background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); 
            border-radius: 16px; padding: 15px; display: flex; flex-direction: column; 
            align-items: center; text-align: center; position: relative; overflow: hidden;
            transition: transform 0.2s;
        }
        .shop-card:active { transform: scale(0.98); }
        
        /* Rarity */
        .rarity-c { border-color: var(--rarity-c); }
        .rarity-r { border-color: var(--rarity-r); box-shadow: 0 0 10px rgba(59, 130, 246, 0.1); }
        .rarity-e { border-color: var(--rarity-e); box-shadow: 0 0 15px rgba(168, 85, 247, 0.2); }
        .rarity-l { 
            border-color: var(--rarity-l); 
            box-shadow: 0 0 20px rgba(234, 179, 8, 0.3);
            animation: legendaryPulse 3s infinite alternate;
        }
        @keyframes legendaryPulse { from { box-shadow: 0 0 10px rgba(234, 179, 8, 0.2); } to { box-shadow: 0 0 25px rgba(234, 179, 8, 0.6); border-color: #fff; } }

        /* --- CHARACTER MENU POLISH --- */
        .char-header {
            display: flex; align-items: center; gap: 20px; margin-bottom: 20px;
            background: linear-gradient(90deg, rgba(255,255,255,0.05), transparent);
            padding: 15px; border-radius: 20px; border: 1px solid var(--glass-border);
        }
        .char-avatar { font-size: 3.5rem; filter: drop-shadow(0 0 10px rgba(255,255,255,0.2)); }
        
        .stat-row { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px; background: rgba(0,0,0,0.2); border-radius: 10px; margin-bottom: 8px;
        }
        .stat-name { font-size: 0.9rem; font-weight: bold; color: #ccc; display: flex; align-items: center; gap: 8px; }
        .stat-val-box { display: flex; align-items: center; gap: 10px; }
        .stat-btn { width: 30px; height: 30px; border-radius: 8px; background: var(--accent); color: #fff; border:none; font-weight:bold; cursor: pointer; }
        
        .combat-stats {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0;
        }
        .c-stat { 
            background: rgba(255,255,255,0.03); padding: 10px; border-radius: 12px; 
            text-align: center; border: 1px solid var(--glass-border);
        }
        .c-val { font-size: 1.2rem; font-weight: bold; color: #fff; display: block; }
        .c-label { font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 1px; }

        .scroll-slots { display: flex; justify-content: center; gap: 15px; margin-top: 15px; }
        .scroll-slot {
            width: 70px; height: 70px; border-radius: 15px;
            background: rgba(0,0,0,0.3); border: 2px dashed #444;
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem; cursor: pointer; transition: 0.2s; position: relative;
        }
        .scroll-slot.filled { border-style: solid; border-color: var(--primary); background: rgba(251, 191, 36, 0.1); box-shadow: 0 0 15px rgba(251, 191, 36, 0.2); }

        /* ADVENTURE CARDS */
        .adventure-card {
            width: 100%; background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
            border: 1px solid var(--glass-border); border-radius: 20px; padding: 20px;
            margin-bottom: 15px; cursor: pointer; position: relative; overflow: hidden;
            display: flex; align-items: center; gap: 15px; transition: 0.2s;
        }
        .adventure-card:active { transform: scale(0.98); background: rgba(255,255,255,0.08); }
        .card-forest { border-left: 5px solid var(--success); }
        .card-dungeon { border-left: 5px solid var(--accent); }

        /* PORTAL GRID */
        .dungeon-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; }
        .portal-card {
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
            border-radius: 12px; padding: 15px 5px; text-align: center; cursor: pointer;
        }
        .portal-card.locked { opacity: 0.4; filter: grayscale(1); pointer-events: none; }
        .portal-lvl { font-weight: bold; font-size: 1.1rem; margin-top: 5px; }

        /* BATTLE STUFF */
        .arena {
            width: 100%; height: 280px; position: relative;
            display: flex; justify-content: space-between; align-items: flex-end;
            padding: 20px 30px; margin-bottom: 10px;
        }
        .fighter { display: flex; flex-direction: column; align-items: center; width: 80px; z-index: 5; position: relative; }
        .fighter-emoji { font-size: 4.5rem; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.6)); animation: breathe 3s infinite ease-in-out; }
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03) translateY(-5px); } }
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-6px, 0, 0); } 40%, 60% { transform: translate3d(6px, 0, 0); } }

        .bar-wrap { width: 100%; height: 8px; background: rgba(0,0,0,0.6); border-radius: 10px; overflow: hidden; margin-top: 8px; }
        .bar-fill { height: 100%; transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 10px; }
        .hp-fill { background: linear-gradient(90deg, #ef4444, #b91c1c); box-shadow: 0 0 10px #ef4444; }
        .mp-fill { background: linear-gradient(90deg, #60a5fa, #2563eb); box-shadow: 0 0 10px #60a5fa; }
        .xp-fill { background: linear-gradient(90deg, #34d399, #059669); }

        .battle-log { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; gap: 4px; z-index: 20; align-items: center; width: 200px; pointer-events: none; }
        .log-entry { background: rgba(0,0,0,0.6); border-radius: 12px; padding: 3px 10px; font-size: 0.7rem; color: #eee; border: 1px solid rgba(255,255,255,0.1); }
        .log-entry.crit { color: #fbbf24; border-color: #fbbf24; font-weight: bold; }

        /* --- NEW SKILL BUTTONS (Rounded & Icons) --- */
        .grid-skills { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; }
        
        .skill-btn {
            background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 18px; 
            padding: 10px 5px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; overflow: hidden;
            transition: transform 0.1s, background 0.2s;
            height: 85px; /* Fixed height for consistency */
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        
        .skill-btn:active:not(.disabled) { transform: scale(0.95); background: rgba(255,255,255,0.15); }
        .skill-btn.disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }
        
        .skill-icon { font-size: 2rem; margin-bottom: 5px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        .skill-name { font-size: 0.7rem; font-weight: bold; color: #fff; line-height: 1.2; }
        .skill-cost { font-size: 0.65rem; color: #60a5fa; margin-top: 2px; font-weight: bold; }

        /* INVENTORY (MINECRAFT STYLE) */
        .inv-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; width: 100%; background: rgba(0,0,0,0.3); border-radius: 12px; padding: 10px; }
        .inv-slot { aspect-ratio: 1; background: rgba(255,255,255,0.05); border: 2px solid transparent; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; cursor: pointer; position: relative; transition: 0.1s; }
        .inv-slot:hover { border-color: rgba(255,255,255,0.2); }
        .inv-slot.equipped { border-color: var(--primary); box-shadow: inset 0 0 10px rgba(251,191,36,0.2); }
        .inv-qty { position: absolute; bottom: 1px; right: 2px; font-size: 0.6rem; font-weight: bold; }
        
        /* HUD */
        .top-hud {
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; margin-bottom: 20px;
            background: rgba(0,0,0,0.3); padding: 8px 20px; border-radius: 50px;
            border: 1px solid var(--glass-border); backdrop-filter: blur(10px);
        }

        /* CONTROLS */
        .audio-btn { position: absolute; top: 15px; right: 15px; width: 35px; height: 35px; background: rgba(0,0,0,0.6); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100; border: 1px solid #555; }
        .speed-badge { position: absolute; top: 10px; left: 10px; width: 35px; height: 35px; background: var(--primary); color: #000; font-weight: 900; font-size: 0.8rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 50; border: 2px solid #fff; }
        .auto-indicator { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); background: var(--danger); padding: 2px 10px; border-radius: 10px; font-size: 0.7rem; z-index: 60; animation: pulse 1s infinite; display: none; font-weight: bold; }
        @keyframes pulse { 50% { opacity: 0.5; } }

        /* MODALS */
        .modal-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 200; display: none; align-items: center; justify-content: center; }
        .modal-box { background: #1b1b29; border: 2px solid var(--primary); border-radius: 20px; padding: 20px; width: 85%; max-width: 320px; text-align: center; display: flex; flex-direction: column; gap: 15px; max-height: 80vh; overflow-y: auto; }
        
        /* DOCK */
        .dock { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(20,20,30,0.95); padding: 10px 25px; border-radius: 30px; display: flex; gap: 25px; border: 1px solid rgba(255,255,255,0.1); z-index: 100; width: max-content; }
        .dock.hide { display: none; }
        .dock-icon { font-size: 1.5rem; background: none; border: none; cursor: pointer; opacity: 0.6; transition: 0.2s; }
        .dock-icon.active { opacity: 1; transform: translateY(-5px); color: var(--primary); }

        .list-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; display: flex; align-items: center; gap: 10px; margin-bottom: 5px; cursor: pointer; text-align: left; }
        .particle { position: fixed; pointer-events: none; z-index: 999; border-radius: 50%; }
        .float-txt { position: absolute; font-weight: 900; font-size: 1.5rem; animation: floatUp 0.8s forwards; pointer-events: none; z-index: 10; text-align: center; width: 100px; }
        @keyframes floatUp { to { transform:translateY(-40px); opacity: 0; } }
        
        #errorMsg { color: #ef4444; font-size: 0.8rem; margin-top: 10px; display: none; }

        /* AVATAR GRID */
        .avatar-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; width: 100%; margin: 10px 0; }
        .avatar-opt { background: rgba(255,255,255,0.1); border-radius: 12px; padding: 10px; font-size: 2rem; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .avatar-opt.selected { border-color: var(--primary); background: rgba(251, 191, 36, 0.2); }
    </style>
</head>
<body>

    <div class="bg-fx"></div>
    
    <div id="app">
        <div class="audio-btn" id="muteBtn" onclick="game.audio.toggle()">üîä</div>

        <!-- LOGIN -->
        <div id="loginScreen" class="screen active" style="justify-content: center;">
            <div class="panel">
                <div style="font-size: 4rem; margin-bottom: 10px;">‚öîÔ∏è</div>
                <h1 style="font-size: 2rem; color: var(--primary);">WDev<br>Legends</h1>
                <p style="color:#aaa; margin-bottom: 30px; font-size: 0.8rem;">FINAL UI v9</p>
                <input type="text" id="loginUser" placeholder="Nome do Her√≥i">
                <input type="password" id="loginPass" placeholder="Senha">
                <button class="btn" style="margin-top:15px" id="btnLogin" onclick="game.login()">Jogar Agora</button>
                <div id="errorMsg"></div>
                <button class="btn-link" onclick="game.resetData()">‚ö†Ô∏è Resetar Dados</button>
            </div>
        </div>

        <!-- MENU -->
        <div id="menuScreen" class="screen">
            <div class="top-hud">
                <div style="display:flex; gap:10px; align-items:center;">
                    <span id="homeAv" style="font-size:1.5rem">ü¶∏</span>
                    <b id="homeName">Heroi</b>
                </div>
                <div class="wallet-display">üí∞ <span id="homeGold">0</span></div>
            </div>

            <div class="panel">
                <div style="font-size: 5rem; margin-bottom: 10px;" id="homeBigAv">ü¶∏</div>
                <h2 style="margin-bottom: 5px;">N√≠vel <span id="homeLvl" class="text-gold">1</span></h2>
                <div class="bar-wrap" style="background:#333;"><div id="homeXp" class="bar-fill xp-fill" style="width:0%;"></div></div>
                <div id="homeBoost" style="color:var(--rarity-e); font-size:0.8rem; margin-top:5px; display:none; animation:pulse 1s infinite;">XP x3 ATIVO!</div>
            </div>

            <div style="width:100%; max-width:480px; display:flex; flex-direction:column; gap:15px;">
                <div class="adventure-card card-forest" onclick="game.battle.start('normal')">
                    <div class="adventure-card-icon">üå≤</div>
                    <div class="adventure-card-content">
                        <h3>Explorar Floresta</h3>
                        <p>Ganhe Ouro e XP.</p>
                    </div>
                    <div class="adventure-card-bg">‚öîÔ∏è</div>
                </div>
                <div class="adventure-card card-dungeon" onclick="game.nav('dungeon')">
                    <div class="adventure-card-icon">üè∞</div>
                    <div class="adventure-card-content">
                        <h3>Masmorras</h3>
                        <p>Busque Pergaminhos Raros.</p>
                    </div>
                    <div class="adventure-card-bg">üíÄ</div>
                </div>
                <button class="btn btn-ghost" onclick="game.logout()">Sair do Jogo</button>
            </div>
        </div>

        <!-- BATTLE -->
        <div id="battleScreen" class="screen">
            <div class="arena">
                <div class="speed-badge" id="speedToggle" onclick="game.toggleSpeed()">1x</div>
                <div class="auto-indicator" id="autoInd">AUTO</div>
                <div id="battleLog" class="battle-log"></div>

                <div class="fighter" id="heroFighter">
                    <div class="fighter-lvl" id="bHeroLvl">1</div>
                    <div class="fighter-emoji" id="bHeroAv">ü¶∏</div>
                    <div class="bar-wrap"><div id="bHeroHp" class="bar-fill hp-fill" style="width:100%"></div></div>
                    <div class="bar-wrap" style="height:5px; margin-top:2px"><div id="bHeroMp" class="bar-fill mp-fill" style="width:100%"></div></div>
                </div>
                <div class="fighter" id="enemyFighter">
                    <div class="fighter-lvl" id="bEnemyLvl">1</div>
                    <div class="fighter-emoji" id="bEnemyAv">üê∫</div>
                    <div class="bar-wrap"><div id="bEnemyHp" class="bar-fill hp-fill" style="width:100%"></div></div>
                    <small id="bEnemyName" style="font-weight:bold; margin-top:5px; display:block;">Lobo</small>
                </div>
            </div>
            
            <div class="panel" style="margin-bottom: 100px; padding: 20px;">
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <button class="btn btn-red" style="flex:1; margin:0;" onclick="game.battle.useItem('hp')">üç∑ <span id="bPotHp">0</span></button>
                    <button class="btn btn-blue" style="flex:1; margin:0;" onclick="game.battle.useItem('mp')">üß™ <span id="bPotMp">0</span></button>
                    <button class="btn btn-ghost" style="width:auto; margin:0;" onclick="game.battle.flee()">üè≥Ô∏è</button>
                </div>
                <div class="grid-skills" id="battleSkills"></div>
            </div>
        </div>

        <!-- DUNGEON -->
        <div id="dungeonScreen" class="screen">
            <h2 style="margin-bottom:15px;">Portais (12 Andares)</h2>
            <div id="dungeonList" class="dungeon-grid"></div>
        </div>

        <!-- INV -->
        <div id="invScreen" class="screen"> <div class="top-hud"><h3>Mochila</h3></div> <div id="invList" class="inv-grid"></div> </div>
        
        <!-- SHOP -->
        <div id="shopScreen" class="screen"> 
            <div class="top-hud"><h3>Loja</h3><div class="wallet-display">üí∞ <span id="shopGoldDisplay">0</span></div></div> 
            <div id="shopList" class="shop-grid"></div> 
        </div>
        
        <!-- CHARACTER -->
        <div id="charScreen" class="screen"> 
            <div class="char-header">
                <div class="char-avatar" id="cAvatar">ü¶∏</div>
                <div>
                    <h2 id="cName" style="margin:0;color:var(--primary)">Heroi</h2>
                    <small style="color:#aaa">N√≠vel <span id="cLvl">1</span></small>
                </div>
                <div style="flex:1;text-align:right">
                    <small>Pontos</small><br>
                    <b id="ptsDisplay" style="color:var(--success);font-size:1.5rem">0</b>
                </div>
            </div>

            <div style="width:100%; margin-bottom:15px;">
                <div class="stat-row">
                    <div class="stat-name">üí™ For√ßa <small style="font-weight:normal;color:#666">(Dano/Def)</small></div>
                    <div class="stat-val-box">
                        <b id="valStr">0</b> <button class="stat-btn" onclick="game.char.addStat('str')">+</button>
                    </div>
                </div>
                <div class="stat-row">
                    <div class="stat-name">üß† Mente <small style="font-weight:normal;color:#666">(Mana/Mag)</small></div>
                    <div class="stat-val-box">
                        <b id="valInt">0</b> <button class="stat-btn" onclick="game.char.addStat('int')">+</button>
                    </div>
                </div>
                <div class="stat-row">
                    <div class="stat-name">‚ù§Ô∏è Vida <small style="font-weight:normal;color:#666">(HP Max)</small></div>
                    <div class="stat-val-box">
                        <b id="valVit">0</b> <button class="stat-btn" onclick="game.char.addStat('vit')">+</button>
                    </div>
                </div>
            </div>

            <div class="combat-stats">
                <div class="c-stat"><span class="c-val" id="totalAtk">0</span><span class="c-label">Ataque Total</span></div>
                <div class="c-stat"><span class="c-val" id="totalDef">0</span><span class="c-label">Defesa Total</span></div>
                <div class="c-stat"><span class="c-val text-red" id="totalHp">0</span><span class="c-label">Vida M√°xima</span></div>
                <div class="c-stat"><span class="c-val text-gold" id="totalCrit">0%</span><span class="c-label">Cr√≠tico</span></div>
            </div>

            <h3 style="margin-bottom:10px;">Runas Antigas</h3>
            <div class="scroll-slots">
                <div class="scroll-slot" id="slot0" onclick="game.char.openSlot(0)"></div>
                <div class="scroll-slot" id="slot1" onclick="game.char.openSlot(1)"></div>
                <div class="scroll-slot" id="slot2" onclick="game.char.openSlot(2)"></div>
            </div>
            <div id="setBonus" style="text-align:center; margin-top:10px; color:var(--primary); font-size:0.8rem"></div>
        </div>
    </div>

    <!-- DOCK -->
    <div id="navDock" class="dock hide">
        <button class="dock-icon active" id="nav_menu" onclick="game.nav('menu')">üè†</button>
        <button class="dock-icon" id="nav_char" onclick="game.nav('char')">üë§</button>
        <button class="dock-icon" id="nav_inv" onclick="game.nav('inv')">üéí</button>
        <button class="dock-icon" id="nav_shop" onclick="game.nav('shop')">üõí</button>
    </div>

    <!-- MODALS -->
    <div id="modal" class="modal-overlay">
        <div class="modal-box">
            <h2 id="modalTitle" style="color:var(--primary)">Title</h2>
            <div id="modalBody">Text</div>
            <div id="modalBtns" style="display:flex; gap:10px; justify-content:center;"></div>
        </div>
    </div>

    <div id="confirmModal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="confirmTitle" style="margin-bottom:15px; color:var(--primary);">Confirma√ß√£o</h3>
            <p id="confirmBody" style="margin-bottom:25px; color:#ccc;">Texto</p>
            <div class="modal-actions">
                <button class="btn btn-ghost" onclick="document.getElementById('confirmModal').style.display='none'">Cancelar</button>
                <button class="btn" id="confirmBtnYes">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="createModal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-bottom:10px; color:var(--primary);">Escolha seu Her√≥i</h3>
            <div class="avatar-grid" id="avatarList"></div>
            <button class="btn" onclick="game.createChar()">Iniciar Jornada</button>
        </div>
    </div>

    <div id="scrollModal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-bottom:15px;">Equipar Pergaminho</h3>
            <div id="scrollList" style="max-height:250px; overflow-y:auto; text-align:left; width:100%; padding-right:5px;"></div>
            <div class="modal-actions">
                <button class="btn btn-ghost" onclick="document.getElementById('scrollModal').style.display='none'">Cancelar</button>
                <button class="btn btn-red" onclick="game.char.unequipScroll()">Remover</button>
            </div>
        </div>
    </div>

<script>
// --- GAME DATA ---
const DB_KEY = 'wdev_rpg_inv_v8'; // Using existing key for persistence
const MAX_LEVEL = 80;
const wait = ms => new Promise(r => setTimeout(r, ms / (game.state.speed || 1)));

// AUDIO SYSTEM (SYNTHESIS)
const AudioSys = {
    ctx: null,
    masterGain: null,
    muted: false,
    init() {
        if (this.ctx) return;
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            this.ctx = new AudioContext();
            this.masterGain = this.ctx.createGain();
            this.masterGain.gain.value = 0.3; 
            this.masterGain.connect(this.ctx.destination);
        } catch(e) { console.warn("Audio not supported"); }
    },
    resume() { if (this.ctx && this.ctx.state === 'suspended') this.ctx.resume(); },
    toggle() {
        this.muted = !this.muted;
        document.getElementById('muteBtn').textContent = this.muted ? 'üîá' : 'üîä';
        if (this.ctx) this.masterGain.gain.value = this.muted ? 0 : 0.3;
    },
    playSFX(type) {
        if (!this.ctx || this.muted) return;
        try {
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.connect(gain);
            gain.connect(this.masterGain);
            const now = this.ctx.currentTime;
            
            if (type === 'hit') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.exponentialRampToValueAtTime(0.01, now + 0.1);
                gain.gain.setValueAtTime(1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'magic') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.linearRampToValueAtTime(800, now + 0.3);
                gain.gain.setValueAtTime(0.5, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'win') {
                [523.25, 659.25, 783.99].forEach((freq, i) => {
                    const o = this.ctx.createOscillator();
                    const g = this.ctx.createGain();
                    o.type = 'square'; o.frequency.value = freq;
                    o.connect(g); g.connect(this.masterGain);
                    g.gain.setValueAtTime(0.1, now + i*0.1);
                    g.gain.exponentialRampToValueAtTime(0.01, now + i*0.1 + 0.2);
                    o.start(now + i*0.1); o.stop(now + i*0.1 + 0.2);
                });
            } else if (type === 'ui') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(800, now);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                osc.start(now); osc.stop(now + 0.05);
            }
        } catch(e) {}
    }
};

const DATA = {
    avatars: ['ü¶∏', 'ü•∑', 'üßô', 'üßù', 'üëÆ', 'üßü', 'üßö', 'üßû'],
    items: [
        {id:'hp', n:'Po√ß√£o Vida', p:100, type:'pot', i:'üç∑', desc:'+100 HP'},
        {id:'mp', n:'Po√ß√£o Mana', p:100, type:'pot', i:'üß™', desc:'+50 MP'},
        {id:'xpboost', n:'Po√ß√£o Sabedoria', p:2000, type:'boost', rarity:'e', i:'üè∫', desc:'XP x3 (5 Lutas)'},
        {id:'sw1', n:'Espada Curta', atk:15, p:300, type:'eq', rarity:'c', i:'üó°Ô∏è', desc:'Atk+15'},
        {id:'sh1', n:'Escudo Ferro', def:10, p:300, type:'eq', rarity:'c', i:'üõ°Ô∏è', desc:'Def+10'},
        {id:'ar1', n:'Armadura Leve', def:18, hp:120, p:600, type:'eq', rarity:'r', i:'ü¶∫', desc:'Def+18 HP+120'},
        {id:'st1', n:'Cajado Arcano', atk:20, int:8, p:600, type:'eq', rarity:'r', i:'ü™Ñ', desc:'Atk+20 Int+8'},
        {id:'axe1', n:'Machado √âpico', atk:45, p:1800, type:'eq', rarity:'e', i:'ü™ì', desc:'Atk+45'},
        {id:'helm1', n:'Elmo Dourado', def:30, hp:300, p:2000, type:'eq', rarity:'e', i:'üëë', desc:'Def+30 HP+300'},
        {id:'god_sw', n:'L√¢mina Divina', atk:120, crit:15, p:15000, type:'eq', rarity:'l', i:'‚öîÔ∏è', desc:'Atk+120 Crit+15%'},
        {id:'god_ar', n:'√âgide Imortal', def:80, hp:1000, p:18000, type:'eq', rarity:'l', i:'üõ°Ô∏è', desc:'Def+80 HP+1000'}
    ],
    scrolls: [
        {id:'s_c_atk', n:'Runa de For√ßa', rarity:'c', atk:10, def:0, crit:0, i:'üíé', desc:'Atk +10'},
        {id:'s_r_fire', n:'Runa de Fogo', rarity:'r', atk:25, def:0, crit:5, i:'üî•', t:'fire', desc:'Atk+25 Crit+5%'},
        {id:'s_l_crit', n:'Olho Mortal', rarity:'l', atk:40, def:0, crit:15, i:'üëÅÔ∏è', t:'wind', desc:'Atk+40 Crit+15%'},
        {id:'s_double', n:'Chrono Runa', rarity:'l', atk:15, def:5, crit:5, i:'‚è≥', proc:'double', desc:'20% Chance Turno Extra'}
    ],
    enemies: [{n:'Rato', i:'üêÄ'}, {n:'Morcego', i:'ü¶á'}, {n:'Lobo', i:'üê∫'}, {n:'Bandido', i:'ü•∑'}, {n:'Guarda', i:'üíÇ‚Äç‚ôÇÔ∏è'}],
    bosses: [{n:'Golem', i:'üóø'}, {n:'General', i:'üëπ'}, {n:'Drag√£o', i:'üêâ'}, {n:'Tit√£', i:'ü§ñ'}],
    skills: {
        normal:{n:'Ataque', c:0, m:1, i:'‚öîÔ∏è', type:'phys'}, 
        fire:{n:'Fogo', c:20, m:1.5, i:'üî•', type:'magic', color:'orange'},
        ice:{n:'Gelo', c:30, m:1.8, i:'‚ùÑÔ∏è', type:'magic', color:'cyan'},
        thunder:{n:'Raio', c:40, m:2.2, i:'‚ö°', type:'magic', color:'yellow'},
        special:{n:'Luz', c:50, m:2.5, i:'‚ú®', type:'magic', color:'gold'},
        ultimate:{n:'Meteoro', c:80, m:3.5, i:'‚òÑÔ∏è', type:'magic', color:'red'}
    }
};

const game = {
    db: { users:{}, cur:null },
    state: { inBattle:false, busy:false, speed:1, autoRuns:0, muted:false },

    init() {
        try {
            const s = localStorage.getItem(DB_KEY);
            if(s) this.db = JSON.parse(s);
            if(!this.db) this.db = { users:{}, cur:null };
            if(!this.db.users) this.db.users = {};
        } catch(e) { console.error("Storage Error", e); this.db = { users:{}, cur:null }; }

        if(this.db.cur && this.db.users[this.db.cur]) this.nav('menu');
        
        document.body.addEventListener('click', () => {
            if(!AudioSys.ctx) AudioSys.init();
            if(AudioSys.ctx && AudioSys.ctx.state === 'suspended') AudioSys.ctx.resume();
        }, {once:false});
    },

    save() { try { localStorage.setItem(DB_KEY, JSON.stringify(this.db)); } catch(e) {} },
    resetData() { if(confirm("Apagar TUDO e reiniciar?")) { localStorage.removeItem(DB_KEY); location.reload(); } },
    getU() { return this.db.users[this.db.cur] || {}; },

    login() {
        const u = document.getElementById('loginUser').value.trim();
        const p = document.getElementById('loginPass').value.trim();
        if(!u || !p) { game.ui.showModal("Erro", "Digite nome e senha."); return; }
        
        AudioSys.init(); AudioSys.resume();

        if(!this.db.users[u]) {
            this.state.tempChar = { u, p };
            game.ui.openAvatarSelect();
        } else {
            if(this.db.users[u].pass === p) {
                this.db.cur = u;
                const usr = this.db.users[u];
                if(!usr.scrollSlots) usr.scrollSlots=[null,null,null];
                if(usr.xpBoost===undefined) usr.xpBoost=0;
                if(!usr.dungeonMax) usr.dungeonMax=1;
                this.save();
                this.nav('menu');
            } else game.ui.showModal("Acesso Negado", "Senha incorreta!");
        }
    },

    createChar() {
        const d = this.state.tempChar;
        const av = document.querySelector('.avatar-opt.selected')?.textContent || 'ü¶∏';
        this.db.users[d.u] = { 
            pass:d.p, name:d.u, av:av, lvl:1, xp:0, gold:100, 
            inv:{hp:2,mp:1}, bag:[], equip:[], scrolls:[], 
            scrollSlots:[null,null,null], stats:{str:1,int:1,vit:1,pts:0}, 
            dungeonMax:1, xpBoost:0 
        };
        this.db.cur = d.u; 
        this.save(); 
        document.getElementById('createModal').style.display='none'; 
        this.nav('menu');
    },

    logout() { this.db.cur = null; location.reload(); },

    nav(id) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById(id+'Screen').classList.add('active');
        
        const dock = document.getElementById('navDock');
        if(id !== 'login' && id !== 'battle') {
            dock.classList.remove('hide');
            document.querySelectorAll('.dock-icon').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById('nav_'+id);
            if(btn) btn.classList.add('active');
        } else dock.classList.add('hide');

        if(id === 'menu') game.ui.renderHome();
        if(id === 'shop') game.ui.renderShop();
        if(id === 'inv') game.ui.renderInv();
        if(id === 'char') game.char.render();
        if(id === 'dungeon') game.ui.renderDungeon();
    },

    toggleSpeed() {
        const u = game.getU();
        let max = 3; if(u.lvl>=10) max=4; if(u.lvl>=20) max=5;
        this.state.speed = (this.state.speed >= max) ? 1 : this.state.speed+1;
        document.getElementById('speedToggle').textContent = this.state.speed+'x';
        game.ui.floatText('hero', `Speed ${this.state.speed}x`, '#fff');
    },

    startAutoFarm() {
        this.state.autoRuns = 5;
        this.state.speed = (game.getU().lvl>=20) ? 5 : 3;
        document.getElementById('speedToggle').textContent = this.state.speed+'x';
        game.ui.closeModal();
        game.battle.start('dungeon', this.state.lvl);
    },

    battle: {
        async start(mode, lvl) {
            const u = game.getU();
            game.state.mode = mode; game.state.lvl = lvl; game.state.inBattle = true; game.state.busy = false;
            document.getElementById('battleLog').innerHTML = '';
            document.getElementById('autoInd').style.display = game.state.autoRuns > 0 ? 'block' : 'none';
            if(game.state.autoRuns > 0) {
                document.getElementById('autoInd').textContent = `AUTO: ${game.state.autoRuns}`;
                setTimeout(() => game.battle.autoLoop(), 1000/game.state.speed);
            }
            const st = game.calcStats();
            game.state.p = { ...st.s, curHp:st.s.hp, curMp:st.s.mp, maxHp:st.s.hp, maxMp:st.s.mp };
            
            let eData, mult = 1, eLvl = 1;
            if(mode==='dungeon') {
                eData = DATA.bosses[(lvl-1) % DATA.bosses.length]; eLvl = lvl*2; mult = 1.8 + (lvl*0.5);
            } else {
                eData = DATA.enemies[Math.floor(Math.random()*DATA.enemies.length)]; 
                eLvl = Math.max(1, u.lvl + Math.floor(Math.random()*2)); 
                mult = 1 + (u.lvl * 0.15);
            }
            game.state.e = { 
                name:eData.n, av:eData.i, lvl:eLvl, 
                maxHp: Math.floor((100+lvl*20)*mult) || 100, 
                curHp: Math.floor((100+lvl*20)*mult) || 100,
                atk: Math.floor((10+lvl*2)*mult) || 10, 
                def: Math.floor((2+lvl)*mult) || 2
            };

            document.getElementById('bHeroAv').textContent = u.av; document.getElementById('bHeroLvl').textContent = u.lvl;
            document.getElementById('bEnemyAv').textContent = game.state.e.av; document.getElementById('bEnemyName').textContent = game.state.e.name; document.getElementById('bEnemyLvl').textContent = game.state.e.lvl;
            game.ui.renderBattleSkills(); game.ui.updateBattleBars(); game.nav('battle'); game.ui.log('Luta!', 'turn-hero');
        },
        autoLoop() {
            if(!game.state.inBattle) return;
            const mp = game.state.p.curMp; let skill = 'normal';
            if(mp >= 80) skill='ultimate'; else if(mp >= 50) skill='special'; else if(mp >= 20) skill='fire';
            game.battle.turn(skill).then(() => { if(game.state.inBattle && game.state.autoRuns>0) setTimeout(() => game.battle.autoLoop(), 1500/game.state.speed); });
        },
        async turn(type) {
            if(game.state.busy) return; game.state.busy = true;
            const p = game.state.p, e = game.state.e, skill = DATA.skills[type];

            if(p.curMp < skill.c) {
                if(game.state.autoRuns>0) type='normal';
                else { game.ui.floatText('hero', 'Sem Mana!', '#60a5fa'); game.state.busy=false; return; }
            }
            if(type!=='normal') p.curMp -= skill.c;
            
            game.ui.updateBattleBars(); game.ui.log('Atacou', 'turn-hero'); AudioSys.playSFX(skill.type==='phys'?'hit':'magic');

            const hEl = document.getElementById('heroFighter'), eEl = document.getElementById('enemyFighter');
            hEl.style.transform = 'scale(1.2)'; setTimeout(()=>hEl.style.transform='scale(1)', 200);

            // DAMAGE CALC
            let str = Number(game.getU().stats.str) || 1;
            let critChance = (str * 0.01) + ((p.crit||0)/100);
            let isCrit = Math.random() < critChance;
            
            let pAtk = Number(p.atk) || 10;
            let pInt = Number(p.int) || 1;
            let skillM = Number(skill.m) || 1;
            
            let dmg = ( pAtk + (skill.c>0 ? pInt*2 : 0) ) * skillM;
            if(isCrit) { dmg *= 1.5; game.ui.log('CRIT!', 'crit'); }
            
            let eDef = Number(e.def) || 0;
            let finalDmg = Math.max(1, Math.floor(dmg - (eDef * 0.6)));
            
            e.curHp -= finalDmg;

            const eRect = eEl.getBoundingClientRect();
            game.ui.spawnParticles(eRect.left+20, eRect.top+20, skill.type==='phys'?'#ef4444':(skill.color||'#fff'), skill.type==='phys'?'blood':'magic');

            eEl.classList.add('shake'); game.ui.floatText('enemy', finalDmg, isCrit?'gold':'white'); 
            game.ui.updateBattleBars();
            await new Promise(r => setTimeout(r, 400/game.state.speed)); eEl.classList.remove('shake');

            if(game.getU().scrollSlots.includes('s_double') && Math.random()<0.2 && e.curHp>0) {
                game.ui.floatText('hero', 'TURNO EXTRA!', 'gold'); await new Promise(r=>setTimeout(r,500/game.state.speed)); game.state.busy=false; return;
            }

            if(e.curHp <= 0) { this.end(true); return; }

            await new Promise(r => setTimeout(r, 500/game.state.speed));
            game.ui.log('Defenda!', 'turn-enemy'); AudioSys.playSFX('hit');
            let eAtk = Number(e.atk) || 10;
            let eDmg = Math.max(1, Math.floor(eAtk - ((p.def||0)*0.6)));
            p.curHp -= eDmg;
            hEl.classList.add('shake'); game.ui.floatText('hero', `-${eDmg}`, 'red');
            game.ui.updateBattleBars(); 
            await new Promise(r => setTimeout(r, 400/game.state.speed)); hEl.classList.remove('shake');

            if(p.curHp <= 0) this.end(false); else game.state.busy = false;
        },
        async useItem(t) {
            if(game.state.busy) return; const u = game.getU();
            if(u.inv[t]>0) {
                u.inv[t]--; AudioSys.playSFX('magic');
                if(t==='hp') game.state.p.curHp = Math.min(game.state.p.maxHp, game.state.p.curHp+100);
                else game.state.p.curMp = Math.min(game.state.p.maxMp, game.state.p.curMp+50);
                game.save(); game.ui.updateBattleBars(); game.state.busy=true; 
                await new Promise(r => setTimeout(r, 600/game.state.speed));
                let eDmg = Math.max(1, Math.floor((game.state.e.atk||10) - ((game.state.p.def||0)*0.6)));
                game.state.p.curHp -= eDmg;
                document.getElementById('heroFighter').classList.add('shake'); game.ui.floatText('hero', `-${eDmg}`, 'red');
                game.ui.updateBattleBars(); await wait(400); document.getElementById('heroFighter').classList.remove('shake');
                if(game.state.p.curHp <= 0) this.end(false); else game.state.busy=false;
            } else game.ui.floatText('hero', 'Vazio!', 'gray');
        },
        flee() { if(game.state.busy) return; if(game.state.autoRuns>0) { game.state.autoRuns=0; game.state.inBattle=false; game.nav('menu'); } else game.ui.showModal('Fugir', 'Sair da batalha?', false, true); },
        end(win) {
            game.state.inBattle = false;
            if(win) {
                AudioSys.playSFX('win'); const u = game.getU();
                let xp = game.state.mode==='dungeon' ? 200*game.state.lvl : 30+(u.lvl*2);
                let gold = game.state.mode==='dungeon' ? 150*game.state.lvl : 20+(u.lvl);
                if(u.xpBoost > 0) { xp*=3; u.xpBoost--; }
                u.xp += xp; u.gold += gold;
                let msg = `+${gold} Gold | +${xp} XP`;
                if(u.xpBoost > 0) msg += `<br><small style="color:violet">XP x3! (${u.xpBoost} left)</small>`;
                if(game.state.mode==='dungeon' && game.state.lvl === u.dungeonMax && u.dungeonMax < 12) u.dungeonMax++;
                if(u.xp >= u.lvl*100 && u.lvl < MAX_LEVEL) { u.lvl++; u.xp=0; u.stats.pts+=3; u.inv.hp+=1; msg += '<br>LEVEL UP!'; }
                if(game.state.mode==='dungeon' && Math.random() < 0.45) {
                   const floor = game.state.lvl;
                   const possible = DATA.scrolls.filter(s => s.proc ? floor>=1 : (s.rarity==='l' ? floor>=10 : (s.rarity==='r' ? floor>=6 : true)));
                   if(possible.length) { const sc = possible[Math.floor(Math.random()*possible.length)]; u.scrolls.push(sc.id); msg += `<br>Drop: <span style="color:cyan">${sc.n}</span>`; }
                }
                game.save();
                if(game.state.autoRuns > 0) { game.state.autoRuns--; if(game.state.autoRuns > 0) { setTimeout(()=>game.battle.start(game.state.mode, game.state.lvl), 1000); return; } }
                game.ui.showModal("VIT√ìRIA", msg, true);
            } else {
                game.state.autoRuns = 0; game.ui.showModal("DERROTA", "Tente novamente.", false); game.nav('menu');
            }
        }
    },

    calcStats() {
        const u = game.getU();
        const str = Number(u.stats.str) || 1;
        const vit = Number(u.stats.vit) || 1;
        const int = Number(u.stats.int) || 1;
        const lvl = Number(u.lvl) || 1;

        let s = { atk:10, def:5, hp:200, mp:50, int:0, crit:0 };
        s.atk += (str * 4) + (lvl * 2); 
        s.hp += (vit * 25) + (lvl * 20); 
        s.mp += (int * 15) + (lvl * 5); 
        s.def += Math.floor(str / 2) + lvl; 
        s.int = int;

        u.equip.forEach(eid => { 
            let it = DATA.items.find(x => x.id === eid); 
            if(it) { 
                if(it.atk) s.atk += (it.atk||0); 
                if(it.def) s.def += (it.def||0); 
                if(it.hp) s.hp += (it.hp||0); 
                if(it.int) s.mp += (it.int||0)*5; 
                if(it.crit) s.crit += (it.crit||0); 
            } 
        });

        u.scrollSlots.forEach(sid => { 
            if(sid) { 
                let sc = DATA.scrolls.find(x => x.id === sid); 
                if(sc) { 
                    if(sc.atk) s.atk += (sc.atk||0); 
                    if(sc.def) s.def += (sc.def||0); 
                    if(sc.crit) s.crit += (sc.crit||0); 
                    if(sc.hp) s.hp += (sc.hp||0); 
                } 
            } 
        });
        return {s, sets:{}};
    },

    // --- UI ---
    char: {
        render() {
            const u = game.getU(); const st = game.calcStats().s;
            document.getElementById('cName').textContent = u.name; 
            document.getElementById('cAvatar').textContent = u.av;
            document.getElementById('cLvl').textContent = u.lvl;

            document.getElementById('ptsDisplay').textContent = u.stats.pts;
            ['str','int','vit'].forEach(k => document.getElementById('val'+(k.charAt(0).toUpperCase()+k.slice(1))).textContent = u.stats[k]);
            
            document.getElementById('totalAtk').textContent = st.atk;
            document.getElementById('totalDef').textContent = st.def;
            document.getElementById('totalHp').textContent = st.hp;
            document.getElementById('totalCrit').textContent = st.crit + '%';

            u.scrollSlots.forEach((sid, i) => {
                const el = document.getElementById('slot'+i);
                if(sid) { const s = DATA.scrolls.find(x=>x.id===sid); el.innerHTML = s ? s.i : '?'; el.className = 'scroll-slot filled'; }
                else { el.innerHTML = ''; el.className = 'scroll-slot'; }
            });
        },
        addStat(s) { const u = game.getU(); if(u.stats.pts>0) { u.stats.pts--; u.stats[s]++; game.save(); this.render(); } },
        openSlot(i) {
            game.state.tempSlot = i; const list = document.getElementById('scrollList'); list.innerHTML='';
            const counts = {}; game.getU().scrolls.forEach(id => counts[id] = (counts[id]||0)+1);
            game.getU().scrollSlots.forEach(id => { if(id && counts[id]) counts[id]--; });
            
            let has = false;
            Object.keys(counts).forEach(id => {
                if(counts[id] > 0) {
                    has = true; const s = DATA.scrolls.find(x=>x.id===id);
                    const d = document.createElement('div'); d.className='scroll-item-row';
                    const col = s.rarity === 'l' ? 'scroll-rarity-l' : (s.rarity === 'r' ? 'scroll-rarity-r' : 'scroll-rarity-c');
                    d.innerHTML = `<div class="scroll-item-icon">${s.i}</div><div class="scroll-item-info"><div style="font-weight:bold" class="${col}">${s.n} <small style="color:#fff">x${counts[id]}</small></div><div class="scroll-stats">Atk:${s.atk} Def:${s.def} Crit:${s.crit}%</div></div>`;
                    d.onclick = () => { game.getU().scrollSlots[i]=id; game.save(); document.getElementById('scrollModal').style.display='none'; game.char.render(); };
                    list.appendChild(d);
                }
            });
            if(!has) list.innerHTML = '<p style="padding:10px">Sem pergaminhos.</p>';
            document.getElementById('scrollModal').style.display='flex';
        },
        unequipScroll() { game.getU().scrollSlots[game.state.tempSlot] = null; game.save(); document.getElementById('scrollModal').style.display='none'; game.char.render(); }
    },

    ui: {
        renderHome() {
            const u = game.getU(); 
            document.getElementById('homeName').textContent = u.name; 
            document.getElementById('homeLvl').textContent = u.lvl; 
            document.getElementById('homeGold').textContent = u.gold;
            document.getElementById('homeAv').textContent = u.av;
            document.getElementById('homeBigAv').textContent = u.av;
            document.getElementById('homeXp').style.width = Math.min(100, (u.xp / (u.lvl*100))*100) + '%';
            document.getElementById('homeBoost').style.display = u.xpBoost > 0 ? 'block' : 'none';
            if(u.xpBoost) document.getElementById('homeBoost').textContent = `XP x3 (${u.xpBoost} Lutas)`;
        },
        renderDungeon() {
            const u = game.getU(); const list = document.getElementById('dungeonList'); list.innerHTML = '';
            const max = u.dungeonMax || 1;
            for(let i=1; i<=12; i++) {
                const locked = i > max;
                const boss = DATA.bosses[(i-1)%DATA.bosses.length];
                const card = document.createElement('div'); card.className = `dungeon-item ${locked?'locked':'unlocked'}`;
                card.innerHTML = `<div style="display:flex;align-items:center;gap:10px;"><span style="font-size:1.5rem">${locked?'üîí':'üö™'}</span><div style="text-align:left;"><div>Andar ${i}</div><div style="font-size:0.7rem;opacity:0.7">Boss: ${boss.n}</div></div></div>`;
                if(!locked) { 
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-blue';
                    btn.style.width = 'auto'; btn.style.margin = '0'; btn.style.padding = '5px 15px';
                    btn.textContent = 'Ir';
                    btn.onclick = (e) => { e.stopPropagation(); game.battle.start('dungeon', i); };
                    card.appendChild(btn);
                    card.onclick = () => game.battle.start('dungeon', i);
                }
                list.appendChild(card);
            }
        },
        renderShop() {
            const u = game.getU(); document.getElementById('shopGoldDisplay').textContent = u.gold; const list = document.getElementById('shopList'); list.innerHTML='';
            DATA.items.forEach(it => {
                const owned = it.type==='eq' && u.bag.includes(it.id);
                const el = document.createElement('div'); el.className='shop-card';
                el.style.borderColor = it.rarity==='l' ? 'gold' : (it.rarity==='e'?'violet':(it.rarity==='r'?'cyan':'#444'));
                el.innerHTML = `<div class="shop-card-icon">${it.i}</div><div class="shop-card-title">${it.n}</div><div class="shop-card-desc">${it.desc}</div><button class="btn ${owned?'btn-ghost':'btn-green'}" onclick="game.ui.buy('${it.id}')" ${owned?'disabled':''}>${owned?'OK':it.p}</button>`;
                list.appendChild(el);
            });
        },
        buy(id) {
            const u = game.getU(); const it = DATA.items.find(x=>x.id===id);
            if(u.gold >= it.p) {
                u.gold -= it.p;
                if(it.type==='boost') { if(!u.inv[id]) u.bag.push(id); else this.showModal("Aviso", "J√° possui!"); }
                else if(it.type==='pot') u.inv[id] = (u.inv[id]||0)+1;
                else u.bag.push(id);
                game.save(); this.renderShop();
            } else this.showModal("Loja", "Sem ouro!");
        },
        renderInv() {
            const u = game.getU(); const list = document.getElementById('invList'); list.innerHTML='';
            let items = [];
            // Group 1: Potions
            if(u.inv.hp > 0) items.push({id:'hp', i:'üç∑', n:'Vida', q:u.inv.hp});
            if(u.inv.mp > 0) items.push({id:'mp', i:'üß™', n:'Mana', q:u.inv.mp});
            // Group 2: Boosts
            u.bag.forEach(bid => { 
                const it = DATA.items.find(x=>x.id===bid);
                if(it && it.type==='boost') items.push({...it, q:1});
            });
            // Group 3: Gear
            u.bag.forEach(bid => { 
                const it = DATA.items.find(x=>x.id===bid);
                if(it && it.type!=='boost') items.push({...it, q:1});
            });
            
            for(let i=0; i<25; i++) {
                const it = items[i]; const d = document.createElement('div'); 
                d.className = 'inv-slot ' + (it ? (u.equip.includes(it.id)?'equipped':'') : 'empty');
                if(it && it.rarity) d.classList.add('rarity-'+it.rarity);
                if(it) {
                    d.innerHTML = `<div>${it.i}</div><div class="inv-qty">${it.q}</div>`;
                    d.onclick = () => {
                        if(it.id==='xpboost') {
                             const idx = u.bag.indexOf('xpboost');
                             if(idx>-1) { u.bag.splice(idx,1); u.xpBoost = 5; game.save(); game.ui.renderInv(); game.ui.showModal("Boost", "XP Triplo Ativado!"); }
                        } else if(it.type==='eq') {
                            const eqIdx = u.equip.indexOf(it.id);
                            if(eqIdx>-1) u.equip.splice(eqIdx,1); else u.equip.push(it.id);
                            game.save(); game.ui.renderInv();
                        }
                    };
                }
                list.appendChild(d);
            }
        },
        renderBattleSkills() {
            const box = document.getElementById('battleSkills'); 
            box.innerHTML = ''; 
            const u = game.getU(); 
            const mp = game.state.p.curMp;
            
            Object.keys(DATA.skills).forEach(k => {
                const s = DATA.skills[k];
                if(u.lvl < 2 && k !== 'normal') return;
                if(u.lvl < 3 && (k === 'ice' || k === 'thunder')) return;
                if(u.lvl < 5 && (k === 'special' || k === 'ultimate')) return;
                
                const cant = mp < s.c;
                const btn = document.createElement('div'); 
                btn.className = `skill-btn ${cant ? 'disabled' : ''}`;
                
                let costHtml = s.c > 0 ? `<div class="skill-cost">${s.c} MP</div>` : '<div class="skill-cost" style="opacity:0">-</div>';
                btn.innerHTML = `<div class="skill-icon">${s.i}</div><div class="skill-name">${s.n}</div>${costHtml}`;
                
                if(!cant) btn.onclick = () => game.battle.turn(k);
                
                box.appendChild(btn);
            });
        },
        updateBattleBars() {
            const p=game.state.p, e=game.state.e;
            const pPct = Math.max(0, (p.curHp/(p.maxHp||1))*100) || 0;
            const mpPct = Math.max(0, (p.curMp/(p.maxMp||1))*100) || 0;
            const ePct = Math.max(0, (e.curHp/(e.maxHp||1))*100) || 0;
            document.getElementById('bHeroHp').style.width = pPct+'%';
            document.getElementById('bHeroMp').style.width = mpPct+'%';
            document.getElementById('bEnemyHp').style.width = ePct+'%';
            document.getElementById('bPotHp').textContent = game.getU().inv.hp||0;
            document.getElementById('bPotMp').textContent = game.getU().inv.mp||0;
        },
        floatText(t, txt, c) { const box = document.getElementById(t==='hero'?'heroFighter':'enemyFighter'); const el = document.createElement('div'); el.className='float-txt'; el.textContent=txt; el.style.color=c; box.appendChild(el); setTimeout(() => el.remove(), 800/game.state.speed); },
        log(t, cl) { const b = document.getElementById('battleLog'); const d = document.createElement('div'); d.className='log-entry '+cl; d.textContent=t; b.appendChild(d); if(b.children.length>2) b.removeChild(b.firstChild); setTimeout(()=>d.remove(), 1500); },
        showModal(title, body, isWin, isFlee) {
            const m = document.getElementById('modal'); 
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = body;
            const b = document.getElementById('modalBtns'); b.innerHTML = '';
            
            if(isFlee) {
                b.innerHTML = `<button class="btn btn-red" onclick="game.state.inBattle=false;game.nav('menu');document.getElementById('modal').style.display='none'">Sim</button><button class="btn" onclick="document.getElementById('modal').style.display='none'">N√£o</button>`;
            } else if(isWin && game.state.mode==='dungeon') {
                b.innerHTML = `<button class="btn btn-blue" onclick="game.startAutoFarm()">‚ö° Farm x5</button><button class="btn" onclick="game.ui.closeModal()">OK</button>`;
            } else {
                b.innerHTML = `<button class="btn" onclick="game.ui.closeModal()">OK</button>`;
            }
            m.style.display = 'flex';
        },
        openAvatarSelect() {
            const box = document.getElementById('avatarList'); box.innerHTML = '';
            DATA.avatars.forEach((av, idx) => { const el = document.createElement('div'); el.className = 'avatar-opt ' + (idx===0?'selected':''); el.textContent = av; el.onclick = () => { document.querySelectorAll('.avatar-opt').forEach(x=>x.classList.remove('selected')); el.classList.add('selected'); }; box.appendChild(el); });
            document.getElementById('createModal').style.display = 'flex';
        },
        spawnParticles(x,y,c,t) {
            const count = t==='magic'?30:10;
            for(let i=0;i<count;i++) {
                const el = document.createElement('div'); el.className='particle'; el.style.background=c; el.style.left=x+'px'; el.style.top=y+'px';
                el.style.width = (Math.random()*6+2)+'px'; el.style.height = el.style.width;
                const a = Math.random()*Math.PI*2, v = Math.random()*60+20;
                el.style.setProperty('--tx', Math.cos(a)*v+'px'); el.style.setProperty('--ty', Math.sin(a)*v+'px');
                el.style.animation = `floatUp 0.5s forwards`; 
                document.body.appendChild(el); setTimeout(()=>el.remove(), 600);
            }
        },
        closeModal() { document.getElementById('modal').style.display='none'; if(!game.state.inBattle) game.nav('menu'); }
    }
};

window.onload = () => game.init();
</script>
</body>
</html>

