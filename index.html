<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Battle Arena V9 (Final Fix)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Verdana', sans-serif;
            background: #1a0f0a;
            background-image: radial-gradient(circle, #2c1810 10%, transparent 10%);
            background-size: 20px 20px;
            color: #f4e4c1;
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
        }
        .container { max-width: 600px; margin: 0 auto; padding: 10px; position: relative; }

        /* UI GERAL */
        .box-style {
            background: #f4e4c1;
            border: 4px solid #5c3317;
            border-radius: 8px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            padding: 20px; margin-bottom: 20px; color: #2c1810; position: relative;
        }
        .btn {
            width: 100%; padding: 15px;
            background: linear-gradient(180deg, #8b5a2b 0%, #5c3317 100%);
            border: 2px solid #3d2212; border-radius: 6px;
            color: #fff; font-weight: bold; font-size: 1rem;
            text-transform: uppercase; cursor: pointer;
            box-shadow: 0 4px 0 #3d2212; margin-top: 10px;
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-weight: bold; color: #5c3317; margin-bottom: 5px; }
        .input-group input { width: 100%; padding: 10px; border: 2px solid #8b5a2b; border-radius: 4px; }

        /* AVATAR E INFO */
        .character { display: flex; flex-direction: column; align-items: center; position: relative; width: 45%; }
        .character-avatar {
            width: 110px; height: 110px;
            border-radius: 20px; border: 5px solid #5c3317;
            background: linear-gradient(135deg, #fff5e6, #ffdbb3);
            display: flex; align-items: center; justify-content: center;
            font-size: 4em; position: relative; z-index: 1;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); overflow: hidden;
            transition: transform 0.1s;
        }
        .char-level { 
            background: #5c3317; color: #fff; padding: 2px 8px; 
            border-radius: 10px; font-size: 0.7em; margin-top: -10px; 
            z-index: 2; position: relative; border: 1px solid #f4e4c1;
        }

        /* BARRAS */
        .bars-container { position: absolute; top: -35px; left: 50%; transform: translateX(-50%); width: 100%; max-width: 120px; z-index: 10; }
        .bar-wrap { width: 100%; background: #222; border: 2px solid #5c3317; border-radius: 4px; height: 18px; position: relative; margin-bottom: 2px; }
        .mp-bar-wrap { height: 8px; }
        .bar-fill { height: 100%; transition: width 0.2s; } 
        .hp-fill { background: #e74c3c; } .mp-fill { background: #3498db; }
        .hp-text { position: absolute; width: 100%; text-align: center; top: 0; font-size: 0.7em; color: #fff; line-height: 16px; text-shadow: 1px 1px 0 #000; }

        /* BATALHA */
        .battle-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .speed-btn {
            background: #fff; border: 2px solid #5c3317; padding: 5px 10px;
            border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.8em;
        }
        .speed-btn.active { background: #f1c40f; color: #5c3317; }

        .battle-arena { display: flex; justify-content: space-between; align-items: flex-end; margin: 30px 0; min-height: 160px; }
        
        .attack-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 15px; }
        .attack-btn {
            background: #fff; border: 2px solid #5c3317; border-radius: 8px;
            padding: 10px 0; font-size: 1.5em; cursor: pointer;
            display: flex; flex-direction: column; align-items: center;
        }
        .attack-btn:active { transform: translateY(2px); }
        .attack-btn:disabled { opacity: 0.5; filter: grayscale(1); }
        .attack-cost { font-size: 0.3em; background: #3498db; color: #fff; padding: 2px; border-radius: 4px; margin-top: 2px; }

        .potion-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .potion-btn { flex: 1; padding: 8px; border: 2px solid #8b5a2b; background: #fff; border-radius: 6px; font-weight: bold; cursor: pointer; }

        /* --- SISTEMA DE PART√çCULAS REALISTAS V2 --- */
        .particle { position: absolute; pointer-events: none; z-index: 100; }

        /* Fogo V2: Sobe oscilando */
        .p-fire { 
            background: radial-gradient(circle, #ffaa00, #ff4500); 
            border-radius: 50%; 
            animation: fireRise 0.8s forwards; 
        }
        @keyframes fireRise {
            0% { opacity: 1; transform: scale(1) translate(0, 0); }
            100% { opacity: 0; transform: scale(3) translate(var(--rx), -60px); }
        }

        /* Gelo V2: Cristais caindo */
        .p-ice { 
            background: rgba(200, 255, 255, 0.8);
            border: 1px solid #fff;
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
            animation: iceFall 0.8s forwards;
        }
        @keyframes iceFall {
            0% { opacity: 1; transform: translate(0, 0) rotate(0deg); }
            100% { opacity: 0; transform: translate(var(--rx), 80px) rotate(360deg); }
        }

        /* Sangue V2: Espirro direcional */
        .p-blood { 
            background: #8a0b0b; 
            border-radius: 50%;
            animation: bloodSplat 0.4s forwards;
        }
        @keyframes bloodSplat {
            0% { transform: scale(0.5) translate(0, 0); }
            100% { opacity: 0; transform: scale(var(--s)) translate(var(--rx), var(--ry)); }
        }

        /* Raio V2: Fa√≠scas r√°pidas */
        .p-thunder {
            background: #ffff00;
            width: 2px !important;
            height: 10px !important;
            animation: spark 0.3s forwards;
        }
        @keyframes spark {
            0% { opacity:1; transform: translate(0,0) rotate(var(--rot)); }
            100% { opacity:0; transform: translate(var(--rx), var(--ry)) rotate(var(--rot)); }
        }

        /* Flash de Tela */
        .flash-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: #fff; opacity:0; pointer-events: none; z-index: 999; animation: flash 0.1s; }
        @keyframes flash { 0% { opacity: 0.6; } 100% { opacity: 0; } }

        /* Tremores */
        .shake { animation: shake 0.4s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* Texto Flutuante */
        .float-text { position: fixed; font-size: 2em; font-weight: 900; color: #e74c3c; text-shadow: 2px 2px 0 #fff; animation: float 0.8s forwards; pointer-events: none; z-index: 200; }
        @keyframes float { to { transform: translateY(-60px); opacity: 0; } }

        /* UTILIT√ÅRIOS */
        .screen { display: none; }
        .screen.active { display: block; animation: fade 0.3s; }
        @keyframes fade { from { opacity:0; } to { opacity:1; } }
        
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; z-index:2000; }
        
        /* CORRE√á√ÉO DO MODAL: Cor for√ßada para #2c1810 */
        .modal-box { 
            background: #f4e4c1; 
            color: #2c1810; /* CORRIGIDO AQUI */
            padding: 20px; 
            border: 4px solid #5c3317; 
            border-radius: 10px; 
            text-align: center; 
            width: 90%; 
            max-width: 350px; 
        }
        
        .emoji-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; }
        .emoji-opt { font-size: 2em; padding: 5px; border: 1px solid #999; border-radius: 5px; text-align: center; cursor: pointer; background: #fff; }
        .emoji-opt.selected { background: #ffdbb3; border-color: #5c3317; }
        
        .xp-container { background: #ccc; height: 10px; border: 1px solid #5c3317; margin-top: 5px; border-radius: 4px; }
        .xp-bar { height: 100%; background: orange; width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>
    <div id="flashOverlay" class=""></div> <div class="container">
        <div id="loginScreen" class="screen active">
            <div class="box-style">
                <h1 style="text-align: center;">‚öîÔ∏è RPG TURBO</h1>
                <div class="input-group"><label>Nick</label><input type="text" id="loginUser"></div>
                <div class="input-group"><label>Senha</label><input type="password" id="loginPass"></div>
                <button class="btn" onclick="game.login()">Jogar</button>
                <div style="text-align:center; margin-top:10px;"><small onclick="game.resetAll()" style="color:red; cursor:pointer;">[Resetar Tudo]</small></div>
            </div>
        </div>

        <div id="createScreen" class="screen">
            <div class="box-style">
                <h2 style="text-align:center;">Criar Her√≥i</h2>
                <div class="character-avatar" style="margin:10px auto;"><span id="prevAv">ü¶∏</span></div>
                <input type="text" id="newame" placeholder="Nome" style="width:100%; padding:10px; margin-bottom:10px;">
                <div class="emoji-grid" id="gridAv"></div>
                <button class="btn" onclick="game.create()">Salvar</button>
            </div>
        </div>

        <div id="menuScreen" class="screen">
            <div class="box-style">
                <div style="display:flex; justify-content:space-between; font-weight:bold; border-bottom:2px solid #5c3317; padding-bottom:10px;">
                    <span id="mName">Nome</span><span>üí∞ <span id="mGold">0</span></span>
                </div>
                <div style="margin-top:10px;">Lvl <span id="mLvl">1</span><div class="xp-container"><div class="xp-bar" id="mXp"></div></div></div>
                <button class="btn" onclick="game.battleStart()">‚öîÔ∏è Batalhar</button>
                <button class="btn" onclick="game.shop()">üõí Loja</button>
                <button class="btn" onclick="game.inv()">üéí Mochila</button>
                <button class="btn" style="background:#c0392b" onclick="game.logout()">Sair</button>
            </div>
        </div>

        <div id="battleScreen" class="screen">
            <div class="box-style">
                <div class="battle-header">
                    <b>Luta: <span id="bCount">1</span></b>
                    <div>
                        <button id="speedBtn" class="speed-btn" onclick="game.toggleSpeed()">1x</button>
                        <button class="speed-btn" onclick="game.menu()">Fugir</button>
                    </div>
                </div>
                
                <div class="battle-arena">
                    <div class="character">
                        <div class="bars-container">
                            <div class="bar-wrap"><div class="bar-fill hp-fill" id="pHpBar"></div><div class="hp-text" id="pHpTx"></div></div>
                            <div class="bar-wrap mp-bar-wrap"><div class="bar-fill mp-fill" id="pMpBar"></div></div>
                        </div>
                        <div class="character-avatar" id="pAv"><span>ü¶∏</span></div>
                        <div class="char-level" id="pLvlDisplay">Lvl 1</div>
                        <b>Voc√™</b>
                    </div>
                    
                    <div style="font-size:2em; font-weight:bold; color:#c0392b;">VS</div>
                    
                    <div class="character">
                        <div class="bars-container">
                            <div class="bar-wrap"><div class="bar-fill hp-fill" id="eHpBar"></div><div class="hp-text" id="eHpTx"></div></div>
                        </div>
                        <div class="character-avatar" id="eAv"><span>üëπ</span></div>
                        <div class="char-level" id="eLvlDisplay">Lvl 1</div>
                        <b id="eName">Monstro</b>
                    </div>
                </div>

                <div class="potion-row">
                    <button class="potion-btn" id="btnPotHp" onclick="game.usePot('hp')">üç∑ HP: <span id="qtyHp">0</span></button>
                    <button class="potion-btn" id="btnPotMp" onclick="game.usePot('mp')">üß™ MP: <span id="qtyMp">0</span></button>
                </div>

                <div id="bLog" style="background:#eee; padding:5px; text-align:center; margin-bottom:5px; font-size:0.8em; border-radius:4px;">Iniciando...</div>

                <div class="attack-grid">
                    <button class="attack-btn" onclick="game.atk('normal')">‚öîÔ∏è</button>
                    <button class="attack-btn" onclick="game.atk('fire')">üî•<small class="attack-cost">20</small></button>
                    <button class="attack-btn" onclick="game.atk('ice')" id="btIce">‚ùÑÔ∏è<small class="attack-cost">30</small></button>
                    <button class="attack-btn" onclick="game.atk('thunder')" id="btThun">‚ö°<small class="attack-cost">40</small></button>
                    <button class="attack-btn" onclick="game.atk('special')" id="btSpec">‚ú®<small class="attack-cost">50</small></button>
                    <button class="attack-btn" onclick="game.atk('ultimate')" id="btUlt">üí•<small class="attack-cost">80</small></button>
                </div>
            </div>
        </div>

        <div id="shopScreen" class="screen">
            <div class="box-style">
                <h3>Loja (üí∞ <span id="sGold">0</span>)</h3>
                <div id="sGrid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;"></div>
                <button class="btn" onclick="game.menu()">Voltar</button>
            </div>
        </div>

        <div id="invScreen" class="screen">
            <div class="box-style">
                <h3>Mochila</h3>
                <div id="iGrid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;"></div>
                <button class="btn" onclick="game.menu()">Voltar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="modal-box">
            <h2 id="modTitle">TITULO</h2>
            <div id="modBody" style="margin:15px 0; font-size:1.2em;">Texto</div>
            <button class="btn" onclick="game.closeMod()">Continuar</button>
        </div>
    </div>

    <script>
        const KEY = 'rpg_v9_fix';
        
        const game = {
            db: { users: {}, cur: null },
            st: { p: {}, e: {}, turn: true, busy: false, bNum: 0, boss: 5 },
            speed: 1, 
            
            data: {
                skills: {
                    normal: { n:'Corte', m:1, c:0, r:15, type:'blood' },
                    fire:   { n:'Fogo', m:1.5, c:20, r:0, type:'fire' },
                    ice:    { n:'Gelo', m:1.7, c:30, r:0, type:'ice' },
                    thunder:{ n:'Raio', m:2.0, c:40, r:0, type:'thunder' },
                    special:{ n:'Luz', m:2.5, c:50, r:0, type:'fire' },
                    ultimate:{ n:'Meteoro', m:3.5, c:80, r:0, type:'fire' }
                },
                items: [
                    {id:'hp', n:'Po√ß√£o Vida', i:'üç∑', p:50, t:'pot'},
                    {id:'mp', n:'Po√ß√£o Mana', i:'üß™', p:50, t:'pot'},
                    {id:1, n:'Espada', i:'üó°Ô∏è', atk:5, p:100, t:'eq'},
                    {id:2, n:'Escudo', i:'üõ°Ô∏è', def:5, p:100, t:'eq'},
                    {id:3, n:'Cajado', i:'ü™Ñ', atk:15, p:400, t:'eq'},
                    {id:4, n:'Armadura', i:'ü¶∫', def:15, p:400, t:'eq'}
                ],
                avs: ['ü¶∏','ü•∑','üßô','üßõ','üßü','üßö','üßú','üßû','ü¶π','ü§ñ']
            },
            tmpAv: 'ü¶∏',

            init() {
                try {
                    const s = localStorage.getItem(KEY);
                    if(s) this.db = JSON.parse(s);
                } catch(e) { console.error(e); }
                this.rendAv();
            },
            save() { localStorage.setItem(KEY, JSON.stringify(this.db)); },
            resetAll() { if(confirm('Resetar tudo?')) { localStorage.removeItem(KEY); location.reload(); } },
            
            wait(ms) { return new Promise(r => setTimeout(r, ms * this.speed)); },
            toggleSpeed() {
                this.speed = this.speed === 1 ? 0.5 : 1;
                const btn = document.getElementById('speedBtn');
                btn.textContent = this.speed === 1 ? '1x' : '2x';
                btn.classList.toggle('active');
            },

            // --- USER ---
            login() {
                const u = document.getElementById('loginUser').value.trim();
                const p = document.getElementById('loginPass').value.trim();
                if(!u || !p) return alert('Preencha tudo!');
                if(!this.db.users[u]) {
                    if(confirm('Criar conta?')) {
                        this.db.users[u] = { pass: p, ok: false };
                        this.db.cur = u; this.nav('create');
                    }
                } else {
                    if(this.db.users[u].pass === p) {
                        this.db.cur = u;
                        this.fixData(this.db.users[u]);
                        if(this.db.users[u].ok) this.menu(); else this.nav('create');
                    } else alert('Senha errada!');
                }
            },
            fixData(user) {
                if(!user.inv) user.inv = { hp:1, mp:1 };
                if(!user.equip) user.equip = [];
                if(!user.gold) user.gold = 0;
            },
            create() {
                const n = document.getElementById('newame').value.trim() || 'Heroi';
                const u = this.db.users[this.db.cur];
                u.name = n; u.av = this.tmpAv; u.lvl = 1; u.xp = 0; u.gold = 100;
                u.inv = { hp:2, mp:2 }; u.equip = []; u.ok = true;
                this.save(); this.menu();
            },
            rendAv() {
                const g = document.getElementById('gridAv'); g.innerHTML = '';
                this.data.avs.forEach(a => {
                    const d = document.createElement('div'); d.className = 'emoji-opt'; d.textContent = a;
                    d.onclick = () => { this.tmpAv = a; document.getElementById('prevAv').textContent = a; }
                    g.appendChild(d);
                });
            },
            nav(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id+'Screen').classList.add('active'); },
            logout() { this.db.cur = null; document.getElementById('loginUser').value=''; document.getElementById('loginPass').value=''; this.nav('login'); },

            // --- MENU ---
            menu() {
                const u = this.db.users[this.db.cur];
                document.getElementById('mName').textContent = u.name;
                document.getElementById('mGold').textContent = u.gold;
                document.getElementById('mLvl').textContent = u.lvl;
                const pct = Math.min(100, (u.xp / (u.lvl*100))*100);
                document.getElementById('mXp').style.width = pct + '%';
                this.nav('menu');
            },

            // --- BATALHA ---
            battleStart() {
                try {
                    const u = this.db.users[this.db.cur];
                    this.st.bNum++; this.st.boss--;
                    if(this.st.boss <= 0) this.st.boss = 5;

                    let ba=0, bd=0;
                    u.equip.forEach(id => { const it=this.data.items.find(i=>i.id==id); if(it){ if(it.atk) ba+=it.atk; if(it.def) bd+=it.def; } });

                    this.st.p = {
                        maxHp: 100+(u.lvl*20), curHp: 100+(u.lvl*20),
                        maxMp: 50+(u.lvl*10), curMp: 50+(u.lvl*10),
                        atk: 10+(u.lvl*2)+ba, def: 5+u.lvl+bd
                    };

                    const isBoss = this.st.boss === 5;
                    const elvl = Math.max(1, u.lvl + Math.floor(Math.random()*2));
                    const mul = isBoss ? 2.5 : 1;

                    this.st.e = {
                        name: isBoss ? 'BOSS SUPREMO' : 'Monstro',
                        lvl: elvl,
                        av: isBoss ? 'üê≤' : ['üëπ','üë∫','üëª'][Math.floor(Math.random()*3)],
                        maxHp: Math.floor((80+elvl*20)*mul), curHp: Math.floor((80+elvl*20)*mul),
                        atk: Math.floor((8+elvl*1.5)*mul), def: Math.floor((2+elvl)*mul)
                    };

                    this.st.turn = true; this.st.busy = false;

                    // UI Update
                    document.getElementById('pAv').innerHTML = `<span>${u.av}</span>`;
                    document.getElementById('eAv').innerHTML = `<span>${this.st.e.av}</span>`;
                    document.getElementById('eName').textContent = this.st.e.name;
                    document.getElementById('bCount').textContent = this.st.bNum;
                    document.getElementById('pLvlDisplay').textContent = 'Lvl ' + u.lvl;
                    document.getElementById('eLvlDisplay').textContent = 'Lvl ' + elvl;
                    
                    this.upd();
                    this.nav('battle');
                } catch(e) { alert('Erro: ' + e); this.menu(); }
            },

            upd() {
                const p = this.st.p; const e = this.st.e; const u = this.db.users[this.db.cur];
                const set = (id, c, m) => { document.getElementById(id+'Bar').style.width = Math.max(0,(c/m)*100)+'%'; if(document.getElementById(id+'Tx')) document.getElementById(id+'Tx').textContent = Math.floor(c)+'/'+m; };
                set('pHp', p.curHp, p.maxHp); set('pMp', p.curMp, p.maxMp); set('eHp', e.curHp, e.maxHp);
                document.getElementById('qtyHp').textContent = u.inv.hp||0;
                document.getElementById('qtyMp').textContent = u.inv.mp||0;
                
                const chk = (id, lvl, c) => document.getElementById(id).disabled = (u.lvl<lvl || p.curMp<c);
                chk('btIce',2,30); chk('btThun',5,40); chk('btSpec',8,50); chk('btUlt',15,80);
            },

            async atk(k) {
                if(!this.st.turn || this.st.busy) return;
                const s = this.data.skills[k];
                const p = this.st.p;
                if(p.curMp < s.c) return;

                this.st.busy = true;
                p.curMp = Math.min(p.maxMp, p.curMp - s.c + s.r);
                
                const e = this.st.e;
                let dmg = Math.max(1, Math.floor((p.atk * s.m) - e.def));
                const crit = Math.random() < 0.2;
                if(crit) dmg = Math.floor(dmg * 1.5);
                e.curHp -= dmg;

                // VFX
                this.spawnParticles(s.type, 'eAv'); 
                if(s.type === 'thunder') document.getElementById('flashOverlay').classList.add('flash-screen');
                setTimeout(()=>document.getElementById('flashOverlay').classList.remove('flash-screen'), 300);
                
                this.floatTxt(crit ? 'CRIT -'+dmg : '-'+dmg, 'eAv');
                document.getElementById('bLog').textContent = `Voc√™ usou ${s.n}!`;
                
                this.upd();

                if(e.curHp <= 0) {
                    await this.wait(1000); this.win();
                } else {
                    await this.wait(1000); this.enemyTurn();
                }
            },

            async enemyTurn() {
                const p = this.st.p; const e = this.st.e;
                let dmg = Math.max(1, Math.floor(e.atk - p.def));
                p.curHp -= dmg;
                
                this.spawnParticles('blood', 'pAv');
                this.floatTxt('-'+dmg, 'pAv');
                document.getElementById('pAv').classList.add('shake');
                setTimeout(()=>document.getElementById('pAv').classList.remove('shake'), 400);
                
                this.upd();

                if(p.curHp <= 0) {
                    await this.wait(1000); this.lose();
                } else {
                    this.st.turn = true; this.st.busy = false;
                }
            },

            async usePot(t) {
                if(!this.st.turn || this.st.busy) return;
                const u = this.db.users[this.db.cur];
                if(!u.inv[t] || u.inv[t]<=0) return;
                
                this.st.busy = true; u.inv[t]--; this.save();
                const p = this.st.p;
                const v = 50;
                
                if(t=='hp') { p.curHp = Math.min(p.maxHp, p.curHp+v); this.floatTxt('+'+v, 'pAv', '#2ecc71'); }
                else { p.curMp = Math.min(p.maxMp, p.curMp+v); this.floatTxt('+'+v, 'pAv', '#3498db'); }
                
                this.upd();
                await this.wait(800); this.enemyTurn();
            },

            win() {
                const u = this.db.users[this.db.cur];
                const xp = 30 + (u.lvl*5); const g = 20 + (u.lvl*2);
                u.xp += xp; u.gold += g;
                let msg = `+${xp} XP | +${g} Ouro`;
                if(u.xp >= u.lvl*100) { u.lvl++; u.xp=0; msg += `<br><b style="color:green">LEVEL UP!</b>`; }
                this.save(); this.showMod('VIT√ìRIA!', msg);
            },
            lose() { this.showMod('DERROTA', 'Voc√™ caiu...'); },

            // --- LOJA & INV ---
            shop() {
                const d = document.getElementById('sGrid'); d.innerHTML = '';
                const u = this.db.users[this.db.cur];
                document.getElementById('sGold').textContent = u.gold;
                this.data.items.forEach(it => {
                    const has = u.equip.includes(it.id);
                    const el = document.createElement('div'); el.className = 'box-style'; el.style.textAlign='center';
                    el.innerHTML = `<div style="font-size:2em">${it.i}</div><b>${it.n}</b><br><small>${it.atk?'‚öîÔ∏è+'+it.atk:(it.def?'üõ°Ô∏è+'+it.def:'Rec 50')}</small><br>
                    <button class="btn" style="padding:5px; margin-top:5px;" onclick="game.buy('${it.id}')" ${has && it.t=='eq'?'disabled':''}>${has && it.t=='eq' ? 'Comprado' : 'üí∞ '+it.p}</button>`;
                    d.appendChild(el);
                });
                this.nav('shop');
            },
            buy(id) {
                const u = this.db.users[this.db.cur]; const it = this.data.items.find(i=>i.id==id);
                if(u.gold >= it.p) { u.gold -= it.p; if(it.t == 'pot') u.inv[id]=(u.inv[id]||0)+1; else u.equip.push(id); this.save(); this.shop(); } else alert('Sem ouro!');
            },
            inv() {
                const d = document.getElementById('iGrid'); d.innerHTML = '';
                const u = this.db.users[this.db.cur];
                ['hp','mp'].forEach(k => { if(u.inv[k]>0) d.innerHTML += `<div class="box-style" style="text-align:center"><div style="font-size:2em">${k=='hp'?'üç∑':'üß™'}</div><b>Po√ß√£o</b><br>x${u.inv[k]}</div>`; });
                u.equip.forEach(id => { const it=this.data.items.find(i=>i.id==id); if(it) d.innerHTML += `<div class="box-style" style="text-align:center; border-color:gold"><div style="font-size:2em">${it.i}</div><b>${it.n}</b><br>Equipado</div>`; });
                this.nav('inv');
            },

            // --- FX SYSTEM (PARTICULAS CSS) ---
            spawnParticles(type, targetId) {
                const target = document.getElementById(targetId);
                const rect = target.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                // Criar 10 part√≠culas
                for(let i=0; i<10; i++) {
                    const p = document.createElement('div');
                    p.className = `particle p-${type}`;
                    
                    // Dispers√£o aleat√≥ria
                    const x = (Math.random() - 0.5) * 80;
                    const y = (Math.random() - 0.5) * 80;
                    
                    p.style.left = (centerX + x) + 'px';
                    p.style.top = (centerY + y) + 'px';
                    
                    // Tamanhos variados
                    const s = Math.random() * 15 + 5;
                    p.style.width = s + 'px';
                    p.style.height = s + 'px';
                    
                    // Variaveis CSS para anima√ß√£o
                    p.style.setProperty('--rx', (Math.random()-0.5)*100 + 'px');
                    p.style.setProperty('--ry', (Math.random()-0.5)*100 + 'px');
                    p.style.setProperty('--rot', Math.random()*360 + 'deg');
                    p.style.setProperty('--s', Math.random()*2);
                    
                    document.body.appendChild(p);
                    setTimeout(() => p.remove(), 800);
                }
            },

            floatTxt(t, id, c='#e74c3c') {
                const p = document.getElementById(id); const r = p.getBoundingClientRect();
                const d = document.createElement('div'); d.className = 'float-text'; d.textContent = t; d.style.color = c;
                d.style.left = (r.left+20)+'px'; d.style.top = r.top+'px';
                document.body.appendChild(d); setTimeout(()=>d.remove(), 1000);
            },
            showMod(t, b) { document.getElementById('modTitle').innerHTML=t; document.getElementById('modBody').innerHTML=b; document.getElementById('modal').style.display='flex'; },
            closeMod() { document.getElementById('modal').style.display='none'; if(this.st.p.curHp>0) this.battleStart(); else this.menu(); }
        };
        window.onload = ()=>game.init();
    </script>
</body>
</html>
