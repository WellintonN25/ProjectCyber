<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WDev Legends - Hero's Journey</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e24;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            
            --primary: #f39c12;   /* Laranja Ouro */
            --accent: #3498db;    /* Azul Mana */
            --danger: #e74c3c;    /* Vermelho Vida */
            --success: #27ae60;   /* Verde Sucesso */
            --rare: #9b59b6;      /* Roxo Raro */
            --border: #333;
        }

        body.day { --bg-color: #f0f4f8; --card-bg: #ffffff; --text-main: #2c3e50; --border: #dde1e7; background-image: radial-gradient(#dfe6e9 1px, transparent 1px); }
        body.night { --bg-color: #1a0f0a; --card-bg: #2d2420; --text-main: #ecf0f1; --border: #4a3b32; background-image: radial-gradient(#3d3d3d 1px, transparent 1px); }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, sans-serif;
            background-color: var(--bg-color);
            background-size: 20px 20px;
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
            transition: background 0.5s ease;
        }

        .container { max-width: 500px; margin: 0 auto; padding: 15px; position: relative; min-height: 100vh; display: flex; flex-direction: column; justify-content: center; }

        /* ESTILO DOS CARDS (Refinado) */
        .box-style {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            padding: 24px;
            margin-bottom: 20px;
            position: relative;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* BOT√ïES MODERNOS */
        .btn {
            width: 100%; padding: 16px;
            border: none; border-radius: 12px;
            font-weight: 700; font-size: 1rem;
            cursor: pointer; transition: transform 0.1s, filter 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            background: var(--primary); color: #fff;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }
        
        /* Variantes de Bot√£o */
        .btn-battle { background: linear-gradient(135deg, #e67e22, #d35400); }
        .btn-dungeon { background: linear-gradient(135deg, #8e44ad, #2c3e50); }
        .btn-management { background: linear-gradient(135deg, #3498db, #2980b9); }
        .btn-shop { background: linear-gradient(135deg, #f1c40f, #f39c12); color: #444; }
        .btn-danger { background: var(--danger); }
        .btn-small { padding: 6px 12px; font-size: 0.85em; width: auto; border-radius: 8px; }

        /* INPUTS LIMPOS */
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; font-size: 0.85em; color: var(--text-muted); margin-bottom: 5px; font-weight: 600; }
        .input-group input {
            width: 100%; padding: 12px;
            border: 2px solid var(--border);
            background: rgba(0,0,0,0.05);
            border-radius: 10px; color: var(--text-main);
            font-size: 1em; transition: border 0.3s;
        }
        .input-group input:focus { border-color: var(--primary); background: transparent; }

        /* LOGIN SCREEN ESPEC√çFICO */
        .login-brand { text-align: center; margin-bottom: 30px; }
        .login-logo { font-size: 4em; display: block; margin-bottom: 10px; text-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .login-title { font-size: 1.8em; font-weight: 800; color: var(--primary); }
        .login-subtitle { font-size: 0.9em; color: var(--text-muted); }

        /* MENU PRINCIPAL GRID */
        .hero-summary {
            display: flex; align-items: center; gap: 15px;
            border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 20px;
        }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
        .menu-grid .btn { flex-direction: column; padding: 20px 10px; font-size: 0.9em; }
        .menu-grid .btn span { font-size: 1.8em; margin-bottom: 5px; }

        /* AVATAR & BARS */
        .character-avatar {
            width: 80px; height: 80px; border-radius: 20px;
            background: linear-gradient(135deg, #ecf0f1, #bdc3c7);
            display: flex; align-items: center; justify-content: center;
            font-size: 3em; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            position: relative; border: 3px solid var(--border);
        }
        .mini-stats { flex: 1; }
        .stat-badge { background: rgba(0,0,0,0.05); padding: 4px 8px; border-radius: 6px; font-size: 0.8em; font-weight: bold; display: inline-block; margin-right: 5px; }
        
        .xp-container { background: rgba(0,0,0,0.1); height: 8px; border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .xp-bar { height: 100%; background: linear-gradient(90deg, #f1c40f, #e67e22); width: 0%; transition: width 0.5s ease; }

        /* BATALHA */
        .battle-arena { display: flex; justify-content: space-between; align-items: flex-end; margin: 30px 0; min-height: 150px; position: relative; }
        .bars-container { width: 100%; max-width: 100px; margin-bottom: 10px; }
        .bar-wrap { background: #333; height: 10px; border-radius: 5px; overflow: hidden; margin-bottom: 3px; position: relative; }
        .bar-fill { height: 100%; transition: width 0.3s; }
        .hp-fill { background: #e74c3c; } .mp-fill { background: #3498db; }
        
        .attack-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
        .attack-btn {
            background: var(--card-bg); border: 1px solid var(--border);
            border-radius: 12px; padding: 15px 0; font-size: 1.5em;
            cursor: pointer; display: flex; flex-direction: column; align-items: center;
            transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .attack-btn:active { transform: scale(0.95); }
        .attack-cost { font-size: 0.35em; background: var(--accent); color: #fff; padding: 2px 6px; border-radius: 10px; margin-top: 5px; font-weight: bold; font-family: sans-serif;}
        .lock-text { font-size: 0.4em; color: var(--text-muted); margin-top: 5px; }

        /* PARTICULAS E EFEITOS (Mantidos e suavizados) */
        .flash-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: #fff; opacity:0; pointer-events: none; z-index: 999; animation: flash 0.1s; }
        @keyframes flash { 0% { opacity: 0.6; } 100% { opacity: 0; } }
        .shake { animation: shake 0.4s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .float-text { position: fixed; font-size: 1.5em; font-weight: 900; color: #e74c3c; text-shadow: 1px 1px 0 #fff; animation: float 0.8s forwards; pointer-events: none; z-index: 200; }
        @keyframes float { to { transform: translateY(-50px); opacity: 0; } }

        /* OUTROS ELEMENTOS */
        .screen { display: none; }
        .screen.active { display: block; }
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); display:none; align-items:center; justify-content:center; z-index:2000; backdrop-filter: blur(5px); }
        .modal-box { background: var(--card-bg); color: var(--text-main); padding: 30px; border-radius: 20px; text-align: center; width: 90%; max-width: 350px; border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        
        .emoji-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; max-height: 250px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.03); border-radius: 12px; }
        .emoji-opt { font-size: 2em; padding: 10px; border-radius: 12px; text-align: center; cursor: pointer; background: var(--card-bg); border: 1px solid var(--border); }
        .emoji-opt.selected { background: #ffeaa7; border-color: #f39c12; transform: scale(1.1); }
        
        /* INVENTARIO E LOJA */
        .item-card { display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); border-radius: 12px; padding: 12px; background: var(--card-bg); margin-bottom: 8px; }
        .item-card.equipped { border: 2px solid var(--success); background: rgba(39, 174, 96, 0.1); }
        
        .scroll-slots { display: flex; justify-content: space-between; margin: 15px 0; background: rgba(0,0,0,0.05); padding: 15px; border-radius: 12px; }
        .scroll-slot { width: 55px; height: 55px; border: 2px dashed var(--border); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.8em; cursor: pointer; position: relative; background: var(--card-bg);}
        .scroll-slot.filled { border-style: solid; border-color: var(--primary); }

        .dungeon-btn { margin-bottom: 10px; text-align: left; padding: 20px; display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); color: var(--text-main); border: 1px solid var(--border); }
        
        .music-control { position: fixed; top: 15px; right: 15px; width: 40px; height: 40px; background: rgba(0,0,0,0.6); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #fff; z-index: 1000; }
    </style>
</head>
<body class="day">
    <audio id="bgm" loop><source src="https://cdn.pixabay.com/download/audio/2022/11/22/audio_febc508520.mp3?filename=technology-126236.mp3" type="audio/mpeg"></audio>
    <div class="music-control" onclick="game.toggleMusic()" id="musicIcon">üîá</div>
    <div id="flashOverlay" class=""></div>

    <div class="container">
        <div id="loginScreen" class="screen active">
            <div class="box-style">
                <div class="login-brand">
                    <div class="login-logo">‚öîÔ∏è</div>
                    <div class="login-title">WDev Legends</div>
                    <div class="login-subtitle">A Jornada do Her√≥i</div>
                </div>
                
                <div class="input-group">
                    <label>Aventureiro</label>
                    <input type="text" id="loginUser" placeholder="Seu nome...">
                </div>
                <div class="input-group">
                    <label>Palavra-Passe</label>
                    <input type="password" id="loginPass" placeholder="Sua senha...">
                </div>
                <button class="btn btn-battle" onclick="game.login()">Iniciar Aventura</button>
            </div>
            <p style="text-align: center; font-size: 0.8em; opacity: 0.7; margin-top: 20px;">v3.0 - Edi√ß√£o Definitiva</p>
        </div>

        <div id="createScreen" class="screen">
            <div class="box-style">
                <h2 style="text-align:center; margin-bottom: 20px;">Criar Novo Her√≥i</h2>
                <div class="character-avatar" style="margin:10px auto;"><span id="prevAv">ü¶∏</span></div>
                <div class="input-group">
                    <label>Nome do Her√≥i</label>
                    <input type="text" id="newame" placeholder="Ex: Arthur">
                </div>
                <p style="text-align:center;font-size:0.9em; margin-bottom:10px;">Escolha seu Avatar:</p>
                <div class="emoji-grid" id="gridAv"></div>
                <button class="btn btn-success" style="margin-top:20px; background: var(--success);" onclick="game.create()">Salvar & Come√ßar</button>
            </div>
        </div>

        <div id="menuScreen" class="screen">
            <div class="box-style">
                <div class="hero-summary">
                    <div class="character-avatar" style="width: 60px; height: 60px; font-size: 2.5em;"><span id="mAv">ü¶∏</span></div>
                    <div class="mini-stats">
                        <div style="font-size: 1.2em; font-weight: bold;" id="mName">Nome</div>
                        <span class="stat-badge">Lvl <span id="mLvl">1</span></span>
                        <span class="stat-badge" style="color: gold;">üí∞ <span id="mGold">0</span></span>
                        <div class="xp-container"><div class="xp-bar" id="mXp"></div></div>
                    </div>
                </div>

                <div class="menu-grid">
                    <button class="btn btn-battle" onclick="game.battleStart('normal')">
                        <span>‚öîÔ∏è</span>Explorar
                    </button>
                    <button class="btn btn-dungeon" onclick="game.nav('dungeon')">
                        <span>üè∞</span>Masmorras
                    </button>
                    <button class="btn btn-management" onclick="game.openChar()">
                        <span>üë§</span>Her√≥i
                    </button>
                    <button class="btn btn-management" onclick="game.inv()">
                        <span>üéí</span>Mochila
                    </button>
                    <button class="btn btn-shop" onclick="game.shop()">
                        <span>üõí</span>Mercado
                    </button>
                    <button class="btn btn-danger" onclick="game.logout()">
                        <span>üö™</span>Sair
                    </button>
                </div>
            </div>
        </div>

        <div id="dungeonScreen" class="screen">
            <div class="box-style">
                <h3 style="margin-bottom:15px;">üè∞ Selecione a Masmorra</h3>
                <div id="dungeonList"></div>
                <button class="btn" style="margin-top:15px; background:transparent; color:var(--text-main); border:1px solid var(--border);" onclick="game.menu()">Voltar</button>
            </div>
        </div>

        <div id="charScreen" class="screen">
            <div class="box-style">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>Atributos</h3>
                    <div class="points-avail" id="ptsDisplay" style="background:var(--primary); color:#fff; padding:5px 10px; border-radius:10px; font-size:0.8em;">Pontos: 0</div>
                </div>
                
                <div style="margin-top: 15px;">
                    <div class="item-card"><span>üí™ For√ßa</span><div><strong id="stStr" style="margin-right:10px">1</strong><button class="btn btn-small btn-success" onclick="game.addStat('str')">+</button></div></div>
                    <div class="item-card"><span>üß† Intelig√™ncia</span><div><strong id="stInt" style="margin-right:10px">1</strong><button class="btn btn-small btn-success" onclick="game.addStat('int')">+</button></div></div>
                    <div class="item-card"><span>‚ù§Ô∏è Vitalidade</span><div><strong id="stVit" style="margin-right:10px">1</strong><button class="btn btn-small btn-success" onclick="game.addStat('vit')">+</button></div></div>
                </div>
                
                <h4 style="margin-top:20px; opacity:0.8;">Pergaminhos Antigos</h4>
                <div class="scroll-slots">
                    <div class="scroll-slot" onclick="game.openScrollBag(0)" id="scSlot0"></div>
                    <div class="scroll-slot" onclick="game.openScrollBag(1)" id="scSlot1"></div>
                    <div class="scroll-slot" onclick="game.openScrollBag(2)" id="scSlot2"></div>
                    <div class="scroll-slot" onclick="game.openScrollBag(3)" id="scSlot3"></div>
                </div>
                <div id="setBonus" style="text-align:center; color: #f1c40f; font-weight:bold; font-size:0.9em; display:none; padding:10px; border:1px solid #f1c40f; border-radius:8px; background:rgba(241, 196, 15, 0.1);">‚ú® SET B√îNUS ATIVO! ‚ú®</div>

                <div id="totalStats" style="font-size:0.85em; margin-top:15px; text-align:center; opacity:0.7;"></div>
                <button class="btn" style="margin-top:15px;" onclick="game.menu()">Voltar</button>
            </div>
        </div>

        <div id="scrollBagScreen" class="screen">
            <div class="box-style">
                <h3>Grim√≥rio</h3>
                <div id="scrollGrid" style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin: 15px 0;"></div>
                <button class="btn btn-danger" onclick="game.unequipScroll()">Remover Slot</button>
                <button class="btn" style="margin-top:10px; background:transparent; color:var(--text-main); border:1px solid var(--border);" onclick="game.openChar()">Cancelar</button>
            </div>
        </div>

        <div id="battleScreen" class="screen">
            <div class="box-style">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <b id="battleTitle" style="font-size:1.1em;">Batalha</b>
                    <div>
                        <button id="speedBtn" class="btn btn-small" style="display:inline-block; width:auto; background:var(--border); color:var(--text-main);" onclick="game.toggleSpeed()">1x</button> 
                        <button class="btn btn-small btn-danger" style="display:inline-block; width:auto;" onclick="game.menu()">Fugir</button>
                    </div>
                </div>
                
                <div class="battle-arena">
                    <div style="text-align:center; position:relative;">
                        <div class="bars-container" style="margin:0 auto 5px auto;">
                            <div class="bar-wrap"><div class="bar-fill hp-fill" id="pHpBar"></div></div>
                            <div class="bar-wrap" style="height:5px;"><div class="bar-fill mp-fill" id="pMpBar"></div></div>
                        </div>
                        <div class="character-avatar" id="pAv" style="border-color: #3498db;"><span>ü¶∏</span></div>
                        <div style="margin-top:5px; font-weight:bold; font-size:0.9em;">Voc√™</div>
                    </div>

                    <div style="font-size:1.5em; font-weight:900; color:var(--text-muted); opacity:0.3; margin-bottom: 30px;">VS</div>

                    <div style="text-align:center; position:relative;">
                        <div class="bars-container" style="margin:0 auto 5px auto;">
                            <div class="bar-wrap"><div class="bar-fill hp-fill" id="eHpBar"></div></div>
                        </div>
                        <div class="character-avatar" id="eAv" style="border-color: #e74c3c;"><span>üê∫</span></div>
                        <div style="margin-top:5px; font-weight:bold; font-size:0.9em;" id="eName">Inimigo</div>
                    </div>
                </div>

                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <button class="btn" style="background:var(--card-bg); border:1px solid var(--danger); color:var(--danger); padding:8px;" onclick="game.usePot('hp')">
                        üç∑ Curar (<span id="qtyHp">0</span>)
                    </button>
                    <button class="btn" style="background:var(--card-bg); border:1px solid var(--accent); color:var(--accent); padding:8px;" onclick="game.usePot('mp')">
                        üß™ Mana (<span id="qtyMp">0</span>)
                    </button>
                </div>

                <div class="attack-grid">
                    <button class="attack-btn" id="btn_normal" onclick="game.atk('normal')">‚öîÔ∏è</button>
                    <button class="attack-btn" id="btn_fire" onclick="game.atk('fire')">üî•</button>
                    <button class="attack-btn" id="btn_ice" onclick="game.atk('ice')">‚ùÑÔ∏è</button>
                    <button class="attack-btn" id="btn_thunder" onclick="game.atk('thunder')">‚ö°</button>
                    <button class="attack-btn" id="btn_special" onclick="game.atk('special')">‚ú®</button>
                    <button class="attack-btn" id="btn_ultimate" onclick="game.atk('ultimate')">‚òÑÔ∏è</button>
                </div>
            </div>
        </div>

        <div id="shopScreen" class="screen">
            <div class="box-style">
                <h3>Mercado (üí∞ <span id="sGold">0</span>)</h3>
                <div id="sGrid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px;"></div>
                <button class="btn" style="margin-top:15px;" onclick="game.menu()">Voltar</button>
            </div>
        </div>

        <div id="invScreen" class="screen">
            <div class="box-style">
                <h3>Mochila</h3>
                <div id="iGrid" style="margin-top:15px;"></div>
                <button class="btn" style="margin-top:15px;" onclick="game.menu()">Voltar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="modal-box">
            <h2 id="modTitle" style="color:var(--primary); margin-bottom:10px;">TITULO</h2>
            <div id="modBody" style="margin:20px 0; font-size:1.1em; line-height:1.5;">Texto</div>
            <button class="btn" onclick="game.closeMod()">Continuar</button>
        </div>
    </div>

    <script>
        const KEY = 'wdev_legends_clean_v1';
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        // SISTEMA DE SOM (Mantido simples e funcional)
        const soundSys = {
            playTone(freq, type, duration, vol=0.1) {
                if(audioCtx.state === 'suspended') audioCtx.resume();
                const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
                osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                gain.gain.setValueAtTime(vol, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+duration);
                osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime+duration);
            },
            playNoise(duration) {
                if(audioCtx.state === 'suspended') audioCtx.resume();
                const bs = audioCtx.sampleRate * duration; const b = audioCtx.createBuffer(1, bs, audioCtx.sampleRate); const d = b.getChannelData(0);
                for(let i=0; i<bs; i++) d[i] = Math.random()*2-1;
                const n = audioCtx.createBufferSource(); n.buffer = b; const g = audioCtx.createGain();
                g.gain.setValueAtTime(0.05, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+duration);
                n.connect(g); g.connect(audioCtx.destination); n.start();
            },
            sfx(type) {
                if(type === 'hit') this.playNoise(0.1); 
                if(type === 'fire') { this.playTone(200, 'sawtooth', 0.4); this.playNoise(0.3); }
                if(type === 'ice') this.playTone(600, 'sine', 0.5); 
                if(type === 'thunder') { this.playTone(100, 'sawtooth', 0.1); this.playNoise(0.2); } 
                if(type === 'coin') this.playTone(1000, 'sine', 0.1); 
                if(type === 'lvl') { this.playTone(400, 'triangle', 0.2); setTimeout(()=>this.playTone(600, 'triangle', 0.4), 150); }
                if(type === 'equip') this.playTone(600, 'sine', 0.05);
            }
        };

        const game = {
            db: { users: {}, cur: null },
            st: { p: {}, e: {}, turn: true, busy: false, bNum: 0, dungeonLvl: 0, isDungeon: false },
            speed: 1, tmpSlot: 0,
            
            data: {
                skills: {
                    normal: { n:'Golpe', m:1, c:0, type:'phys', sfx:'hit', req:1, icon:'‚öîÔ∏è' },
                    fire:   { n:'Chama', m:1.5, c:20, type:'fire', sfx:'fire', req:1, icon:'üî•' },
                    ice:    { n:'Gelo', m:1.7, c:30, type:'ice', sfx:'ice', req:3, icon:'‚ùÑÔ∏è' },
                    thunder:{ n:'Raio', m:2.0, c:40, type:'thunder', sfx:'thunder', req:5, icon:'‚ö°' },
                    special:{ n:'Luz', m:2.5, c:50, type:'fire', sfx:'fire', req:8, icon:'‚ú®' },
                    ultimate:{ n:'Meteoro', m:3.5, c:80, type:'fire', sfx:'fire', req:12, icon:'‚òÑÔ∏è' }
                },
                items: [
                    {id:'hp', n:'T√¥nico Vital', i:'üç∑', p:50, t:'pot'}, {id:'mp', n:'Elixir Mana', i:'üß™', p:50, t:'pot'},
                    {id:1, n:'Espada de A√ßo', i:'üó°Ô∏è', atk:5, p:100, t:'eq'}, {id:2, n:'Escudo Ferro', i:'üõ°Ô∏è', def:5, p:100, t:'eq'},
                    {id:3, n:'Cajado M√≠stico', i:'ü™Ñ', atk:10, int:5, p:400, t:'eq'}, {id:4, n:'Cota de Malha', i:'ü¶∫', def:10, hp:50, p:400, t:'eq'}
                ],
                bossDrops: [
                    {id:100, n:'Coroa do Rei', i:'üëë', atk:10, def:10, int:10, t:'eq'}, {id:101, n:'Tridente', i:'üî±', atk:25, t:'eq'},
                    {id:102, n:'Capa das Sombras', i:'üåë', def:20, hp:100, t:'eq'}, {id:103, n:'Anel Ancestral', i:'üíç', atk:15, int:15, t:'eq'}
                ],
                scrolls: [
                    {id:'sc_fire_c', n:'Perg. Fogo (C)', type:'fire', atk:5, r:'common', i:'üìú'},
                    {id:'sc_water_c', n:'Perg. √Ågua (C)', type:'water', hp:20, r:'common', i:'üìú'},
                    {id:'sc_wind_c', n:'Perg. Vento (C)', type:'wind', def:3, r:'common', i:'üìú'},
                    {id:'sc_fire_r', n:'Perg. Fogo (R)', type:'fire', atk:15, r:'rare', i:'üìú'},
                    {id:'sc_water_r', n:'Perg. √Ågua (R)', type:'water', hp:60, r:'rare', i:'üìú'},
                    {id:'sc_wind_r', n:'Perg. Vento (R)', type:'wind', def:8, r:'rare', i:'üìú'},
                    {id:'sc_fire_u', n:'Perg. Fogo (U)', type:'fire', atk:35, r:'ultra', i:'üìú'},
                    {id:'sc_water_u', n:'Perg. √Ågua (U)', type:'water', hp:150, r:'ultra', i:'üìú'},
                    {id:'sc_wind_u', n:'Perg. Vento (U)', type:'wind', def:20, r:'ultra', i:'üìú'}
                ],
                // LISTA DE EMOJIS LIMPA (Sem m√°scaras oni/dem√¥nio)
                avs: [
                    'ü¶∏','ü•∑','üßô','üßõ','üßü','üßö','üßú','üßû','ü¶π','ü§ñ',
                    'ü§†','ü§°','üëΩ','üëæ','ü¶¥','üíÇ','ü§¥','üë∏','üë≥','üë≤',
                    'üïµÔ∏è','üëÆ','üë∑','üë©‚ÄçüöÄ','üë©‚Äçüé§','ü¶Å','üêØ','üêº','üêª','üê®',
                    'üê∏','üêô','üê≤','ü¶Ñ','üê∂','üê∞','üê∫','üêó','üê¥','ü¶â'
                ],
                // INIMIGOS E CHEFES ALTERADOS
                enemies: [ {n:'Lobo Selvagem', i:'üê∫'}, {n:'Bandido', i:'üë∫'}, {n:'Esqueleto', i:'üíÄ'}, {n:'Escorpi√£o', i:'ü¶Ç'} ],
                bosses: [ {n:'Drag√£o Anci√£o', i:'üê≤'}, {n:'Lorde Sombrio', i:'üíÇ'}, {n:'Kraken', i:'ü¶ë'}, {n:'Golem de Pedra', i:'üóø'} ]
            },
            tmpAv: 'ü¶∏',

            init() {
                try { const s = localStorage.getItem(KEY); if(s) this.db = JSON.parse(s); } catch(e) {}
                this.rendAv(); this.checkTheme(); setInterval(() => this.checkTheme(), 60000);
                document.getElementById('bgm').volume = 0.1;
            },
            checkTheme() { const h = new Date().getHours(); const b = document.body; if(h>=18||h<6) {if(!b.classList.contains('night')) b.className='night';} else {if(!b.classList.contains('day')) b.className='day';} },
            toggleMusic() { const b = document.getElementById('bgm'); if(b.paused){ b.play(); document.getElementById('musicIcon').textContent='üîä';} else{ b.pause(); document.getElementById('musicIcon').textContent='üîá';} },
            startMusic() { const b = document.getElementById('bgm'); b.play().then(()=>document.getElementById('musicIcon').textContent='üîä').catch(()=>{}); },

            save() { localStorage.setItem(KEY, JSON.stringify(this.db)); },
            wait(ms) { return new Promise(r => setTimeout(r, ms * this.speed)); },
            toggleSpeed() { this.speed = this.speed === 1 ? 0.5 : 1; document.getElementById('speedBtn').textContent = this.speed===1?'1x':'2x'; },

            login() {
                const u = document.getElementById('loginUser').value.trim(); 
                const p = document.getElementById('loginPass').value.trim();
                if(!u || !p) return alert("Preencha todos os campos");

                if(!this.db.users[u]) { 
                    if(confirm('Conta nova detectada. Criar her√≥i?')) { 
                        this.db.users[u] = { pass: p, ok: false }; this.db.cur = u; this.save(); 
                        this.nav('create'); 
                    } 
                } else if(this.db.users[u].pass === p) { 
                    this.db.cur = u; this.fixData(this.db.users[u]); 
                    if(this.db.users[u].ok) { this.menu(); this.startMusic(); } else this.nav('create');
                } else alert('Senha incorreta');
            },
            logout() { this.db.cur=null; document.getElementById('bgm').pause(); this.nav('login'); },
            
            fixData(u) {
                if(!u.inv) u.inv={hp:1, mp:1}; if(!u.stats) u.stats={str:1, int:1, vit:1, pts:0};
                if(!u.bag) u.bag=[]; if(!u.equip) u.equip=[]; if(!u.dungeonMax) u.dungeonMax = 1;
                if(!u.scrollsBag) u.scrollsBag = []; if(!u.scrollsEq) u.scrollsEq = [null, null, null, null];
            },
            
            create() {
                const u = this.db.users[this.db.cur];
                const n = document.getElementById('newame').value.trim() || 'Heroi';
                u.name = n; u.av = this.tmpAv; u.lvl = 1; u.xp = 0; u.gold = 100;
                u.inv = { hp: 3, mp: 1 }; u.stats = { str: 1, int: 1, vit: 1, pts: 3 };
                u.bag = []; u.equip = []; u.dungeonMax = 1;
                u.scrollsBag = []; u.scrollsEq = [null, null, null, null];
                u.ok = true; this.save(); game.menu(); game.startMusic();
            },

            rendAv() { 
                const g=document.getElementById('gridAv'); g.innerHTML=''; 
                this.data.avs.forEach(a=>{
                    const d=document.createElement('div'); d.className='emoji-opt'; d.textContent=a;
                    d.onclick=()=>{
                        this.tmpAv=a; document.getElementById('prevAv').textContent=a;
                        document.querySelectorAll('.emoji-opt').forEach(el=>el.classList.remove('selected'));
                        d.classList.add('selected');
                    };
                    g.appendChild(d);
                }); 
            },

            nav(id) { 
                document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); 
                document.getElementById(id+'Screen').classList.add('active');
                if(id === 'dungeon') this.rendDungeons();
            },

            menu() {
                const u = this.db.users[this.db.cur];
                document.getElementById('mName').textContent = u.name;
                document.getElementById('mAv').innerHTML = u.av; // Atualiza avatar no menu
                document.getElementById('mGold').textContent = u.gold;
                document.getElementById('mLvl').textContent = u.lvl;
                const pct = Math.min(100, (u.xp / (u.lvl*100))*100);
                document.getElementById('mXp').style.width = pct + '%';
                this.nav('menu');
            },

            rendDungeons() {
                const d = document.getElementById('dungeonList'); d.innerHTML = '';
                const u = this.db.users[this.db.cur];
                for(let i=1; i<=7; i++) {
                    const locked = i > u.dungeonMax;
                    const btn = document.createElement('button');
                    btn.className = 'btn dungeon-btn'; btn.disabled = locked;
                    let drops = 'Comum'; if(i>=4) drops = 'Raro'; if(i===7) drops = 'Ultra';
                    btn.innerHTML = `<div><b>N√≠vel ${i}</b><br><small style="color:${locked?'gray':'var(--success)'}">${drops}</small></div><div style="font-size:1.5em">${locked?'üîí':'‚öîÔ∏è'}</div>`;
                    btn.onclick = () => this.battleStart('dungeon', i);
                    d.appendChild(btn);
                }
            },

            openChar() {
                const u = this.db.users[this.db.cur];
                document.getElementById('stStr').textContent = u.stats.str;
                document.getElementById('stInt').textContent = u.stats.int;
                document.getElementById('stVit').textContent = u.stats.vit;
                document.getElementById('ptsDisplay').textContent = `Pontos: ${u.stats.pts}`;
                
                u.scrollsEq.forEach((sid, idx) => {
                    const slot = document.getElementById('scSlot'+idx);
                    slot.innerHTML = ''; slot.classList.remove('filled');
                    if(sid) {
                        const sc = this.data.scrolls.find(s => s.id === sid);
                        if(sc) {
                            slot.classList.add('filled');
                            slot.innerHTML = `üìú`;
                        }
                    }
                });
                
                // Set Bonus Check
                const validScrolls = u.scrollsEq.filter(s => s !== null).map(s => this.data.scrolls.find(x=>x.id===s));
                let bonusActive = false;
                if(validScrolls.length === 4) {
                    const firstType = validScrolls[0].type;
                    if(validScrolls.every(s => s.type === firstType)) bonusActive = true;
                }
                const bonDiv = document.getElementById('setBonus');
                if(bonusActive) {
                    bonDiv.style.display = 'block';
                    const type = validScrolls[0].type;
                    let txt = type==='fire' ? "ATAQUE" : (type==='water' ? "VIDA" : "DEFESA");
                    bonDiv.textContent = `‚ú® SET ${txt} ATIVO! (+30%) ‚ú®`;
                } else {
                    bonDiv.style.display = 'none';
                }

                const s = this.calcStats();
                document.getElementById('totalStats').innerHTML = `ATK: ${s.atk} | DEF: ${s.def} | HP: ${s.hp} | MP: ${s.mp}`;
                this.nav('char');
            },

            openScrollBag(slotIdx) {
                this.tmpSlot = slotIdx;
                const d = document.getElementById('scrollGrid'); d.innerHTML = '';
                const u = this.db.users[this.db.cur];
                
                if(u.scrollsBag.length === 0) { d.innerHTML = '<p style="grid-column:span 2; text-align:center; opacity:0.6;">Vazio.</p>'; }
                [...new Set(u.scrollsBag)].forEach(sid => {
                    const sc = this.data.scrolls.find(s => s.id === sid);
                    const count = u.scrollsBag.filter(x => x === sid).length;
                    const used = u.scrollsEq.filter(x => x === sid).length;
                    if(count - used > 0) {
                        const el = document.createElement('div');
                        el.className = `item-card`;
                        el.innerHTML = `<div><b>${sc.n}</b><br><small>${sc.atk?'Atk+'+sc.atk:''}${sc.hp?'Hp+'+sc.hp:''}${sc.def?'Def+'+sc.def:''}</small></div><button class="btn btn-small btn-success" onclick="game.equipScroll('${sid}')">Usar</button>`;
                        d.appendChild(el);
                    }
                });
                this.nav('scrollBag');
            },
            equipScroll(sid) { const u=this.db.users[this.db.cur]; u.scrollsEq[this.tmpSlot]=sid; soundSys.sfx('equip'); this.save(); this.openChar(); },
            unequipScroll() { const u=this.db.users[this.db.cur]; u.scrollsEq[this.tmpSlot]=null; this.save(); this.openChar(); },

            addStat(s) {
                const u = this.db.users[this.db.cur];
                if(u.stats.pts > 0) { u.stats.pts--; u.stats[s]++; soundSys.playTone(600, 'sine', 0.1); this.save(); this.openChar(); }
            },

            calcStats() {
                const u = this.db.users[this.db.cur];
                let s = { atk:10, def:5, hp:100, mp:50, int:0 };
                s.atk += (u.stats.str * 2) + (u.lvl * 2); s.hp += (u.stats.vit * 10) + (u.lvl * 20);
                s.mp += (u.stats.int * 10) + (u.lvl * 10); s.int += u.stats.int; s.def += Math.floor(u.stats.str / 2) + u.lvl;

                u.equip.forEach(id => {
                    let it = this.data.items.find(i=>i.id==id) || this.data.bossDrops.find(i=>i.id==id);
                    if(it) { if(it.atk) s.atk+=it.atk; if(it.def) s.def+=it.def; if(it.hp) s.hp+=it.hp; if(it.int) s.mp+=(it.int*5); }
                });

                let f=0, w=0, wi=0;
                u.scrollsEq.forEach(sid => {
                    if(sid) {
                        const sc = this.data.scrolls.find(x=>x.id===sid);
                        if(sc){ if(sc.atk)s.atk+=sc.atk; if(sc.hp)s.hp+=sc.hp; if(sc.def)s.def+=sc.def; if(sc.type=='fire')f++; if(sc.type=='water')w++; if(sc.type=='wind')wi++; }
                    }
                });
                if(f===4) s.atk = Math.floor(s.atk*1.3); if(w===4) s.hp = Math.floor(s.hp*1.3); if(wi===4) s.def = Math.floor(s.def*1.3);
                return s;
            },

            battleStart(mode, lvl=1) {
                const u = this.db.users[this.db.cur];
                this.st.isDungeon = (mode === 'dungeon'); this.st.dungeonLvl = lvl; this.st.bNum++; 
                
                let mul = 1; let enData;
                if(this.st.isDungeon) {
                    mul = 1 + (lvl * 0.5);
                    enData = this.data.bosses[lvl % this.data.bosses.length]; // Usa rota√ß√£o segura
                    document.getElementById('battleTitle').innerHTML = `üè∞ N√≠vel ${lvl}`;
                } else {
                    this.st.boss--; if(this.st.boss<=0) this.st.boss=5;
                    this.st.isBoss = (this.st.boss===5); mul = this.st.isBoss ? 2.5 : 1;
                    enData = this.st.isBoss ? this.data.bosses[0] : this.data.enemies[Math.floor(Math.random()*this.data.enemies.length)];
                    document.getElementById('battleTitle').innerHTML = `Explora√ß√£o: ${this.st.bNum}`;
                }

                const finalStats = this.calcStats();
                this.st.p = { maxHp:finalStats.hp, curHp:finalStats.hp, maxMp:finalStats.mp, curMp:finalStats.mp, atk:finalStats.atk, def:finalStats.def, int:finalStats.int };
                const elvl = Math.max(1, u.lvl + (this.st.isDungeon ? lvl*2 : 0));
                
                this.st.e = {
                    name: enData.n, lvl: elvl, av: enData.i,
                    maxHp: Math.floor((100+elvl*30)*mul), curHp: Math.floor((100+elvl*30)*mul),
                    atk: Math.floor((10+elvl*2)*mul), def: Math.floor((2+elvl)*mul)
                };

                this.st.turn=true; this.st.busy=false;
                document.getElementById('pAv').innerHTML=`<span>${u.av}</span>`; document.getElementById('eAv').innerHTML=`<span>${this.st.e.av}</span>`;
                document.getElementById('eName').textContent=this.st.e.name;
                this.upd(); this.nav('battle');
            },

            upd() {
                const p=this.st.p; const e=this.st.e; const u=this.db.users[this.db.cur];
                const set=(id,c,m)=>{document.getElementById(id+'Bar').style.width=Math.max(0,(c/m)*100)+'%';};
                set('pHp',p.curHp,p.maxHp); set('pMp',p.curMp,p.maxMp); set('eHp',e.curHp,e.maxHp);
                document.getElementById('qtyHp').textContent=u.inv.hp||0; document.getElementById('qtyMp').textContent=u.inv.mp||0;
                ['normal','fire','ice','thunder','special','ultimate'].forEach(k=>{
                    const s=this.data.skills[k]; const b=document.getElementById('btn_'+k);
                    if(u.lvl<s.req){ b.disabled=true; b.innerHTML=`${s.icon}<br><span class="lock-text">Lvl ${s.req}</span>`; b.style.opacity="0.5"; }
                    else { b.innerHTML=`${s.icon}<small class="attack-cost">${s.c}</small>`; b.style.opacity="1"; b.disabled=(p.curMp<s.c); }
                });
            },

            async atk(k) {
                if(!this.st.turn||this.st.busy)return; const s=this.data.skills[k]; const p=this.st.p;
                if(p.curMp<s.c)return; this.st.busy=true; p.curMp-=s.c; soundSys.sfx(s.sfx);
                const e=this.st.e; let dmg=Math.max(1,Math.floor(((p.atk+(s.c>0?p.int*2:0))*s.m)-e.def));
                if(Math.random()<0.2) dmg=Math.floor(dmg*1.5); e.curHp-=dmg;
                if(s.type==='thunder'){document.getElementById('flashOverlay').className='flash-screen';setTimeout(()=>document.getElementById('flashOverlay').className='',300);}
                this.floatTxt('-'+dmg,'eAv'); this.upd();
                if(e.curHp<=0){await this.wait(1000); this.win();} else{await this.wait(1000); this.enemyTurn();}
            },
            async enemyTurn() {
                const p=this.st.p; const e=this.st.e; soundSys.sfx('hit');
                let dmg=Math.max(1,Math.floor(e.atk-p.def)); p.curHp-=dmg;
                document.getElementById('pAv').classList.add('shake'); setTimeout(()=>document.getElementById('pAv').classList.remove('shake'),400);
                this.floatTxt('-'+dmg,'pAv'); this.upd();
                if(p.curHp<=0){await this.wait(1000); this.lose();} else{this.st.turn=true; this.st.busy=false;}
            },
            async usePot(t) {
                const u=this.db.users[this.db.cur]; if(!u.inv[t]||u.inv[t]<=0)return;
                this.st.busy=true; u.inv[t]--; this.save(); soundSys.playTone(500,'sine',0.3);
                if(t=='hp') this.st.p.curHp=Math.min(this.st.p.maxHp,this.st.p.curHp+50); else this.st.p.curMp=Math.min(this.st.p.maxMp,this.st.p.curMp+50);
                this.upd(); await this.wait(800); this.enemyTurn();
            },

            win() {
                soundSys.sfx('lvl'); const u=this.db.users[this.db.cur];
                const xp=30+(u.lvl*5); const g=20+(u.lvl*2); u.xp+=xp; u.gold+=g;
                let msg=`<b style="color:var(--success)">Vit√≥ria!</b><br>+${xp} XP | +${g} Ouro`;

                if(this.st.isDungeon) {
                    if(this.st.dungeonLvl === u.dungeonMax && u.dungeonMax < 7) { u.dungeonMax++; msg += `<br>Nova Masmorra Desbloqueada!`; }
                    const lvl = this.st.dungeonLvl;
                    let chance = lvl <= 3 ? 0.2 : 0.5; // Aumentei um pouco a chance
                    if(Math.random() < chance) {
                        let rarityPool = lvl <= 3 ? ['common'] : ['common', 'rare', 'ultra'];
                        const r = rarityPool[Math.floor(Math.random()*rarityPool.length)];
                        const drop = this.data.scrolls.filter(s => s.r === r)[0]; // Pega o primeiro que achar pra simplificar
                        if(drop) { u.scrollsBag.push(drop.id); msg += `<br>üìú Item Encontrado!`; }
                    }
                }

                if(u.xp>=u.lvl*100){u.lvl++; u.xp=0; u.stats.pts+=3; msg+=`<br><b style="color:#f1c40f">LEVEL UP!</b>`;}
                this.save(); this.showMod('SUCESSO', msg);
            },
            lose() { this.showMod('DERROTA', 'Voc√™ precisa ficar mais forte...'); },

            shop() {
                const d=document.getElementById('sGrid'); d.innerHTML=''; const u=this.db.users[this.db.cur];
                this.data.items.forEach(it=>{
                    const h=(it.t=='eq'&&u.bag.includes(it.id));
                    d.innerHTML+=`<div class="box-style" style="text-align:center;padding:15px; border:1px solid #ccc; margin:0;"><div style="font-size:2em">${it.i}</div><b>${it.n}</b><br><small>${it.t=='pot'?'Recupera':'Atributo'}</small><br><button class="btn btn-small btn-shop" style="margin-top:5px;" onclick="game.buy('${it.id}')" ${h?'disabled':''}>${h?'Comprado':'üí∞ '+it.p}</button></div>`;
                });
                this.nav('shop');
            },
            buy(id){ const u=this.db.users[this.db.cur]; const it=this.data.items.find(i=>i.id==id); if(u.gold>=it.p){u.gold-=it.p; if(it.t=='pot')u.inv[id]=(u.inv[id]||0)+1; else u.bag.push(id); soundSys.sfx('coin'); this.save(); this.shop();} else alert('Sem ouro suficiente!'); },
            inv(){
                const d=document.getElementById('iGrid'); d.innerHTML=''; const u=this.db.users[this.db.cur];
                ['hp','mp'].forEach(k=>{if(u.inv[k]>0)d.innerHTML+=`<div class="item-card"><div style="font-size:1.5em; margin-right:10px;">${k=='hp'?'üç∑':'üß™'}</div><div style="flex:1"><b>Po√ß√£o</b></div><small>x${u.inv[k]}</small></div>`;});
                if(u.bag.length===0 && !u.inv.hp && !u.inv.mp) d.innerHTML = "<p style='text-align:center'>Mochila vazia.</p>";
                u.bag.forEach(id=>{
                    let it=this.data.items.find(i=>i.id==id)||this.data.bossDrops.find(i=>i.id==id);
                    if(it){
                        const eq=u.equip.includes(parseInt(id));
                        d.innerHTML+=`<div class="item-card ${eq?'equipped':''}"><div style="font-size:1.5em; margin-right:10px;">${it.i}</div><div style="flex:1"><b>${it.n}</b><br><small>${it.atk?'Atk+'+it.atk:''}</small></div><button class="btn btn-small ${eq?'btn-danger':'btn-success'}" onclick="game.toggleEquip('${id}')">${eq?'Soltar':'Usar'}</button></div>`;
                    }
                });
                this.nav('inv');
            },
            toggleEquip(id){ const u=this.db.users[this.db.cur]; const idx=u.equip.indexOf(parseInt(id)); if(idx>-1)u.equip.splice(idx,1); else {u.equip.push(parseInt(id)); soundSys.sfx('equip');} this.save(); this.inv(); },
            floatTxt(t,id){const p=document.getElementById(id);const r=p.getBoundingClientRect();const d=document.createElement('div');d.className='float-text';d.textContent=t;d.style.left=(r.left+20)+'px';d.style.top=r.top+'px';document.body.appendChild(d);setTimeout(()=>d.remove(),1000);},
            showMod(t,b){document.getElementById('modTitle').innerHTML=t;document.getElementById('modBody').innerHTML=b;document.getElementById('modal').style.display='flex';},
            closeMod(){document.getElementById('modal').style.display='none';if(this.st.p.curHp>0 && this.st.isDungeon && document.getElementById('modTitle').innerHTML.includes('SUCESSO')) this.menu(); else if(this.st.p.curHp>0) this.battleStart('normal'); else this.menu();}
        };
        window.onload=()=>game.init();
    </script>
</body>
</html>
